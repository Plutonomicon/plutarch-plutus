<!DOCTYPE HTML>
<html lang="en" class="light" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>PLiftable</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('light')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../Overview.html"><strong aria-hidden="true">1.</strong> Overview</a></li><li class="chapter-item expanded "><a href="../Introduction.html"><strong aria-hidden="true">2.</strong> Introduction</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../Introduction/DelayAndForce.html"><strong aria-hidden="true">2.1.</strong> Delay and Force</a></li><li class="chapter-item expanded "><a href="../Introduction/PatternMatching.html"><strong aria-hidden="true">2.2.</strong> Pattern Matching</a></li><li class="chapter-item expanded "><a href="../Introduction/PlutarchTerms.html"><strong aria-hidden="true">2.3.</strong> Plutarch Terms</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../Introduction/PlutarchTerms/PlutarchConstants.html"><strong aria-hidden="true">2.3.1.</strong> Plutarch Constants</a></li><li class="chapter-item expanded "><a href="../Introduction/PlutarchTerms/PlutarchLambdas.html"><strong aria-hidden="true">2.3.2.</strong> Plutarch Lambdas</a></li></ol></li><li class="chapter-item expanded "><a href="../Introduction/PlutarchTypes.html"><strong aria-hidden="true">2.4.</strong> Plutarch Types</a></li><li class="chapter-item expanded "><a href="../Introduction/UntypedPlutusCore.html"><strong aria-hidden="true">2.5.</strong> Untyped PlutusCore</a></li><li class="chapter-item expanded "><a href="../DEVGUIDE.html"><strong aria-hidden="true">2.6.</strong> Dev Guide</a></li><li class="chapter-item expanded "><a href="../Run.html"><strong aria-hidden="true">2.7.</strong> Run</a></li><li class="chapter-item expanded "><a href="../Troubleshooting.html"><strong aria-hidden="true">2.8.</strong> Troubleshooting</a></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">3.</strong> Examples</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="../examples/BASIC.html"><strong aria-hidden="true">3.1.</strong> Basic</a></li><li class="chapter-item expanded "><a href="../examples/VALIDATOR.html"><strong aria-hidden="true">3.2.</strong> Validator</a></li></ol></li><li class="chapter-item expanded "><a href="../Concepts.html"><strong aria-hidden="true">4.</strong> Concepts</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../Concepts/DataAndScottEncoding.html"><strong aria-hidden="true">4.1.</strong> Data and Scott Encoding</a></li><li class="chapter-item expanded "><a href="../Concepts/GenericProgramming.html"><strong aria-hidden="true">4.2.</strong> Generic Programming</a></li><li class="chapter-item expanded "><a href="../Concepts/HaskellSynonym.html"><strong aria-hidden="true">4.3.</strong> Haskell Synonym</a></li><li class="chapter-item expanded "><a href="../Concepts/Hoisting.html"><strong aria-hidden="true">4.4.</strong> Hoisting</a></li><li class="chapter-item expanded "><a href="../Concepts/WhatIsTheS.html"><strong aria-hidden="true">4.5.</strong> What is the s?</a></li></ol></li><li class="chapter-item expanded "><a href="../Types.html"><strong aria-hidden="true">5.</strong> Types</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../Types/PAsData.html"><strong aria-hidden="true">5.1.</strong> PAsData</a></li><li class="chapter-item expanded "><a href="../Types/PBool.html"><strong aria-hidden="true">5.2.</strong> PBool</a></li><li class="chapter-item expanded "><a href="../Types/PBuiltinList.html"><strong aria-hidden="true">5.3.</strong> PBuiltinList</a></li><li class="chapter-item expanded "><a href="../Types/PBuiltinPair.html"><strong aria-hidden="true">5.4.</strong> PBuiltinPair</a></li><li class="chapter-item expanded "><a href="../Types/PByteString.html"><strong aria-hidden="true">5.5.</strong> PByteString</a></li><li class="chapter-item expanded "><a href="../Types/PData.html"><strong aria-hidden="true">5.6.</strong> PData</a></li><li class="chapter-item expanded "><a href="../Types/PDataSumAndPDataRecord.html"><strong aria-hidden="true">5.7.</strong> PDataSum and PDataRecord</a></li><li class="chapter-item expanded "><a href="../Types/PInteger.html"><strong aria-hidden="true">5.8.</strong> PInteger</a></li><li class="chapter-item expanded "><a href="../Types/PList.html"><strong aria-hidden="true">5.9.</strong> PList</a></li><li class="chapter-item expanded "><a href="../Types/PString.html"><strong aria-hidden="true">5.10.</strong> PString</a></li><li class="chapter-item expanded "><a href="../Types/PUnit.html"><strong aria-hidden="true">5.11.</strong> PUnit</a></li></ol></li><li class="chapter-item expanded "><a href="../Typeclasses.html"><strong aria-hidden="true">6.</strong> Typeclasses</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../Typeclasses/PLiftable.html" class="active"><strong aria-hidden="true">6.1.</strong> PLiftable</a></li><li class="chapter-item expanded "><a href="../Typeclasses/PEqAndPOrd.html"><strong aria-hidden="true">6.2.</strong> PEq and POrd</a></li><li class="chapter-item expanded "><a href="../Typeclasses/PIntegral.html"><strong aria-hidden="true">6.3.</strong> PIntegral</a></li><li class="chapter-item expanded "><a href="../Typeclasses/PIsData.html"><strong aria-hidden="true">6.4.</strong> PIsData</a></li><li class="chapter-item expanded "><a href="../Typeclasses/PIsDataReprAndPDataFields.html"><strong aria-hidden="true">6.5.</strong> PIsDataRepr and PDataFields</a></li><li class="chapter-item expanded "><a href="../Typeclasses/PListLike.html"><strong aria-hidden="true">6.6.</strong> PListLike</a></li><li class="chapter-item expanded "><a href="../Typeclasses/PlutusType,PCon,PMatch.html"><strong aria-hidden="true">6.7.</strong> PlutusType, PCon, and PMatch</a></li><li class="chapter-item expanded "><a href="../Typeclasses/PTryFrom.html"><strong aria-hidden="true">6.8.</strong> PTryFrom</a></li></ol></li><li class="chapter-item expanded "><a href="../Usage.html"><strong aria-hidden="true">7.</strong> Usage</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../Usage/AvoidWorkDuplicationUsingPlet.html"><strong aria-hidden="true">7.1.</strong> Avoid Work Duplication Using plet</a></li><li class="chapter-item expanded "><a href="../Usage/Conditionals.html"><strong aria-hidden="true">7.2.</strong> Conditionals</a></li><li class="chapter-item expanded "><a href="../Usage/DerivingForNewtypes.html"><strong aria-hidden="true">7.3.</strong> Deriving for Newtypes</a></li><li class="chapter-item expanded "><a href="../Usage/DerivingWithGenerics.html"><strong aria-hidden="true">7.4.</strong> Deriving with Generics</a></li><li class="chapter-item expanded "><a href="../Usage/DoSyntaxWithQualifiedDo.html"><strong aria-hidden="true">7.5.</strong> DoSyntax with QualifiedDo</a></li><li class="chapter-item expanded "><a href="../Usage/DoSyntaxWithTermCont.html"><strong aria-hidden="true">7.6.</strong> DoSyntax with TermCont</a></li><li class="chapter-item expanded "><a href="../Usage/RaisingErrors.html"><strong aria-hidden="true">7.7.</strong> Raising Errors</a></li><li class="chapter-item expanded "><a href="../Usage/Recursion.html"><strong aria-hidden="true">7.8.</strong> Recursion</a></li><li class="chapter-item expanded "><a href="../Usage/Tracing.html"><strong aria-hidden="true">7.9.</strong> Tracing</a></li><li class="chapter-item expanded "><a href="../Usage/UnsafeFunctions.html"><strong aria-hidden="true">7.10.</strong> Unsafe Functions</a></li></ol></li><li class="chapter-item expanded "><a href="../Tricks.html"><strong aria-hidden="true">8.</strong> Tricks</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../Tricks/DifferenceBetweenPconAndPconstant.html"><strong aria-hidden="true">8.1.</strong> Difference between pcon and pconstant</a></li><li class="chapter-item expanded "><a href="../Tricks/DontDuplicateWork.html"><strong aria-hidden="true">8.2.</strong> Don't Duplicate Work</a></li><li class="chapter-item expanded "><a href="../Tricks/makeIsDataIndexed,HaskellADTs,PIsDataRepr.html"><strong aria-hidden="true">8.3.</strong> makeIsDataIndexed, HaskellADTs, and PIsDataRepr</a></li><li class="chapter-item expanded "><a href="../Tricks/OptimizingUnhoistableLambdas.html"><strong aria-hidden="true">8.4.</strong> Optimizing Unhoistable Lambdas</a></li><li class="chapter-item expanded "><a href="../Tricks/PlutarchFunctionsStrict.html"><strong aria-hidden="true">8.5.</strong> Plutarch Functions Strict</a></li><li class="chapter-item expanded "><a href="../Tricks/PreferMatchingOnPmatchResultImmediately.html"><strong aria-hidden="true">8.6.</strong> Prefer Matching on pmatch Result Immediately</a></li><li class="chapter-item expanded "><a href="../Tricks/PreferPlutarchFunctions.html"><strong aria-hidden="true">8.7.</strong> Prefer Plutarch Functions</a></li><li class="chapter-item expanded "><a href="../Tricks/PreferStaticallyBuildingConstants.html"><strong aria-hidden="true">8.8.</strong> Prefer Statically Building Constants</a></li><li class="chapter-item expanded "><a href="../Tricks/RepresentationOfPlutarchType.html"><strong aria-hidden="true">8.9.</strong> Representation of Plutarch Type</a></li><li class="chapter-item expanded "><a href="../Tricks/ResponsibilityOfEvaluationInHaskellFunctions.html"><strong aria-hidden="true">8.10.</strong> Responsibility of Evaluation in Haskell Functions</a></li><li class="chapter-item expanded "><a href="../Tricks/UsingHaskellLevelFunctions.html"><strong aria-hidden="true">8.11.</strong> Using Haskell Level Functions</a></li><li class="chapter-item expanded "><a href="../Tricks/WorkingWithBoundFields.html"><strong aria-hidden="true">8.12.</strong> Working with Bound Fields</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title"></h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="pliftable"><a class="header" href="#pliftable"><code>PLiftable</code></a></h1>
<h2 id="prerequisites"><a class="header" href="#prerequisites">Prerequisites</a></h2>
<p>You should be familiar with <code>PlutusType</code> and what it does, as well as how to
make instances of it. Furthermore, understanding how associated types and
<code>via</code>-deriving works is required. Lastly, familiarity with higher-rank arguments
is helpful, but not essential.</p>
<h2 id="introduction"><a class="header" href="#introduction">Introduction</a></h2>
<p>A <code>PlutusType</code> instance specifies two capabilities:</p>
<ul>
<li>Constructing a value by way of <code>pcon</code>; and</li>
<li>Matching on a value by way of <code>pmatch</code></li>
</ul>
<p>This is enough as long as we remain entirely in the Plutarch universe. However,
we often need to interact with Plutus stuff more
directly, and deal with equivalents to the types built-in to the Plutus default
universe (<code>Integer</code>, for example), as well as types that operate via a <code>Data</code>
encoding (such as most ledger stuff). We need to be able to create a 'bridge'
between the world that Plutus understands (Haskell, essentially) and Plutarch.</p>
<p><code>PLiftable</code> is designed to act as that bridge. If a type is an instance of
<code>PLiftable</code>, we have the following:</p>
<ul>
<li>A Haskell-level equivalent of this type</li>
<li>A way of transforming a value of the Haskell-level equivalent into a Plutarch
term</li>
<li>A way of transforming a closed Plutarch term into a Haskell-level equivalent
value (with the possibility of erroring)</li>
</ul>
<h2 id="the-type-class"><a class="header" href="#the-type-class">The type class</a></h2>
<p><code>PLiftable</code> is defined as follows:</p>
<pre><code class="language-haskell">class PlutusType a =&gt; PLiftable (a :: S -&gt; Type) where
    type AsHaskell a :: Type
    type PlutusRepr a :: Type
    toPlutarch :: forall (s :: S) . AsHaskell a -&gt; PLifted a s
    toPlutarchRepr :: AsHaskell a -&gt; PlutusRepr a
    fromPlutarch :: (forall (s :: S) . PLifted a s) -&gt; Either LiftError (AsHaskell a)
    fromPlutarchRepr :: PlutusRepr a -&gt; Maybe (AsHaskell a)
</code></pre>
<p>Even though we rarely need to interact with <code>PLiftable</code> and its methods
directly, it is worth understanding what exactly this type class requires from
its instances.</p>
<p>Firstly, we define an associated type <code>AsHaskell</code>, which determines the 'Haskell
equivalent' of the Plutarch type <code>a</code>. We can see which is which by looking at
the kinds involved: <code>a</code> has the kind <code>S -&gt; Type</code> (meaning, 'Plutarch type'),
while <code>AsHaskell a</code> has the kind <code>Type</code> (meaning, 'Haskell type'). We also note
that any type with a <code>PLiftable</code> instance must also have a <code>PlutusType</code>
instance; this is not surprising, as we need some way of operating on whatever
we bring into Plutarch.</p>
<p>In general, <code>AsHaskell a</code> must either be a type directly in the Plutus default
universe, or else a type which has a <code>Data</code> encoding. Nearly every case you are
likely to see, or define, will be one of these two. As a result, we provide two
helpers to derive such instances with less effort (further description of these
will come later).</p>
<p>We also define two methods: one for moving from the 'Haskell world' into the
'Plutarch world', and another for the opposite direction. We note that the
direction specified by <code>toPlutarch</code> is unconditional (cannot fail), whereas the
direction specified by <code>fromPlutarch</code> is conditional (can fail). This is because
a Plutarch term may represent a computation (valid or not), and to determine its
Haskell-equivalent value, we must compile and evaluate the term, which could
fail.</p>
<p>To fully grasp how these methods work, we need to examine two more types: the
<code>PLifted</code> wrapper, and the <code>LiftError</code> type:</p>
<pre><code class="language-haskell">newtype PLifted (a :: S -&gt; Type) (s :: S) = PLifted (Term s POpaque)

data LiftError
  = CouldNotEvaluate EvalError
  | TypeError BuiltinError
  | CouldNotCompile Text
  | CouldNotDecodeData
</code></pre>
<p><code>PLifted a s</code> is an implementation detail needed to drive <code>via</code>-derivation.
Whenever you see it, mentally substitute it for <code>Term s a</code>. Unless you plan to
write <code>PLiftable</code> instances by hand, you will never need to interact with this
type directly, or know anything about the distinction between <code>PLifted a s</code> and
<code>Term s a</code>. <code>LiftError</code> on the other hand designates all the ways in which
transforming a closed Plutarch term into its Haskell-level equivalent can fail:</p>
<ul>
<li>The term does not compile</li>
<li>The evaluation of the term errors instead of giving a value</li>
<li>We attempt to transform into a type not part of the Plutus default universe</li>
<li>We evaluate to an invalid <code>Data</code> encoding</li>
</ul>
<p>Once again, you almost never have to interact with this type directly unless
manually specifying an instance of this type class. The main advantage of having
a 'structured error type' here is debugging.</p>
<h2 id="defining-an-instance"><a class="header" href="#defining-an-instance">Defining an instance</a></h2>
<p>Aside from the manual method, we provide two <code>via</code>-deriving helpers, for the two
most common cases. We explain how to use each of them below. In almost all
situations, one of the two <code>via</code>-deriving helpers is what you want to use.</p>
<h3 id="via-derivebuiltinpliftable"><a class="header" href="#via-derivebuiltinpliftable">Via <code>DeriveBuiltinPLiftable</code></a></h3>
<p>This helper is designed for types which have direct representations in Haskell
using a type that's part of the default Plutus universe. An example of such a
type is <code>PInteger</code>: <code>Term s PInteger</code> is meant to represent computations that
result in an <code>Integer</code> (or an error), and <code>Integer</code>s are part of the Plutus
default universe. Indeed, if you attempt to use this helper with a Haskell type
that <em>isn't</em> part of the default Plutus universe, you will get a compile error.</p>
<p>The type is defined as follows: its implementation is not important.</p>
<pre><code class="language-haskell">newtype DeriveBuiltinPLiftable (a :: S -&gt; Type) (h :: Type) (s :: S)
  = DeriveBuiltinPLiftable (a s)
</code></pre>
<p>We can see that this <code>newtype</code> has two type arguments (besides the <code>s</code> to make
it a Plutarch type): one for the Plutarch type for which we want to derive the
instance, and one for a Haskell type that is meant to be its <code>AsHaskell</code>
equivalent. As an example of how to use this helper, consider the following:</p>
<pre><code class="language-haskell">deriving via (DeriveBuiltinPLiftable PInteger Integer) 
    instance PLiftable PInteger
</code></pre>
<p>This specifies that <code>PInteger</code>'s Haskell-level equivalent is <code>Integer</code> by way of
its presence in the default Plutarch universe.</p>
<h3 id="via-derivedatapliftable"><a class="header" href="#via-derivedatapliftable">Via <code>DeriveDataPLiftable</code></a></h3>
<p>This helper is designed for types which are represented onchain by way of their
<code>Data</code> encoding, rather than being part of the Plutus universe directly. An
example of such a type is <code>PScriptContext</code>: its equivalent in Haskell is
<code>ScriptContext</code> from <code>plutus-ledger-api</code>, which is essentially a 'skin' over
<code>Data</code>.</p>
<p>This type is defined as follows: its implementation is not important.</p>
<pre><code class="language-haskell">newtype DeriveDataPLiftable (a :: S -&gt; Type) (h :: Type) (s :: S)
  = DeriveDataPLiftable (a s)
</code></pre>
<p>Similarly to <code>DeriveBuiltinPLiftable</code>, we have two relevant type arguments:
one for the Plutarch type for which we want to derive an instance, and
another for its Haskell-level equivalent. As an example of how to use this
helper, consider the following:</p>
<pre><code class="language-haskell">deriving via (DeriveDataPLiftable PScriptContext ScriptContext) 
    instance PLiftable PScriptContext
</code></pre>
<p>This declares that <code>PScriptContext</code>'s Haskell-level equivalent is
<code>ScriptContext</code> (from <code>plutus-ledger-api</code>), by way of its <code>Data</code> encoding.</p>
<p>There are additional requirements for using this helper with Plutarch type <code>a</code>
and Haskell-level equivalent <code>h</code>. Aside from <code>a</code> being an instance of
<code>PlutusType</code>, we also must have the following:</p>
<ul>
<li><code>PInner a</code> is <code>PData</code> (namely, construction and matching is actually carried
out in a computation involving <code>Data</code>)</li>
<li><code>h</code> is an instance of both <code>ToData</code> and <code>FromData</code> (namely, it has a <code>Data</code>
encoding that we can decode from and encode into)</li>
</ul>
<h3 id="via-derivenewtypepliftable"><a class="header" href="#via-derivenewtypepliftable">Via <code>DeriveNewtypePLiftable</code></a></h3>
<p>This helper is for types that have the same representation as some other
type that already defined <code>PLiftable</code>. Instance defined that way will have
the same <code>PlutusRepr</code>.</p>
<pre><code class="language-haskell">newtype PPositive s = PPositive (Term s PInteger)
  deriving stock (Generic)
  deriving anyclass (PlutusType, PIsData)

deriving via
  DeriveNewtypePLiftable PPositive PInteger Positive
  instance PLiftable PPositive
</code></pre>
<p>This defines that <code>PPositive</code>'s Haskell-level equivalent is <code>Positive</code> and <code>PPositive</code> has the same representation as <code>PInteger</code>.</p>
<p>Implementation is not important but is useful to talk about its type parameters</p>
<pre><code class="language-haskell">newtype DeriveNewtypePLiftable (wrapper :: S -&gt; Type) (inner :: S -&gt; Type) (h :: Type) (s :: S)
  = DeriveNewtypePLiftable (wrapper s)
</code></pre>
<p>To use <code>DeriveNewtypePLiftable</code> the following must hold:</p>
<ul>
<li><code>inner</code> has <code>PLiftable</code> instance</li>
<li><code>AsHaskell inner</code> is coercible to <code>h</code></li>
</ul>
<h3 id="manual-derivation"><a class="header" href="#manual-derivation">Manual derivation</a></h3>
<p>In the (unlikely) case that your type fits neither of the above, you will have
to write the instance manually. Given how unusual this situation is, we can't
really give any general guidance as to how this should be done. Instead, we
recommend examining the definitions of <code>PLiftable</code>, as well as the two
derivation helpers described above, in the source code. Alternatively, reach out
to us: we might be able to advise better.</p>
<h3 id="ensuring-your-instance-is-correct"><a class="header" href="#ensuring-your-instance-is-correct">Ensuring your instance is correct</a></h3>
<p>Any instance of <code>PLiftable</code> must obey the following laws:</p>
<pre><code>1. fromPlutarch . toPlutarch = Right
2. fmap toPlutarch . fromPlutarch = Right
</code></pre>
<p>If you use either of <code>DeriveBuiltinPLiftable</code> or <code>DeriveDataPLiftable</code> with
<code>via</code> derivation, these laws will automatically be satisfied. If you write an
instance manually, you will have to ensure this yourself. We provide a helper
for testing that these laws hold in <code>plutarch-testlib</code>, in the
<code>Plutarch.Test.Laws</code> module, called <code>checkPLiftableLaws</code>, which uses QuickCheck
to verify that the laws are maintained. For example, to check that the instances
for <code>PLiftable PInteger</code> and <code>PLiftable PScriptContext</code> are correct, we would
write:</p>
<pre><code class="language-haskell">main :: IO ()
main = defaultMain . testGroup "Laws" $ [
    checkPLiftableLaws @PInteger,
    checkPLiftableLaws @PScriptContext
    ]
</code></pre>
<p><code>checkPLiftableLaws</code> requires the use of a type argument, as it is otherwise
ambiguous. It also works largely by way of <code>AsHaskell</code>, which means that the
Haskell-level equivalent of the type being tested must be an instance of
<code>Arbitrary</code>, <code>Eq</code> and <code>Show</code>, as well as <code>Pretty</code>. The name of the type being
tested will automatically be added to the output of the test suite.</p>
<p>One important caveat to any definition of <code>PLiftable</code> instances, manual or not:
ensure that the Haskell-level equivalent that you declare is genuine. While
there is nothing stopping you from defining something like <code>PLiftable PNatural</code>
with <code>AsHaskell PNatural = Text</code>, this is clearly not sensible, and we cannot
check this. Your intent is taken at its word: the only checks are that what you
want is not literally impossible. Keep this in mind when defining your
instances.</p>
<h2 id="using-an-instance"><a class="header" href="#using-an-instance">Using an instance</a></h2>
<p>To simplify the use of <code>PLiftable</code>, we provide two functions:</p>
<pre><code class="language-haskell">pconstant :: forall (a :: S -&gt; Type) (s :: S) .
    PLiftable a =&gt;
    AsHaskell a -&gt; 
    Term s a

plift :: forall (a :: S -&gt; Type) .
    PLiftable a =&gt; 
    (forall (s :: S) . Term s a) -&gt; 
    AsHaskell a
</code></pre>
<p>The type signatures more-or-less speak for themselves: <code>pconstant</code> is the
Haskell-to-Plutarch direction, while <code>plift</code> is the Plutarch-to-Haskell
direction. There are three minor caveats to their use:</p>
<ul>
<li><code>pconstant</code> is technically ambiguous, as many different Plutarch types can
share the same choice for <code>AsHaskell</code>. A good example is that <code>PAsData PInteger</code> and <code>PInteger</code> would have the same <code>AsHaskell</code> (namely, <code>Integer</code>).
Thus, you may need to use a type argument to avoid ambiguity errors from the
compiler.</li>
<li><code>plift</code> transforms any <code>LiftError</code> into a call to <code>error</code>.</li>
<li><code>plift</code> requires a rank-2 argument for the Plutarch term (to ensure it's
closed). This can occasionally confuse the compiler's inference when combined
with <code>.</code> or similar operators: consider either manually bracketing, or using
<code>ImpredicativeTypes</code>.</li>
</ul>
<p>These functions are the main interface enabled by <code>PLiftable</code> that you should
use in your own code. <code>plift</code> is something that should be used fairly rarely
outside of testing, however: as it requires compilation and evaluation, it will
never be efficient.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../Typeclasses.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../Typeclasses/PEqAndPOrd.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../Typeclasses.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../Typeclasses/PEqAndPOrd.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
