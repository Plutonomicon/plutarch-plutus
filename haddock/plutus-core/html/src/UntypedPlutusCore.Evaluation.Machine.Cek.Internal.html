<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span id="local-6989586621681865799"><span id="local-6989586621681865800"></span></span><span class="hs-comment">-- editorconfig-checker-disable-file</span><span>
</span><span id="line-2"></span><span class="annot"><span class="hs-comment">-- | The CEK machine.</span></span><span>
</span><span id="line-3"></span><span>
</span><span id="line-4"></span><span class="hs-pragma">{-# LANGUAGE BangPatterns             #-}</span><span>
</span><span id="line-5"></span><span class="hs-pragma">{-# LANGUAGE ConstraintKinds          #-}</span><span>
</span><span id="line-6"></span><span class="hs-pragma">{-# LANGUAGE DataKinds                #-}</span><span>
</span><span id="line-7"></span><span class="hs-pragma">{-# LANGUAGE DeriveAnyClass           #-}</span><span>
</span><span id="line-8"></span><span class="hs-pragma">{-# LANGUAGE FlexibleInstances        #-}</span><span>
</span><span id="line-9"></span><span class="hs-pragma">{-# LANGUAGE ImplicitParams           #-}</span><span>
</span><span id="line-10"></span><span class="hs-pragma">{-# LANGUAGE LambdaCase               #-}</span><span>
</span><span id="line-11"></span><span class="hs-pragma">{-# LANGUAGE MultiParamTypeClasses    #-}</span><span>
</span><span id="line-12"></span><span class="hs-pragma">{-# LANGUAGE NPlusKPatterns           #-}</span><span>
</span><span id="line-13"></span><span class="hs-pragma">{-# LANGUAGE NamedFieldPuns           #-}</span><span>
</span><span id="line-14"></span><span class="hs-pragma">{-# LANGUAGE OverloadedStrings        #-}</span><span>
</span><span id="line-15"></span><span class="hs-pragma">{-# LANGUAGE RankNTypes               #-}</span><span>
</span><span id="line-16"></span><span class="hs-pragma">{-# LANGUAGE ScopedTypeVariables      #-}</span><span>
</span><span id="line-17"></span><span class="hs-pragma">{-# LANGUAGE StandaloneKindSignatures #-}</span><span>
</span><span id="line-18"></span><span class="hs-pragma">{-# LANGUAGE TypeApplications         #-}</span><span>
</span><span id="line-19"></span><span class="hs-pragma">{-# LANGUAGE TypeFamilies             #-}</span><span>
</span><span id="line-20"></span><span class="hs-pragma">{-# LANGUAGE TypeOperators            #-}</span><span>
</span><span id="line-21"></span><span class="hs-pragma">{-# LANGUAGE UnboxedTuples            #-}</span><span>
</span><span id="line-22"></span><span class="hs-pragma">{-# LANGUAGE UndecidableInstances     #-}</span><span>
</span><span id="line-23"></span><span>
</span><span id="line-24"></span><span class="hs-pragma">{-# OPTIONS_GHC -fno-warn-orphans #-}</span><span>
</span><span id="line-25"></span><span>
</span><span id="line-26"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">UntypedPlutusCore.Evaluation.Machine.Cek.Internal</span><span>
</span><span id="line-27"></span><span>    </span><span class="hs-comment">-- See Note [Compilation peculiarities].</span><span>
</span><span id="line-28"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="PlutusCore.Evaluation.Result.html#EvaluationResult"><span class="hs-identifier">EvaluationResult</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-29"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#CekValue"><span class="hs-identifier">CekValue</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-30"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#ArgStack"><span class="hs-identifier">ArgStack</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-31"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#transferArgStack"><span class="hs-identifier">transferArgStack</span></a></span><span>
</span><span id="line-32"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#CekUserError"><span class="hs-identifier">CekUserError</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-33"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#CekEvaluationException"><span class="hs-identifier">CekEvaluationException</span></a></span><span>
</span><span id="line-34"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#CekBudgetSpender"><span class="hs-identifier">CekBudgetSpender</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-35"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#ExBudgetInfo"><span class="hs-identifier">ExBudgetInfo</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-36"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#ExBudgetMode"><span class="hs-identifier">ExBudgetMode</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-37"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#CekEmitter"><span class="hs-identifier">CekEmitter</span></a></span><span>
</span><span id="line-38"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#CekEmitterInfo"><span class="hs-identifier">CekEmitterInfo</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-39"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#EmitterMode"><span class="hs-identifier">EmitterMode</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-40"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#CekM"><span class="hs-identifier">CekM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-41"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PlutusCore.Evaluation.ErrorWithCause.html#ErrorWithCause"><span class="hs-identifier">ErrorWithCause</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-42"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PlutusCore.Evaluation.Error.html#EvaluationError"><span class="hs-identifier">EvaluationError</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-43"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#ExBudgetCategory"><span class="hs-identifier">ExBudgetCategory</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-44"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#StepKind"><span class="hs-identifier">StepKind</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-45"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PlutusCore.Pretty.PrettyConst.html#ThrowableBuiltins"><span class="hs-identifier">ThrowableBuiltins</span></a></span><span>
</span><span id="line-46"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PlutusCore.Evaluation.Machine.Exception.html#splitStructuralOperational"><span class="hs-identifier">splitStructuralOperational</span></a></span><span>
</span><span id="line-47"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PlutusCore.Evaluation.Machine.Exception.html#unsafeSplitStructuralOperational"><span class="hs-identifier">unsafeSplitStructuralOperational</span></a></span><span>
</span><span id="line-48"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#runCekDeBruijn"><span class="hs-identifier">runCekDeBruijn</span></a></span><span>
</span><span id="line-49"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#dischargeCekValue"><span class="hs-identifier">dischargeCekValue</span></a></span><span>
</span><span id="line-50"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#Context"><span class="hs-identifier">Context</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-51"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#CekValEnv"><span class="hs-identifier">CekValEnv</span></a></span><span>
</span><span id="line-52"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#GivenCekReqs"><span class="hs-identifier">GivenCekReqs</span></a></span><span>
</span><span id="line-53"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#GivenCekSpender"><span class="hs-identifier">GivenCekSpender</span></a></span><span>
</span><span id="line-54"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.StepCounter.html#StepCounter"><span class="hs-identifier">StepCounter</span></a></span><span>
</span><span id="line-55"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#NumberOfStepCounters"><span class="hs-identifier">NumberOfStepCounters</span></a></span><span>
</span><span id="line-56"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#CounterSize"><span class="hs-identifier">CounterSize</span></a></span><span>
</span><span id="line-57"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#TotalCountIndex"><span class="hs-identifier">TotalCountIndex</span></a></span><span>
</span><span id="line-58"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#Slippage"><span class="hs-identifier">Slippage</span></a></span><span>
</span><span id="line-59"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#defaultSlippage"><span class="hs-identifier">defaultSlippage</span></a></span><span>
</span><span id="line-60"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#NTerm"><span class="hs-identifier">NTerm</span></a></span><span>
</span><span id="line-61"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#runCekM"><span class="hs-identifier">runCekM</span></a></span><span>
</span><span id="line-62"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-63"></span><span class="hs-keyword">where</span><span>
</span><span id="line-64"></span><span>
</span><span id="line-65"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="PlutusPrelude.html"><span class="hs-identifier">PlutusPrelude</span></a></span><span>
</span><span id="line-66"></span><span>
</span><span id="line-67"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="UntypedPlutusCore.Core.html"><span class="hs-identifier">UntypedPlutusCore.Core</span></a></span><span>
</span><span id="line-68"></span><span>
</span><span id="line-69"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.RandomAccessList.Class</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Env</span></span><span>
</span><span id="line-70"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.RandomAccessList.SkewBinary</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Env</span></span><span>
</span><span id="line-71"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="PlutusCore.Builtin.html"><span class="hs-identifier">PlutusCore.Builtin</span></a></span><span>
</span><span id="line-72"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="PlutusCore.DeBruijn.html"><span class="hs-identifier">PlutusCore.DeBruijn</span></a></span><span>
</span><span id="line-73"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="PlutusCore.Evaluation.Machine.ExBudget.html"><span class="hs-identifier">PlutusCore.Evaluation.Machine.ExBudget</span></a></span><span>
</span><span id="line-74"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="PlutusCore.Evaluation.Machine.ExBudgetStream.html"><span class="hs-identifier">PlutusCore.Evaluation.Machine.ExBudgetStream</span></a></span><span>
</span><span id="line-75"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="PlutusCore.Evaluation.Machine.Exception.html"><span class="hs-identifier">PlutusCore.Evaluation.Machine.Exception</span></a></span><span>
</span><span id="line-76"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="PlutusCore.Evaluation.Machine.ExMemoryUsage.html"><span class="hs-identifier">PlutusCore.Evaluation.Machine.ExMemoryUsage</span></a></span><span>
</span><span id="line-77"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="PlutusCore.Evaluation.Machine.MachineParameters.html"><span class="hs-identifier">PlutusCore.Evaluation.Machine.MachineParameters</span></a></span><span>
</span><span id="line-78"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="PlutusCore.Evaluation.Result.html"><span class="hs-identifier">PlutusCore.Evaluation.Result</span></a></span><span>
</span><span id="line-79"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="PlutusCore.Pretty.html"><span class="hs-identifier">PlutusCore.Pretty</span></a></span><span>
</span><span id="line-80"></span><span>
</span><span id="line-81"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.CekMachineCosts.html"><span class="hs-identifier">UntypedPlutusCore.Evaluation.Machine.Cek.CekMachineCosts</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.CekMachineCosts.html#CekMachineCosts"><span class="hs-identifier">CekMachineCosts</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-82"></span><span>                                                                 </span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.CekMachineCosts.html#CekMachineCostsBase"><span class="hs-identifier">CekMachineCostsBase</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-83"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.StepCounter.html"><span class="hs-identifier">UntypedPlutusCore.Evaluation.Machine.Cek.StepCounter</span></a></span><span>
</span><span id="line-84"></span><span>
</span><span id="line-85"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Lens.Review</span></span><span>
</span><span id="line-86"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../ghc-9.6.6/html/libraries/base-4.18.2.1/src/Control.Monad.html"><span class="hs-identifier">Control.Monad</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../ghc-9.6.6/html/libraries/base-4.18.2.1/src/Control.Monad.html#unless"><span class="hs-identifier">unless</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#when"><span class="hs-identifier">when</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-87"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../ghc-9.6.6/html/libraries/exceptions-0.10.7/src/Control.Monad.Catch.html"><span class="hs-identifier">Control.Monad.Catch</span></a></span><span>
</span><span id="line-88"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../ghc-9.6.6/html/libraries/mtl-2.3.1/src/Control.Monad.Except.html"><span class="hs-identifier">Control.Monad.Except</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../ghc-9.6.6/html/libraries/mtl-2.3.1/src/Control.Monad.Error.Class.html#MonadError"><span class="hs-identifier">MonadError</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../ghc-9.6.6/html/libraries/mtl-2.3.1/src/Control.Monad.Error.Class.html#catchError"><span class="hs-identifier">catchError</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../ghc-9.6.6/html/libraries/mtl-2.3.1/src/Control.Monad.Error.Class.html#throwError"><span class="hs-identifier">throwError</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-89"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.Primitive</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">PrimMonad</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-90"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../ghc-9.6.6/html/libraries/base-4.18.2.1/src/Control.Monad.ST.html"><span class="hs-identifier">Control.Monad.ST</span></a></span><span>
</span><span id="line-91"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../ghc-9.6.6/html/libraries/base-4.18.2.1/src/Control.Monad.ST.Unsafe.html"><span class="hs-identifier">Control.Monad.ST.Unsafe</span></a></span><span>
</span><span id="line-92"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.DList</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">DList</span></span><span>
</span><span id="line-93"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.Functor.Identity.html"><span class="hs-identifier">Data.Functor.Identity</span></a></span><span>
</span><span id="line-94"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Hashable</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Hashable</span></span><span class="hs-special">)</span><span>
</span><span id="line-95"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.Kind.html"><span class="hs-identifier">Data.Kind</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">GHC</span></span><span>
</span><span id="line-96"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.Proxy.html"><span class="hs-identifier">Data.Proxy</span></a></span><span>
</span><span id="line-97"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.Semigroup.html"><span class="hs-identifier">Data.Semigroup</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#stimes"><span class="hs-identifier">stimes</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-98"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../ghc-9.6.6/html/libraries/text-2.0.2/src/Data.Text.html"><span class="hs-identifier">Data.Text</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../ghc-9.6.6/html/libraries/text-2.0.2/src/Data.Text.Internal.html#Text"><span class="hs-identifier">Text</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-99"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Vector</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">V</span></span><span>
</span><span id="line-100"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.Word.html"><span class="hs-identifier">Data.Word</span></a></span><span>
</span><span id="line-101"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Generics.html"><span class="hs-identifier">GHC.Generics</span></a></span><span>
</span><span id="line-102"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.TypeLits.html"><span class="hs-identifier">GHC.TypeLits</span></a></span><span>
</span><span id="line-103"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Prettyprinter</span></span><span>
</span><span id="line-104"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Universe.html"><span class="hs-identifier">Universe</span></a></span><span>
</span><span id="line-105"></span><span>
</span><span id="line-106"></span><span class="hs-comment">{- Note [Compilation peculiarities]
READ THIS BEFORE TOUCHING ANYTHING IN THIS FILE

Don't use @StrictData@, it makes the machine slower by several percent.

Exporting the 'computeCek' function from this module causes the CEK machine to become slower by
up to 25%. I repeat: just adding 'computeCek' to the export list makes the evaluator substantially
slower. The reason for this is that with 'computeCek' exported the generated GHC Core is much worse:
it contains more lambdas, allocates more stuff etc. While perhaps surprising, this is not an
unusual behavior of the compiler as https://wiki.haskell.org/Performance/GHC explains:

&gt; Indeed, generally speaking GHC will inline across modules just as much as it does within modules,
&gt; with a single large exception. If GHC sees that a function 'f' is called just once, it inlines it
&gt; regardless of how big 'f' is. But once 'f' is exported, GHC can never see that it's called exactly
&gt; once, even if that later turns out to be the case. This inline-once optimisation is pretty
&gt; important in practice.
&gt;
&gt; So: if you care about performance, do not export functions that are not used outside the module
&gt; (i.e. use an explicit export list, and keep it as small as possible).

Now clearly 'computeCek' cannot be inlined in 'runCek' whether it's exported or not, since
'computeCek' is recursive. However:

1. GHC is _usually_ smart enough to perform the worker/wrapper transformation and inline the wrapper
   (however experiments have shown that sticking the internals of the CEK machine, budgeting modes
   and the API into the same file prevents GHC from performing the worker/wrapper transformation for
   some reason likely related to &quot;we've been compiling this for too long, let's leave it at that&quot;
2. GHC seems to be able to massage the definition of 'computeCek' into something more performant
   making use of knowing exactly how 'computeCek' is used, essentially tailoring the definition of
   'computeCek' for a particular invocation in 'runCek'

Hence we don't export 'computeCek' and instead define 'runCek' in this file and export it, even
though the rest of the user-facing API (which 'runCek' is a part of) is defined downstream.

Another problem is handling mutual recursion in the 'computeCek'/'returnCek'/'forceEvaluate'/etc
family. If we keep these functions at the top level, GHC won't be able to pull the constraints out
of the family (confirmed by inspecting Core: GHC thinks that since the superclass constraints
populating the dictionary representing the @Ix fun@ constraint are redundant, they can be replaced
with calls to 'error' in a recursive call, but that changes the dictionary and so it can no longer
be pulled out of recursion). But that entails passing a redundant argument around, which slows down
the machine a tiny little bit.

Hence we define a all happy-path functions having CEK-machine-specific constraints as local
functions making use of a shared context from their parent function. This also allows GHC to inline
almost all of the machine into a single definition (with a bunch of recursive join points in it).

In general, it's advised to run benchmarks (and look at Core output if the results are suspicious)
on any changes in this file.

Finally, it's important to put bang patterns on any 'Int' arguments to ensure that GHC unboxes them:
this can make a surprisingly large difference.
-}</span><span>
</span><span id="line-158"></span><span>
</span><span id="line-159"></span><span class="hs-comment">-- | The 'Term's that CEK can execute must have DeBruijn binders</span><span>
</span><span id="line-160"></span><span class="hs-comment">-- 'Name' is not necessary but we leave it here for simplicity and debuggability.</span><span>
</span><span id="line-161"></span><span class="hs-keyword">type</span><span> </span><span id="NTerm"><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#NTerm"><span class="hs-identifier hs-var">NTerm</span></a></span></span><span> </span><span id="local-6989586621681865820"><span class="annot"><a href="#local-6989586621681865820"><span class="hs-identifier hs-type">uni</span></a></span></span><span> </span><span id="local-6989586621681865821"><span class="annot"><a href="#local-6989586621681865821"><span class="hs-identifier hs-type">fun</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="UntypedPlutusCore.Core.Type.html#Term"><span class="hs-identifier hs-type">Term</span></a></span><span> </span><span class="annot"><a href="PlutusCore.DeBruijn.Internal.html#NamedDeBruijn"><span class="hs-identifier hs-type">NamedDeBruijn</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865820"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865821"><span class="hs-identifier hs-type">fun</span></a></span><span>
</span><span id="line-162"></span><span>
</span><span id="line-163"></span><span class="hs-keyword">data</span><span> </span><span id="StepKind"><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#StepKind"><span class="hs-identifier hs-var">StepKind</span></a></span></span><span>
</span><span id="line-164"></span><span>    </span><span class="hs-glyph">=</span><span> </span><span id="BConst"><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#BConst"><span class="hs-identifier hs-var">BConst</span></a></span></span><span>
</span><span id="line-165"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span id="BVar"><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#BVar"><span class="hs-identifier hs-var">BVar</span></a></span></span><span>
</span><span id="line-166"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span id="BLamAbs"><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#BLamAbs"><span class="hs-identifier hs-var">BLamAbs</span></a></span></span><span>
</span><span id="line-167"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span id="BApply"><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#BApply"><span class="hs-identifier hs-var">BApply</span></a></span></span><span>
</span><span id="line-168"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span id="BDelay"><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#BDelay"><span class="hs-identifier hs-var">BDelay</span></a></span></span><span>
</span><span id="line-169"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span id="BForce"><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#BForce"><span class="hs-identifier hs-var">BForce</span></a></span></span><span>
</span><span id="line-170"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span id="BBuiltin"><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#BBuiltin"><span class="hs-identifier hs-var">BBuiltin</span></a></span></span><span> </span><span class="hs-comment">-- Cost of evaluating a Builtin AST node, not the function itself</span><span>
</span><span id="line-171"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span id="BConstr"><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#BConstr"><span class="hs-identifier hs-var">BConstr</span></a></span></span><span>
</span><span id="line-172"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span id="BCase"><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#BCase"><span class="hs-identifier hs-var">BCase</span></a></span></span><span>
</span><span id="line-173"></span><span>    </span><span class="hs-keyword">deriving</span><span> </span><span class="annot"><span class="hs-keyword">stock</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621681865832"><span id="local-6989586621681865834"><span id="local-6989586621681865838"><span class="annot"><span class="annottext">Int -&gt; StepKind -&gt; ShowS
[StepKind] -&gt; ShowS
StepKind -&gt; String
(Int -&gt; StepKind -&gt; ShowS)
-&gt; (StepKind -&gt; String) -&gt; ([StepKind] -&gt; ShowS) -&gt; Show StepKind
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
$cshowsPrec :: Int -&gt; StepKind -&gt; ShowS
showsPrec :: Int -&gt; StepKind -&gt; ShowS
$cshow :: StepKind -&gt; String
show :: StepKind -&gt; String
$cshowList :: [StepKind] -&gt; ShowS
showList :: [StepKind] -&gt; ShowS
</span><a href="../../../ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Show.html#Show"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></a></span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681865842"><span id="local-6989586621681865844"><span class="annot"><span class="annottext">StepKind -&gt; StepKind -&gt; Bool
(StepKind -&gt; StepKind -&gt; Bool)
-&gt; (StepKind -&gt; StepKind -&gt; Bool) -&gt; Eq StepKind
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
$c== :: StepKind -&gt; StepKind -&gt; Bool
== :: StepKind -&gt; StepKind -&gt; Bool
$c/= :: StepKind -&gt; StepKind -&gt; Bool
/= :: StepKind -&gt; StepKind -&gt; Bool
</span><a href="../../../ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#Eq"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></a></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681865851"><span id="local-6989586621681865853"><span id="local-6989586621681865855"><span id="local-6989586621681865859"><span id="local-6989586621681865862"><span id="local-6989586621681865865"><span id="local-6989586621681865868"><span class="annot"><span class="annottext">Eq StepKind
Eq StepKind =&gt;
(StepKind -&gt; StepKind -&gt; Ordering)
-&gt; (StepKind -&gt; StepKind -&gt; Bool)
-&gt; (StepKind -&gt; StepKind -&gt; Bool)
-&gt; (StepKind -&gt; StepKind -&gt; Bool)
-&gt; (StepKind -&gt; StepKind -&gt; Bool)
-&gt; (StepKind -&gt; StepKind -&gt; StepKind)
-&gt; (StepKind -&gt; StepKind -&gt; StepKind)
-&gt; Ord StepKind
StepKind -&gt; StepKind -&gt; Bool
StepKind -&gt; StepKind -&gt; Ordering
StepKind -&gt; StepKind -&gt; StepKind
forall a.
Eq a =&gt;
(a -&gt; a -&gt; Ordering)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; a)
-&gt; (a -&gt; a -&gt; a)
-&gt; Ord a
$ccompare :: StepKind -&gt; StepKind -&gt; Ordering
compare :: StepKind -&gt; StepKind -&gt; Ordering
$c&lt; :: StepKind -&gt; StepKind -&gt; Bool
&lt; :: StepKind -&gt; StepKind -&gt; Bool
$c&lt;= :: StepKind -&gt; StepKind -&gt; Bool
&lt;= :: StepKind -&gt; StepKind -&gt; Bool
$c&gt; :: StepKind -&gt; StepKind -&gt; Bool
&gt; :: StepKind -&gt; StepKind -&gt; Bool
$c&gt;= :: StepKind -&gt; StepKind -&gt; Bool
&gt;= :: StepKind -&gt; StepKind -&gt; Bool
$cmax :: StepKind -&gt; StepKind -&gt; StepKind
max :: StepKind -&gt; StepKind -&gt; StepKind
$cmin :: StepKind -&gt; StepKind -&gt; StepKind
min :: StepKind -&gt; StepKind -&gt; StepKind
</span><a href="../../../ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#Ord"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Ord</span></a></span></span></span></span></span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681865872"><span id="local-6989586621681865874"><span class="annot"><span class="annottext">(forall x. StepKind -&gt; Rep StepKind x)
-&gt; (forall x. Rep StepKind x -&gt; StepKind) -&gt; Generic StepKind
forall x. Rep StepKind x -&gt; StepKind
forall x. StepKind -&gt; Rep StepKind x
forall a.
(forall x. a -&gt; Rep a x) -&gt; (forall x. Rep a x -&gt; a) -&gt; Generic a
$cfrom :: forall x. StepKind -&gt; Rep StepKind x
from :: forall x. StepKind -&gt; Rep StepKind x
$cto :: forall x. Rep StepKind x -&gt; StepKind
to :: forall x. Rep StepKind x -&gt; StepKind
</span><a href="../../../ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Generics.html#Generic"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Generic</span></a></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681865878"><span id="local-6989586621681865886"><span id="local-6989586621681865892"><span id="local-6989586621681865906"><span id="local-6989586621681865908"><span id="local-6989586621681865912"><span id="local-6989586621681865916"><span id="local-6989586621681865920"><span class="annot"><span class="annottext">Int -&gt; StepKind
StepKind -&gt; Int
StepKind -&gt; [StepKind]
StepKind -&gt; StepKind
StepKind -&gt; StepKind -&gt; [StepKind]
StepKind -&gt; StepKind -&gt; StepKind -&gt; [StepKind]
(StepKind -&gt; StepKind)
-&gt; (StepKind -&gt; StepKind)
-&gt; (Int -&gt; StepKind)
-&gt; (StepKind -&gt; Int)
-&gt; (StepKind -&gt; [StepKind])
-&gt; (StepKind -&gt; StepKind -&gt; [StepKind])
-&gt; (StepKind -&gt; StepKind -&gt; [StepKind])
-&gt; (StepKind -&gt; StepKind -&gt; StepKind -&gt; [StepKind])
-&gt; Enum StepKind
forall a.
(a -&gt; a)
-&gt; (a -&gt; a)
-&gt; (Int -&gt; a)
-&gt; (a -&gt; Int)
-&gt; (a -&gt; [a])
-&gt; (a -&gt; a -&gt; [a])
-&gt; (a -&gt; a -&gt; [a])
-&gt; (a -&gt; a -&gt; a -&gt; [a])
-&gt; Enum a
$csucc :: StepKind -&gt; StepKind
succ :: StepKind -&gt; StepKind
$cpred :: StepKind -&gt; StepKind
pred :: StepKind -&gt; StepKind
$ctoEnum :: Int -&gt; StepKind
toEnum :: Int -&gt; StepKind
$cfromEnum :: StepKind -&gt; Int
fromEnum :: StepKind -&gt; Int
$cenumFrom :: StepKind -&gt; [StepKind]
enumFrom :: StepKind -&gt; [StepKind]
$cenumFromThen :: StepKind -&gt; StepKind -&gt; [StepKind]
enumFromThen :: StepKind -&gt; StepKind -&gt; [StepKind]
$cenumFromTo :: StepKind -&gt; StepKind -&gt; [StepKind]
enumFromTo :: StepKind -&gt; StepKind -&gt; [StepKind]
$cenumFromThenTo :: StepKind -&gt; StepKind -&gt; StepKind -&gt; [StepKind]
enumFromThenTo :: StepKind -&gt; StepKind -&gt; StepKind -&gt; [StepKind]
</span><a href="../../../ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Enum.html#Enum"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Enum</span></a></span></span></span></span></span></span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681865924"><span id="local-6989586621681865926"><span class="annot"><span class="annottext">StepKind
StepKind -&gt; StepKind -&gt; Bounded StepKind
forall a. a -&gt; a -&gt; Bounded a
$cminBound :: StepKind
minBound :: StepKind
$cmaxBound :: StepKind
maxBound :: StepKind
</span><a href="../../../ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Enum.html#Bounded"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Bounded</span></a></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-174"></span><span>    </span><span class="hs-keyword">deriving</span><span> </span><span class="annot"><span class="hs-keyword">anyclass</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621681865930"><span class="annot"><span class="annottext">StepKind -&gt; ()
(StepKind -&gt; ()) -&gt; NFData StepKind
forall a. (a -&gt; ()) -&gt; NFData a
$crnf :: StepKind -&gt; ()
rnf :: StepKind -&gt; ()
</span><a href="../../../ghc-9.6.6/html/libraries/deepseq-1.4.8.1/src/Control.DeepSeq.html#NFData"><span class="hs-identifier hs-var hs-var hs-var hs-var">NFData</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681865961"><span id="local-6989586621681865968"><span class="annot"><span class="annottext">Eq StepKind
Eq StepKind =&gt;
(Int -&gt; StepKind -&gt; Int) -&gt; (StepKind -&gt; Int) -&gt; Hashable StepKind
Int -&gt; StepKind -&gt; Int
StepKind -&gt; Int
forall a. Eq a =&gt; (Int -&gt; a -&gt; Int) -&gt; (a -&gt; Int) -&gt; Hashable a
$chashWithSalt :: Int -&gt; StepKind -&gt; Int
hashWithSalt :: Int -&gt; StepKind -&gt; Int
$chash :: StepKind -&gt; Int
hash :: StepKind -&gt; Int
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Hashable</span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-175"></span><span>
</span><span id="line-176"></span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#cekStepCost"><span class="hs-identifier hs-type">cekStepCost</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.CekMachineCosts.html#CekMachineCosts"><span class="hs-identifier hs-type">CekMachineCosts</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#StepKind"><span class="hs-identifier hs-type">StepKind</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="PlutusCore.Evaluation.Machine.ExBudget.html#ExBudget"><span class="hs-identifier hs-type">ExBudget</span></a></span><span>
</span><span id="line-177"></span><span id="cekStepCost"><span class="annot"><span class="annottext">cekStepCost :: CekMachineCosts -&gt; StepKind -&gt; ExBudget
</span><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#cekStepCost"><span class="hs-identifier hs-var hs-var">cekStepCost</span></a></span></span><span> </span><span id="local-6989586621681865995"><span class="annot"><span class="annottext">CekMachineCosts
</span><a href="#local-6989586621681865995"><span class="hs-identifier hs-var">costs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Identity ExBudget -&gt; ExBudget
forall a. Identity a -&gt; a
</span><a href="../../../ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.Functor.Identity.html#runIdentity"><span class="hs-identifier hs-var">runIdentity</span></a></span><span> </span><span class="annot"><span class="annottext">(Identity ExBudget -&gt; ExBudget)
-&gt; (StepKind -&gt; Identity ExBudget) -&gt; StepKind -&gt; ExBudget
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-178"></span><span>    </span><span class="annot"><span class="annottext">StepKind
</span><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#BConst"><span class="hs-identifier hs-var">BConst</span></a></span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">CekMachineCosts -&gt; Identity ExBudget
forall (f :: * -&gt; *). CekMachineCostsBase f -&gt; f ExBudget
</span><a href="UntypedPlutusCore.Evaluation.Machine.Cek.CekMachineCosts.html#cekConstCost"><span class="hs-identifier hs-var">cekConstCost</span></a></span><span> </span><span class="annot"><span class="annottext">CekMachineCosts
</span><a href="#local-6989586621681865995"><span class="hs-identifier hs-var">costs</span></a></span><span>
</span><span id="line-179"></span><span>    </span><span class="annot"><span class="annottext">StepKind
</span><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#BVar"><span class="hs-identifier hs-var">BVar</span></a></span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">CekMachineCosts -&gt; Identity ExBudget
forall (f :: * -&gt; *). CekMachineCostsBase f -&gt; f ExBudget
</span><a href="UntypedPlutusCore.Evaluation.Machine.Cek.CekMachineCosts.html#cekVarCost"><span class="hs-identifier hs-var">cekVarCost</span></a></span><span> </span><span class="annot"><span class="annottext">CekMachineCosts
</span><a href="#local-6989586621681865995"><span class="hs-identifier hs-var">costs</span></a></span><span>
</span><span id="line-180"></span><span>    </span><span class="annot"><span class="annottext">StepKind
</span><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#BLamAbs"><span class="hs-identifier hs-var">BLamAbs</span></a></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">CekMachineCosts -&gt; Identity ExBudget
forall (f :: * -&gt; *). CekMachineCostsBase f -&gt; f ExBudget
</span><a href="UntypedPlutusCore.Evaluation.Machine.Cek.CekMachineCosts.html#cekLamCost"><span class="hs-identifier hs-var">cekLamCost</span></a></span><span> </span><span class="annot"><span class="annottext">CekMachineCosts
</span><a href="#local-6989586621681865995"><span class="hs-identifier hs-var">costs</span></a></span><span>
</span><span id="line-181"></span><span>    </span><span class="annot"><span class="annottext">StepKind
</span><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#BApply"><span class="hs-identifier hs-var">BApply</span></a></span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">CekMachineCosts -&gt; Identity ExBudget
forall (f :: * -&gt; *). CekMachineCostsBase f -&gt; f ExBudget
</span><a href="UntypedPlutusCore.Evaluation.Machine.Cek.CekMachineCosts.html#cekApplyCost"><span class="hs-identifier hs-var">cekApplyCost</span></a></span><span> </span><span class="annot"><span class="annottext">CekMachineCosts
</span><a href="#local-6989586621681865995"><span class="hs-identifier hs-var">costs</span></a></span><span>
</span><span id="line-182"></span><span>    </span><span class="annot"><span class="annottext">StepKind
</span><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#BDelay"><span class="hs-identifier hs-var">BDelay</span></a></span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">CekMachineCosts -&gt; Identity ExBudget
forall (f :: * -&gt; *). CekMachineCostsBase f -&gt; f ExBudget
</span><a href="UntypedPlutusCore.Evaluation.Machine.Cek.CekMachineCosts.html#cekDelayCost"><span class="hs-identifier hs-var">cekDelayCost</span></a></span><span> </span><span class="annot"><span class="annottext">CekMachineCosts
</span><a href="#local-6989586621681865995"><span class="hs-identifier hs-var">costs</span></a></span><span>
</span><span id="line-183"></span><span>    </span><span class="annot"><span class="annottext">StepKind
</span><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#BForce"><span class="hs-identifier hs-var">BForce</span></a></span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">CekMachineCosts -&gt; Identity ExBudget
forall (f :: * -&gt; *). CekMachineCostsBase f -&gt; f ExBudget
</span><a href="UntypedPlutusCore.Evaluation.Machine.Cek.CekMachineCosts.html#cekForceCost"><span class="hs-identifier hs-var">cekForceCost</span></a></span><span> </span><span class="annot"><span class="annottext">CekMachineCosts
</span><a href="#local-6989586621681865995"><span class="hs-identifier hs-var">costs</span></a></span><span>
</span><span id="line-184"></span><span>    </span><span class="annot"><span class="annottext">StepKind
</span><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#BBuiltin"><span class="hs-identifier hs-var">BBuiltin</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">CekMachineCosts -&gt; Identity ExBudget
forall (f :: * -&gt; *). CekMachineCostsBase f -&gt; f ExBudget
</span><a href="UntypedPlutusCore.Evaluation.Machine.Cek.CekMachineCosts.html#cekBuiltinCost"><span class="hs-identifier hs-var">cekBuiltinCost</span></a></span><span> </span><span class="annot"><span class="annottext">CekMachineCosts
</span><a href="#local-6989586621681865995"><span class="hs-identifier hs-var">costs</span></a></span><span>
</span><span id="line-185"></span><span>    </span><span class="annot"><span class="annottext">StepKind
</span><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#BConstr"><span class="hs-identifier hs-var">BConstr</span></a></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">CekMachineCosts -&gt; Identity ExBudget
forall (f :: * -&gt; *). CekMachineCostsBase f -&gt; f ExBudget
</span><a href="UntypedPlutusCore.Evaluation.Machine.Cek.CekMachineCosts.html#cekConstrCost"><span class="hs-identifier hs-var">cekConstrCost</span></a></span><span> </span><span class="annot"><span class="annottext">CekMachineCosts
</span><a href="#local-6989586621681865995"><span class="hs-identifier hs-var">costs</span></a></span><span>
</span><span id="line-186"></span><span>    </span><span class="annot"><span class="annottext">StepKind
</span><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#BCase"><span class="hs-identifier hs-var">BCase</span></a></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">CekMachineCosts -&gt; Identity ExBudget
forall (f :: * -&gt; *). CekMachineCostsBase f -&gt; f ExBudget
</span><a href="UntypedPlutusCore.Evaluation.Machine.Cek.CekMachineCosts.html#cekCaseCost"><span class="hs-identifier hs-var">cekCaseCost</span></a></span><span> </span><span class="annot"><span class="annottext">CekMachineCosts
</span><a href="#local-6989586621681865995"><span class="hs-identifier hs-var">costs</span></a></span><span>
</span><span id="line-187"></span><span>
</span><span id="line-188"></span><span class="hs-keyword">data</span><span> </span><span id="ExBudgetCategory"><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#ExBudgetCategory"><span class="hs-identifier hs-var">ExBudgetCategory</span></a></span></span><span> </span><span id="local-6989586621681865774"><span class="annot"><a href="#local-6989586621681865774"><span class="hs-identifier hs-type">fun</span></a></span></span><span>
</span><span id="line-189"></span><span>    </span><span class="hs-glyph">=</span><span> </span><span id="BStep"><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#BStep"><span class="hs-identifier hs-var">BStep</span></a></span></span><span> </span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#StepKind"><span class="hs-identifier hs-type">StepKind</span></a></span><span>
</span><span id="line-190"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span id="BBuiltinApp"><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#BBuiltinApp"><span class="hs-identifier hs-var">BBuiltinApp</span></a></span></span><span> </span><span class="annot"><a href="#local-6989586621681865774"><span class="hs-identifier hs-type">fun</span></a></span><span>  </span><span class="hs-comment">-- Cost of evaluating a fully applied builtin function</span><span>
</span><span id="line-191"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span id="BStartup"><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#BStartup"><span class="hs-identifier hs-var">BStartup</span></a></span></span><span>
</span><span id="line-192"></span><span>    </span><span class="hs-keyword">deriving</span><span> </span><span class="annot"><span class="hs-keyword">stock</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621681866012"><span id="local-6989586621681866018"><span id="local-6989586621681866022"><span class="annot"><span class="annottext">Int -&gt; ExBudgetCategory fun -&gt; ShowS
[ExBudgetCategory fun] -&gt; ShowS
ExBudgetCategory fun -&gt; String
(Int -&gt; ExBudgetCategory fun -&gt; ShowS)
-&gt; (ExBudgetCategory fun -&gt; String)
-&gt; ([ExBudgetCategory fun] -&gt; ShowS)
-&gt; Show (ExBudgetCategory fun)
forall fun. Show fun =&gt; Int -&gt; ExBudgetCategory fun -&gt; ShowS
forall fun. Show fun =&gt; [ExBudgetCategory fun] -&gt; ShowS
forall fun. Show fun =&gt; ExBudgetCategory fun -&gt; String
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
$cshowsPrec :: forall fun. Show fun =&gt; Int -&gt; ExBudgetCategory fun -&gt; ShowS
showsPrec :: Int -&gt; ExBudgetCategory fun -&gt; ShowS
$cshow :: forall fun. Show fun =&gt; ExBudgetCategory fun -&gt; String
show :: ExBudgetCategory fun -&gt; String
$cshowList :: forall fun. Show fun =&gt; [ExBudgetCategory fun] -&gt; ShowS
showList :: [ExBudgetCategory fun] -&gt; ShowS
</span><a href="../../../ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Show.html#Show"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></a></span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681866026"><span id="local-6989586621681866030"><span class="annot"><span class="annottext">ExBudgetCategory fun -&gt; ExBudgetCategory fun -&gt; Bool
(ExBudgetCategory fun -&gt; ExBudgetCategory fun -&gt; Bool)
-&gt; (ExBudgetCategory fun -&gt; ExBudgetCategory fun -&gt; Bool)
-&gt; Eq (ExBudgetCategory fun)
forall fun.
Eq fun =&gt;
ExBudgetCategory fun -&gt; ExBudgetCategory fun -&gt; Bool
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
$c== :: forall fun.
Eq fun =&gt;
ExBudgetCategory fun -&gt; ExBudgetCategory fun -&gt; Bool
== :: ExBudgetCategory fun -&gt; ExBudgetCategory fun -&gt; Bool
$c/= :: forall fun.
Eq fun =&gt;
ExBudgetCategory fun -&gt; ExBudgetCategory fun -&gt; Bool
/= :: ExBudgetCategory fun -&gt; ExBudgetCategory fun -&gt; Bool
</span><a href="../../../ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#Eq"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></a></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681866038"><span id="local-6989586621681866042"><span id="local-6989586621681866046"><span id="local-6989586621681866050"><span id="local-6989586621681866053"><span id="local-6989586621681866056"><span id="local-6989586621681866059"><span class="annot"><span class="annottext">Eq (ExBudgetCategory fun)
Eq (ExBudgetCategory fun) =&gt;
(ExBudgetCategory fun -&gt; ExBudgetCategory fun -&gt; Ordering)
-&gt; (ExBudgetCategory fun -&gt; ExBudgetCategory fun -&gt; Bool)
-&gt; (ExBudgetCategory fun -&gt; ExBudgetCategory fun -&gt; Bool)
-&gt; (ExBudgetCategory fun -&gt; ExBudgetCategory fun -&gt; Bool)
-&gt; (ExBudgetCategory fun -&gt; ExBudgetCategory fun -&gt; Bool)
-&gt; (ExBudgetCategory fun
    -&gt; ExBudgetCategory fun -&gt; ExBudgetCategory fun)
-&gt; (ExBudgetCategory fun
    -&gt; ExBudgetCategory fun -&gt; ExBudgetCategory fun)
-&gt; Ord (ExBudgetCategory fun)
ExBudgetCategory fun -&gt; ExBudgetCategory fun -&gt; Bool
ExBudgetCategory fun -&gt; ExBudgetCategory fun -&gt; Ordering
ExBudgetCategory fun
-&gt; ExBudgetCategory fun -&gt; ExBudgetCategory fun
forall a.
Eq a =&gt;
(a -&gt; a -&gt; Ordering)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; a)
-&gt; (a -&gt; a -&gt; a)
-&gt; Ord a
forall fun. Ord fun =&gt; Eq (ExBudgetCategory fun)
forall fun.
Ord fun =&gt;
ExBudgetCategory fun -&gt; ExBudgetCategory fun -&gt; Bool
forall fun.
Ord fun =&gt;
ExBudgetCategory fun -&gt; ExBudgetCategory fun -&gt; Ordering
forall fun.
Ord fun =&gt;
ExBudgetCategory fun
-&gt; ExBudgetCategory fun -&gt; ExBudgetCategory fun
$ccompare :: forall fun.
Ord fun =&gt;
ExBudgetCategory fun -&gt; ExBudgetCategory fun -&gt; Ordering
compare :: ExBudgetCategory fun -&gt; ExBudgetCategory fun -&gt; Ordering
$c&lt; :: forall fun.
Ord fun =&gt;
ExBudgetCategory fun -&gt; ExBudgetCategory fun -&gt; Bool
&lt; :: ExBudgetCategory fun -&gt; ExBudgetCategory fun -&gt; Bool
$c&lt;= :: forall fun.
Ord fun =&gt;
ExBudgetCategory fun -&gt; ExBudgetCategory fun -&gt; Bool
&lt;= :: ExBudgetCategory fun -&gt; ExBudgetCategory fun -&gt; Bool
$c&gt; :: forall fun.
Ord fun =&gt;
ExBudgetCategory fun -&gt; ExBudgetCategory fun -&gt; Bool
&gt; :: ExBudgetCategory fun -&gt; ExBudgetCategory fun -&gt; Bool
$c&gt;= :: forall fun.
Ord fun =&gt;
ExBudgetCategory fun -&gt; ExBudgetCategory fun -&gt; Bool
&gt;= :: ExBudgetCategory fun -&gt; ExBudgetCategory fun -&gt; Bool
$cmax :: forall fun.
Ord fun =&gt;
ExBudgetCategory fun
-&gt; ExBudgetCategory fun -&gt; ExBudgetCategory fun
max :: ExBudgetCategory fun
-&gt; ExBudgetCategory fun -&gt; ExBudgetCategory fun
$cmin :: forall fun.
Ord fun =&gt;
ExBudgetCategory fun
-&gt; ExBudgetCategory fun -&gt; ExBudgetCategory fun
min :: ExBudgetCategory fun
-&gt; ExBudgetCategory fun -&gt; ExBudgetCategory fun
</span><a href="../../../ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#Ord"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Ord</span></a></span></span></span></span></span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681866063"><span id="local-6989586621681866065"><span class="annot"><span class="annottext">(forall x. ExBudgetCategory fun -&gt; Rep (ExBudgetCategory fun) x)
-&gt; (forall x. Rep (ExBudgetCategory fun) x -&gt; ExBudgetCategory fun)
-&gt; Generic (ExBudgetCategory fun)
forall x. Rep (ExBudgetCategory fun) x -&gt; ExBudgetCategory fun
forall x. ExBudgetCategory fun -&gt; Rep (ExBudgetCategory fun) x
forall a.
(forall x. a -&gt; Rep a x) -&gt; (forall x. Rep a x -&gt; a) -&gt; Generic a
forall fun x. Rep (ExBudgetCategory fun) x -&gt; ExBudgetCategory fun
forall fun x. ExBudgetCategory fun -&gt; Rep (ExBudgetCategory fun) x
$cfrom :: forall fun x. ExBudgetCategory fun -&gt; Rep (ExBudgetCategory fun) x
from :: forall x. ExBudgetCategory fun -&gt; Rep (ExBudgetCategory fun) x
$cto :: forall fun x. Rep (ExBudgetCategory fun) x -&gt; ExBudgetCategory fun
to :: forall x. Rep (ExBudgetCategory fun) x -&gt; ExBudgetCategory fun
</span><a href="../../../ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Generics.html#Generic"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Generic</span></a></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-193"></span><span>    </span><span class="hs-keyword">deriving</span><span> </span><span class="annot"><span class="hs-keyword">anyclass</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621681866069"><span class="annot"><span class="annottext">ExBudgetCategory fun -&gt; ()
(ExBudgetCategory fun -&gt; ()) -&gt; NFData (ExBudgetCategory fun)
forall fun. NFData fun =&gt; ExBudgetCategory fun -&gt; ()
forall a. (a -&gt; ()) -&gt; NFData a
$crnf :: forall fun. NFData fun =&gt; ExBudgetCategory fun -&gt; ()
rnf :: ExBudgetCategory fun -&gt; ()
</span><a href="../../../ghc-9.6.6/html/libraries/deepseq-1.4.8.1/src/Control.DeepSeq.html#NFData"><span class="hs-identifier hs-var hs-var hs-var hs-var">NFData</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681866092"><span id="local-6989586621681866099"><span class="annot"><span class="annottext">Eq (ExBudgetCategory fun)
Eq (ExBudgetCategory fun) =&gt;
(Int -&gt; ExBudgetCategory fun -&gt; Int)
-&gt; (ExBudgetCategory fun -&gt; Int) -&gt; Hashable (ExBudgetCategory fun)
Int -&gt; ExBudgetCategory fun -&gt; Int
ExBudgetCategory fun -&gt; Int
forall a. Eq a =&gt; (Int -&gt; a -&gt; Int) -&gt; (a -&gt; Int) -&gt; Hashable a
forall fun. Hashable fun =&gt; Eq (ExBudgetCategory fun)
forall fun. Hashable fun =&gt; Int -&gt; ExBudgetCategory fun -&gt; Int
forall fun. Hashable fun =&gt; ExBudgetCategory fun -&gt; Int
$chashWithSalt :: forall fun. Hashable fun =&gt; Int -&gt; ExBudgetCategory fun -&gt; Int
hashWithSalt :: Int -&gt; ExBudgetCategory fun -&gt; Int
$chash :: forall fun. Hashable fun =&gt; ExBudgetCategory fun -&gt; Int
hash :: ExBudgetCategory fun -&gt; Int
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Hashable</span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-194"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621681865289"><span id="local-6989586621681866117"><span class="annot"><a href="../../../ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Show.html#Show"><span class="hs-identifier hs-type">Show</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865289"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Pretty</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#ExBudgetCategory"><span class="hs-identifier hs-type">ExBudgetCategory</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865289"><span class="hs-identifier hs-type">fun</span></a></span><span class="hs-special">)</span></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-195"></span><span>    </span><span id="local-6989586621681866122"><span class="annot"><span class="annottext">pretty :: forall ann. ExBudgetCategory fun -&gt; Doc ann
</span><a href="#local-6989586621681866122"><span class="hs-identifier hs-var hs-var hs-var hs-var">pretty</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ExBudgetCategory fun -&gt; Doc ann
forall a ann. Show a =&gt; a -&gt; Doc ann
</span><span class="hs-identifier hs-var">viaShow</span></span><span>
</span><span id="line-196"></span><span>
</span><span id="line-197"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621681865297"><span class="annot"><a href="PlutusCore.Evaluation.Machine.ExBudget.html#ExBudgetBuiltin"><span class="hs-identifier hs-type">ExBudgetBuiltin</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865297"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#ExBudgetCategory"><span class="hs-identifier hs-type">ExBudgetCategory</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865297"><span class="hs-identifier hs-type">fun</span></a></span><span class="hs-special">)</span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-198"></span><span>    </span><span id="local-6989586621681866128"><span class="annot"><span class="annottext">exBudgetBuiltin :: fun -&gt; ExBudgetCategory fun
</span><a href="#local-6989586621681866128"><span class="hs-identifier hs-var hs-var hs-var hs-var">exBudgetBuiltin</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">fun -&gt; ExBudgetCategory fun
forall fun. fun -&gt; ExBudgetCategory fun
</span><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#BBuiltinApp"><span class="hs-identifier hs-var">BBuiltinApp</span></a></span><span>
</span><span id="line-199"></span><span>
</span><span id="line-200"></span><span class="hs-comment">{- Note [Show instance for BuiltinRuntime]
We need to be able to print 'CekValue's and for that we need a 'Show' instance for 'BuiltinRuntime',
but functions are not printable and hence we provide a dummy instance.
-}</span><span>
</span><span id="line-204"></span><span>
</span><span id="line-205"></span><span class="hs-comment">-- See Note [Show instance for BuiltinRuntime].</span><span>
</span><span id="line-206"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621681865303"><span id="local-6989586621681865304"><span id="local-6989586621681865305"><span id="local-6989586621681866131"><span id="local-6989586621681866136"><span class="annot"><a href="../../../ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Show.html#Show"><span class="hs-identifier hs-type">Show</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PlutusCore.Builtin.Runtime.html#BuiltinRuntime"><span class="hs-identifier hs-type">BuiltinRuntime</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#CekValue"><span class="hs-identifier hs-type">CekValue</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865303"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865304"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865305"><span class="hs-identifier hs-type">ann</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span></span></span></span></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-207"></span><span>    </span><span id="local-6989586621681866138"><span class="annot"><span class="annottext">show :: BuiltinRuntime (CekValue uni fun ann) -&gt; String
</span><a href="#local-6989586621681866138"><span class="hs-identifier hs-var hs-var hs-var hs-var">show</span></a></span></span><span> </span><span class="annot"><span class="annottext">BuiltinRuntime (CekValue uni fun ann)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;&lt;builtin_runtime&gt;&quot;</span></span><span>
</span><span id="line-208"></span><span>
</span><span id="line-209"></span><span class="hs-comment">-- | A LIFO stack of 'CekValue's, useful for recording multiple arguments which will need to</span><span>
</span><span id="line-210"></span><span class="hs-comment">-- be pushed onto the context in reverse order.</span><span>
</span><span id="line-211"></span><span class="hs-keyword">data</span><span> </span><span id="ArgStack"><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#ArgStack"><span class="hs-identifier hs-var">ArgStack</span></a></span></span><span> </span><span id="local-6989586621681865754"><span class="annot"><a href="#local-6989586621681865754"><span class="hs-identifier hs-type">uni</span></a></span></span><span> </span><span id="local-6989586621681865755"><span class="annot"><a href="#local-6989586621681865755"><span class="hs-identifier hs-type">fun</span></a></span></span><span> </span><span id="local-6989586621681865756"><span class="annot"><a href="#local-6989586621681865756"><span class="hs-identifier hs-type">ann</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-212"></span><span>  </span><span id="EmptyStack"><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#EmptyStack"><span class="hs-identifier hs-var">EmptyStack</span></a></span></span><span>
</span><span id="line-213"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="ConsStack"><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#ConsStack"><span class="hs-identifier hs-var">ConsStack</span></a></span></span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#CekValue"><span class="hs-identifier hs-type">CekValue</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865754"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865755"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865756"><span class="hs-identifier hs-type">ann</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#ArgStack"><span class="hs-identifier hs-type">ArgStack</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865754"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865755"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865756"><span class="hs-identifier hs-type">ann</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-214"></span><span>
</span><span id="line-215"></span><span id="local-6989586621681866148"><span id="local-6989586621681866157"><span id="local-6989586621681866161"><span class="hs-keyword">deriving</span><span> </span><span id="local-6989586621681865316"><span id="local-6989586621681865317"><span id="local-6989586621681865318"><span class="annot"><a href="#local-6989586621681865316"><span class="hs-keyword hs-type hs-type hs-type">stock</span></a></span></span></span></span><span> </span><span class="hs-keyword">instance</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">GShow</span></span><span> </span><span class="annot"><a href="#local-6989586621681865316"><span class="hs-identifier hs-type">uni</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Universe.Core.html#Everywhere"><span class="hs-identifier hs-type">Everywhere</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865316"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="../../../ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Show.html#Show"><span class="hs-identifier hs-type">Show</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Show.html#Show"><span class="hs-identifier hs-type">Show</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865317"><span class="hs-identifier hs-type">fun</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Show.html#Show"><span class="hs-identifier hs-type">Show</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865318"><span class="hs-identifier hs-type">ann</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Universe.Core.html#Closed"><span class="hs-identifier hs-type">Closed</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865316"><span class="hs-identifier hs-type">uni</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-216"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="../../../ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Show.html#Show"><span class="hs-identifier hs-type">Show</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#ArgStack"><span class="hs-identifier hs-type">ArgStack</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865316"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865317"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865318"><span class="hs-identifier hs-type">ann</span></a></span><span class="hs-special">)</span></span></span></span><span>
</span><span id="line-217"></span><span>
</span><span id="line-218"></span><span class="hs-comment">-- 'Values' for the modified CEK machine.</span><span>
</span><span id="line-219"></span><span class="hs-keyword">data</span><span> </span><span id="CekValue"><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#CekValue"><span class="hs-identifier hs-var">CekValue</span></a></span></span><span> </span><span id="local-6989586621681865649"><span class="annot"><a href="#local-6989586621681865649"><span class="hs-identifier hs-type">uni</span></a></span></span><span> </span><span id="local-6989586621681865650"><span class="annot"><a href="#local-6989586621681865650"><span class="hs-identifier hs-type">fun</span></a></span></span><span> </span><span id="local-6989586621681865651"><span class="annot"><a href="#local-6989586621681865651"><span class="hs-identifier hs-type">ann</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-220"></span><span>    </span><span class="hs-comment">-- This bang gave us a 1-2% speed-up at the time of writing.</span><span>
</span><span id="line-221"></span><span>    </span><span id="VCon"><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#VCon"><span class="hs-identifier hs-var">VCon</span></a></span></span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Some</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Universe.Core.html#ValueOf"><span class="hs-identifier hs-type">ValueOf</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865649"><span class="hs-identifier hs-type">uni</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-222"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="VDelay"><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#VDelay"><span class="hs-identifier hs-var">VDelay</span></a></span></span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#NTerm"><span class="hs-identifier hs-type">NTerm</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865649"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865650"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865651"><span class="hs-identifier hs-type">ann</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#CekValEnv"><span class="hs-identifier hs-type">CekValEnv</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865649"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865650"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865651"><span class="hs-identifier hs-type">ann</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-223"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="VLamAbs"><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#VLamAbs"><span class="hs-identifier hs-var">VLamAbs</span></a></span></span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="PlutusCore.DeBruijn.Internal.html#NamedDeBruijn"><span class="hs-identifier hs-type">NamedDeBruijn</span></a></span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#NTerm"><span class="hs-identifier hs-type">NTerm</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865649"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865650"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865651"><span class="hs-identifier hs-type">ann</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#CekValEnv"><span class="hs-identifier hs-type">CekValEnv</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865649"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865650"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865651"><span class="hs-identifier hs-type">ann</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-224"></span><span>    </span><span class="hs-comment">-- | A partial builtin application, accumulating arguments for eventual full application.</span><span>
</span><span id="line-225"></span><span>    </span><span class="hs-comment">-- We don't need a 'CekValEnv' here unlike in the other constructors, because 'VBuiltin'</span><span>
</span><span id="line-226"></span><span>    </span><span class="hs-comment">-- values always store their corresponding 'Term's fully discharged, see the comments at</span><span>
</span><span id="line-227"></span><span>    </span><span class="hs-comment">-- the call sites (search for 'VBuiltin').</span><span>
</span><span id="line-228"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="VBuiltin"><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#VBuiltin"><span class="hs-identifier hs-var">VBuiltin</span></a></span></span><span>
</span><span id="line-229"></span><span>      </span><span class="hs-glyph">!</span><span class="annot"><a href="#local-6989586621681865650"><span class="hs-identifier hs-type">fun</span></a></span><span>
</span><span id="line-230"></span><span>      </span><span class="hs-comment">-- ^ So that we know, for what builtin we're calculating the cost. We can sneak this into</span><span>
</span><span id="line-231"></span><span>      </span><span class="hs-comment">-- 'BuiltinRuntime', so that we don't need to store it here, but somehow doing so was</span><span>
</span><span id="line-232"></span><span>      </span><span class="hs-comment">-- consistently slowing evaluation down by half a percent. Might be noise, might be not, but</span><span>
</span><span id="line-233"></span><span>      </span><span class="hs-comment">-- at least we know that removing this @fun@ is not helpful anyway. See this commit reversing</span><span>
</span><span id="line-234"></span><span>      </span><span class="hs-comment">-- the change: https://github.com/IntersectMBO/plutus/pull/4778/commits/86a3e24ca3c671cc27c6f4344da2bcd14f961706</span><span>
</span><span id="line-235"></span><span>      </span><span class="hs-special">(</span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#NTerm"><span class="hs-identifier hs-type">NTerm</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865649"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865650"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-236"></span><span>      </span><span class="hs-comment">-- ^ This must be lazy. It represents the fully discharged partial application of the builtin</span><span>
</span><span id="line-237"></span><span>      </span><span class="hs-comment">-- function that we're going to run when it's fully saturated.  We need the 'Term' to be able</span><span>
</span><span id="line-238"></span><span>      </span><span class="hs-comment">-- to return it in case full saturation is never achieved and a partial application needs to</span><span>
</span><span id="line-239"></span><span>      </span><span class="hs-comment">-- be returned in the result. The laziness is important, because the arguments are discharged</span><span>
</span><span id="line-240"></span><span>      </span><span class="hs-comment">-- values and discharging is expensive, so we don't want to do it unless we really have</span><span>
</span><span id="line-241"></span><span>      </span><span class="hs-comment">-- to. Making this field strict resulted in a 3-4.5% slowdown at the time of writing.</span><span>
</span><span id="line-242"></span><span>      </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="PlutusCore.Builtin.Runtime.html#BuiltinRuntime"><span class="hs-identifier hs-type">BuiltinRuntime</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#CekValue"><span class="hs-identifier hs-type">CekValue</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865649"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865650"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865651"><span class="hs-identifier hs-type">ann</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-243"></span><span>      </span><span class="hs-comment">-- ^ The partial application and its costing function.</span><span>
</span><span id="line-244"></span><span>      </span><span class="hs-comment">-- Check the docs of 'BuiltinRuntime' for details.</span><span>
</span><span id="line-245"></span><span>    </span><span class="hs-comment">-- | A constructor value, including fully computed arguments and the tag.</span><span>
</span><span id="line-246"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="VConstr"><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#VConstr"><span class="hs-identifier hs-var">VConstr</span></a></span></span><span> </span><span class="hs-pragma">{-# UNPACK</span><span> </span><span class="hs-pragma">#-}</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="../../../ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Word.html#Word64"><span class="hs-identifier hs-type">Word64</span></a></span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#ArgStack"><span class="hs-identifier hs-type">ArgStack</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865649"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865650"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865651"><span class="hs-identifier hs-type">ann</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-247"></span><span>
</span><span id="line-248"></span><span id="local-6989586621681866175"><span id="local-6989586621681866204"><span id="local-6989586621681866208"><span class="hs-keyword">deriving</span><span> </span><span id="local-6989586621681865313"><span id="local-6989586621681865314"><span id="local-6989586621681865315"><span class="annot"><a href="#local-6989586621681865313"><span class="hs-keyword hs-type hs-type hs-type">stock</span></a></span></span></span></span><span> </span><span class="hs-keyword">instance</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">GShow</span></span><span> </span><span class="annot"><a href="#local-6989586621681865313"><span class="hs-identifier hs-type">uni</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Universe.Core.html#Everywhere"><span class="hs-identifier hs-type">Everywhere</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865313"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="../../../ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Show.html#Show"><span class="hs-identifier hs-type">Show</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Show.html#Show"><span class="hs-identifier hs-type">Show</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865314"><span class="hs-identifier hs-type">fun</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Show.html#Show"><span class="hs-identifier hs-type">Show</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865315"><span class="hs-identifier hs-type">ann</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Universe.Core.html#Closed"><span class="hs-identifier hs-type">Closed</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865313"><span class="hs-identifier hs-type">uni</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-249"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="../../../ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Show.html#Show"><span class="hs-identifier hs-type">Show</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#CekValue"><span class="hs-identifier hs-type">CekValue</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865313"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865314"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865315"><span class="hs-identifier hs-type">ann</span></a></span><span class="hs-special">)</span></span></span></span><span>
</span><span id="line-250"></span><span>
</span><span id="line-251"></span><span class="hs-keyword">type</span><span> </span><span id="CekValEnv"><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#CekValEnv"><span class="hs-identifier hs-var">CekValEnv</span></a></span></span><span> </span><span id="local-6989586621681866216"><span class="annot"><a href="#local-6989586621681866216"><span class="hs-identifier hs-type">uni</span></a></span></span><span> </span><span id="local-6989586621681866217"><span class="annot"><a href="#local-6989586621681866217"><span class="hs-identifier hs-type">fun</span></a></span></span><span> </span><span id="local-6989586621681866218"><span class="annot"><a href="#local-6989586621681866218"><span class="hs-identifier hs-type">ann</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Env.RAList</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#CekValue"><span class="hs-identifier hs-type">CekValue</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681866216"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681866217"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681866218"><span class="hs-identifier hs-type">ann</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-252"></span><span>
</span><span id="line-253"></span><span class="hs-comment">-- | The CEK machine is parameterized over a @spendBudget@ function. This makes the budgeting machinery extensible</span><span>
</span><span id="line-254"></span><span class="hs-comment">-- and allows us to separate budgeting logic from evaluation logic and avoid branching on the union</span><span>
</span><span id="line-255"></span><span class="hs-comment">-- of all possible budgeting state types during evaluation.</span><span>
</span><span id="line-256"></span><span class="hs-keyword">newtype</span><span> </span><span id="CekBudgetSpender"><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#CekBudgetSpender"><span class="hs-identifier hs-var">CekBudgetSpender</span></a></span></span><span> </span><span id="local-6989586621681865337"><span class="annot"><a href="#local-6989586621681865337"><span class="hs-identifier hs-type">uni</span></a></span></span><span> </span><span id="local-6989586621681865338"><span class="annot"><a href="#local-6989586621681865338"><span class="hs-identifier hs-type">fun</span></a></span></span><span> </span><span id="local-6989586621681865339"><span class="annot"><a href="#local-6989586621681865339"><span class="hs-identifier hs-type">s</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="CekBudgetSpender"><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#CekBudgetSpender"><span class="hs-identifier hs-var">CekBudgetSpender</span></a></span></span><span>
</span><span id="line-257"></span><span>    </span><span class="hs-special">{</span><span> </span><span id="unCekBudgetSpender"><span class="annot"><span class="annottext">forall (uni :: * -&gt; *) fun s.
CekBudgetSpender uni fun s
-&gt; ExBudgetCategory fun -&gt; ExBudget -&gt; CekM uni fun s ()
</span><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#unCekBudgetSpender"><span class="hs-identifier hs-var hs-var">unCekBudgetSpender</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#ExBudgetCategory"><span class="hs-identifier hs-type">ExBudgetCategory</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865338"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="PlutusCore.Evaluation.Machine.ExBudget.html#ExBudget"><span class="hs-identifier hs-type">ExBudget</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#CekM"><span class="hs-identifier hs-type">CekM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865337"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865338"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865339"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-258"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-259"></span><span>
</span><span id="line-260"></span><span class="hs-comment">-- General enough to be able to handle a spender having one, two or any number of 'STRef's</span><span>
</span><span id="line-261"></span><span class="hs-comment">-- under the hood.</span><span>
</span><span id="line-262"></span><span class="annot"><span class="hs-comment">-- | Runtime budgeting info.</span></span><span>
</span><span id="line-263"></span><span class="hs-keyword">data</span><span> </span><span id="ExBudgetInfo"><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#ExBudgetInfo"><span class="hs-identifier hs-var">ExBudgetInfo</span></a></span></span><span> </span><span id="local-6989586621681865345"><span class="annot"><a href="#local-6989586621681865345"><span class="hs-identifier hs-type">cost</span></a></span></span><span> </span><span id="local-6989586621681865346"><span class="annot"><a href="#local-6989586621681865346"><span class="hs-identifier hs-type">uni</span></a></span></span><span> </span><span id="local-6989586621681865347"><span class="annot"><a href="#local-6989586621681865347"><span class="hs-identifier hs-type">fun</span></a></span></span><span> </span><span id="local-6989586621681865348"><span class="annot"><a href="#local-6989586621681865348"><span class="hs-identifier hs-type">s</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="ExBudgetInfo"><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#ExBudgetInfo"><span class="hs-identifier hs-var">ExBudgetInfo</span></a></span></span><span>
</span><span id="line-264"></span><span>    </span><span class="hs-special">{</span><span> </span><span id="_exBudgetModeSpender"><span class="annot"><span class="annottext">forall cost (uni :: * -&gt; *) fun s.
ExBudgetInfo cost uni fun s -&gt; CekBudgetSpender uni fun s
</span><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#_exBudgetModeSpender"><span class="hs-identifier hs-var hs-var">_exBudgetModeSpender</span></a></span></span><span>       </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#CekBudgetSpender"><span class="hs-identifier hs-type">CekBudgetSpender</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865346"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865347"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865348"><span class="hs-identifier hs-type">s</span></a></span><span class="hs-special">)</span><span>  </span><span class="annot"><span class="hs-comment">-- ^ A spending function.</span></span><span>
</span><span id="line-265"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="_exBudgetModeGetFinal"><span class="annot"><span class="annottext">forall cost (uni :: * -&gt; *) fun s.
ExBudgetInfo cost uni fun s -&gt; ST s cost
</span><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#_exBudgetModeGetFinal"><span class="hs-identifier hs-var hs-var">_exBudgetModeGetFinal</span></a></span></span><span>      </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="../../../ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.ST.html#ST"><span class="hs-identifier hs-type">ST</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865348"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865345"><span class="hs-identifier hs-type">cost</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-comment">-- ^ For accessing the final state.</span></span><span>
</span><span id="line-266"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="_exBudgetModeGetCumulative"><span class="annot"><span class="annottext">forall cost (uni :: * -&gt; *) fun s.
ExBudgetInfo cost uni fun s -&gt; ST s ExBudget
</span><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#_exBudgetModeGetCumulative"><span class="hs-identifier hs-var hs-var">_exBudgetModeGetCumulative</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="../../../ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.ST.html#ST"><span class="hs-identifier hs-type">ST</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865348"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="annot"><a href="PlutusCore.Evaluation.Machine.ExBudget.html#ExBudget"><span class="hs-identifier hs-type">ExBudget</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-comment">-- ^ For accessing the cumulative budget.</span></span><span>
</span><span id="line-267"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-268"></span><span>
</span><span id="line-269"></span><span class="hs-comment">-- We make a separate data type here just to save the caller of the CEK machine from those pesky</span><span>
</span><span id="line-270"></span><span class="hs-comment">-- 'ST'-related details.</span><span>
</span><span id="line-271"></span><span class="annot"><span class="hs-comment">-- | A budgeting mode to execute the CEK machine in.</span></span><span>
</span><span id="line-272"></span><span class="hs-keyword">newtype</span><span> </span><span id="ExBudgetMode"><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#ExBudgetMode"><span class="hs-identifier hs-var">ExBudgetMode</span></a></span></span><span> </span><span id="local-6989586621681865363"><span class="annot"><a href="#local-6989586621681865363"><span class="hs-identifier hs-type">cost</span></a></span></span><span> </span><span id="local-6989586621681865364"><span class="annot"><a href="#local-6989586621681865364"><span class="hs-identifier hs-type">uni</span></a></span></span><span> </span><span id="local-6989586621681865365"><span class="annot"><a href="#local-6989586621681865365"><span class="hs-identifier hs-type">fun</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="ExBudgetMode"><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#ExBudgetMode"><span class="hs-identifier hs-var">ExBudgetMode</span></a></span></span><span>
</span><span id="line-273"></span><span>    </span><span class="hs-special">{</span><span> </span><span id="unExBudgetMode"><span class="annot"><span class="annottext">forall cost (uni :: * -&gt; *) fun.
ExBudgetMode cost uni fun
-&gt; forall s. ST s (ExBudgetInfo cost uni fun s)
</span><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#unExBudgetMode"><span class="hs-identifier hs-var hs-var">unExBudgetMode</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621681865367"><span class="annot"><a href="#local-6989586621681865367"><span class="hs-identifier hs-type">s</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><a href="../../../ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.ST.html#ST"><span class="hs-identifier hs-type">ST</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865367"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#ExBudgetInfo"><span class="hs-identifier hs-type">ExBudgetInfo</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865363"><span class="hs-identifier hs-type">cost</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865364"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865365"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865367"><span class="hs-identifier hs-type">s</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-274"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-275"></span><span>
</span><span id="line-276"></span><span class="hs-comment">{- Note [Cost slippage]
Tracking the budget usage for every step in the machine adds a lot of overhead. To reduce this,
we adopt a technique which allows some overshoot of the budget (&quot;slippage&quot;), but only a bounded
amount.

To do this we:
- Track all the machine steps of all kinds in an set of counters in a 'StepCounter'
- Actually &quot;spend&quot; the budget when we've done more than some fixed number of steps, or at the end.

This saves a *lot* of time, at the cost of potentially overshooting the budget by slippage*step_cost,
which is okay so long as we bound the slippage appropriately.

Note that we're only proposing to do this for machine steps, since it's plausible that we can track
them in an optimized way. Builtins are more complicated (and infrequent), so we can just budget them
properly when we hit them.

There are two options for how to bound the slippage:
1. As a fixed number of steps
2. As a proportion of the overall budget

Option 2 initially seems much better as a bound: if we run N scripts with an overall budget of B, then
the potential overrun from 1 is N*slippage, whereas the overrun from 2 is B*slippage. That is, 2
says we always overrun by a fraction of the total amount of time you were expecting, whereas 1 says
it depends how many scripts you run... so if I send you a lot of small scripts, I could cause a lot
of overrun.

However, it turns out (empirically) that we can pick a number for 1 that gives us most of the speedup, but such
that the maximum overrun is negligible (e.g. much smaller than the &quot;startup cost&quot;). So in the end
we opted for option 1, which also happens to be simpler to implement.
-}</span><span>
</span><span id="line-306"></span><span>
</span><span id="line-307"></span><span class="hs-comment">{- Note [Structure of the step counter]
The step counter is kept in a 'MutablePrimArray', which is a fast way of storing a bunch of
mutable 'Word8's.
This suits our purposes, as we need one counter for every step type, and one for the total number.

We keep the counters for each step in the first indices, so we can index them simply by using
the 'Enum' instance of 'StepKind', and the total counter in the last index.
-}</span><span>
</span><span id="line-315"></span><span>
</span><span id="line-316"></span><span class="hs-comment">-- So that we don't need to update 'NumberOfStepCounters' manually, which would be extremely</span><span>
</span><span id="line-317"></span><span class="hs-comment">-- error-prone and has caused a bug in the past.</span><span>
</span><span id="line-318"></span><span class="hs-keyword">type</span><span> </span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#CountConstructorsEnum"><span class="hs-identifier hs-type">CountConstructorsEnum</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Type"><span class="hs-identifier hs-type">GHC.Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Type"><span class="hs-identifier hs-type">GHC.Type</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.TypeNats.html#Nat"><span class="hs-identifier hs-type">Nat</span></a></span><span>
</span><span id="line-319"></span><span class="hs-keyword">type</span><span> </span><span class="hs-keyword">family</span><span> </span><span id="CountConstructorsEnum"><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#CountConstructorsEnum"><span class="hs-identifier hs-var">CountConstructorsEnum</span></a></span></span><span> </span><span id="local-6989586621681866228"><span class="annot"><a href="#local-6989586621681866228"><span class="hs-identifier hs-type">rep</span></a></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-320"></span><span>    </span><span id="CountConstructorsEnum"><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#CountConstructorsEnum"><span class="hs-identifier hs-var">CountConstructorsEnum</span></a></span></span><span> </span><span class="annot"><a href="../../../ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Generics.html#U1"><span class="hs-identifier hs-type">U1</span></a></span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-number">1</span></span><span>
</span><span id="line-321"></span><span>    </span><span id="CountConstructorsEnum"><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#CountConstructorsEnum"><span class="hs-identifier hs-var">CountConstructorsEnum</span></a></span></span><span> </span><span id="local-6989586621681866229"><span class="hs-special">(</span><span class="annot"><a href="../../../ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Generics.html#M1"><span class="hs-identifier hs-type">M1</span></a></span><span> </span><span class="annot"><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="hs-identifier">_</span></span><span> </span><span class="annot"><a href="#local-6989586621681866229"><span class="hs-identifier hs-type">f</span></a></span><span class="hs-special">)</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#CountConstructorsEnum"><span class="hs-identifier hs-type">CountConstructorsEnum</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681866229"><span class="hs-identifier hs-type">f</span></a></span><span>
</span><span id="line-322"></span><span>    </span><span id="CountConstructorsEnum"><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#CountConstructorsEnum"><span class="hs-identifier hs-var">CountConstructorsEnum</span></a></span></span><span> </span><span id="local-6989586621681866230"><span id="local-6989586621681866231"><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621681866230"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><a href="../../../ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Generics.html#%3A%2B%3A"><span class="hs-operator hs-type">:+:</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681866231"><span class="hs-identifier hs-type">g</span></a></span><span class="hs-special">)</span></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#CountConstructorsEnum"><span class="hs-identifier hs-type">CountConstructorsEnum</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681866230"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><a href="../../../ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.TypeNats.html#%2B"><span class="hs-operator hs-type">+</span></a></span><span> </span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#CountConstructorsEnum"><span class="hs-identifier hs-type">CountConstructorsEnum</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681866231"><span class="hs-identifier hs-type">g</span></a></span><span>
</span><span id="line-323"></span><span>    </span><span id="CountConstructorsEnum"><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#CountConstructorsEnum"><span class="hs-identifier hs-var">CountConstructorsEnum</span></a></span></span><span> </span><span class="annot"><a href="../../../ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Generics.html#V1"><span class="hs-identifier hs-type">V1</span></a></span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="../../../ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.TypeError.html#TypeError"><span class="hs-identifier hs-type">TypeError</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">'</span><span class="annot"><a href="../../../ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.TypeError.html#Text"><span class="hs-identifier hs-type">Text</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;Cannot be empty&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-324"></span><span>    </span><span id="CountConstructorsEnum"><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#CountConstructorsEnum"><span class="hs-identifier hs-var">CountConstructorsEnum</span></a></span></span><span> </span><span id="local-6989586621681866232"><span id="local-6989586621681866233"><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621681866232"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><a href="../../../ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Generics.html#%3A%2A%3A"><span class="hs-operator hs-type">:*:</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681866233"><span class="hs-identifier hs-type">g</span></a></span><span class="hs-special">)</span></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="../../../ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.TypeError.html#TypeError"><span class="hs-identifier hs-type">TypeError</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">'</span><span class="annot"><a href="../../../ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.TypeError.html#Text"><span class="hs-identifier hs-type">Text</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;Cannot be a non-enumeration type&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-325"></span><span>    </span><span id="CountConstructorsEnum"><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#CountConstructorsEnum"><span class="hs-identifier hs-var">CountConstructorsEnum</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Generics.html#K1"><span class="hs-identifier hs-type">K1</span></a></span><span> </span><span class="annot"><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="../../../ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.TypeError.html#TypeError"><span class="hs-identifier hs-type">TypeError</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">'</span><span class="annot"><a href="../../../ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.TypeError.html#Text"><span class="hs-identifier hs-type">Text</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;Cannot be a non-enumeration type&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-326"></span><span>    </span><span id="CountConstructorsEnum"><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#CountConstructorsEnum"><span class="hs-identifier hs-var">CountConstructorsEnum</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Generics.html#Rec1"><span class="hs-identifier hs-type">Rec1</span></a></span><span> </span><span class="annot"><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="../../../ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.TypeError.html#TypeError"><span class="hs-identifier hs-type">TypeError</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">'</span><span class="annot"><a href="../../../ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.TypeError.html#Text"><span class="hs-identifier hs-type">Text</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;Cannot be a non-enumeration type&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-327"></span><span>    </span><span id="CountConstructorsEnum"><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#CountConstructorsEnum"><span class="hs-identifier hs-var">CountConstructorsEnum</span></a></span></span><span> </span><span class="annot"><a href="../../../ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Generics.html#Par1"><span class="hs-identifier hs-type">Par1</span></a></span><span>       </span><span class="hs-glyph">=</span><span>
</span><span id="line-328"></span><span>        </span><span class="annot"><a href="../../../ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.TypeError.html#TypeError"><span class="hs-identifier hs-type">TypeError</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">'</span><span class="annot"><a href="../../../ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.TypeError.html#Text"><span class="hs-identifier hs-type">Text</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;If you really want a parameterized type, handle this clause&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-329"></span><span>
</span><span id="line-330"></span><span class="hs-comment">-- | The number of step counters that we need, should be the same as the number of constructors</span><span>
</span><span id="line-331"></span><span class="hs-comment">-- of 'StepKind'.</span><span>
</span><span id="line-332"></span><span class="hs-keyword">type</span><span> </span><span id="NumberOfStepCounters"><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#NumberOfStepCounters"><span class="hs-identifier hs-var">NumberOfStepCounters</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#CountConstructorsEnum"><span class="hs-identifier hs-type">CountConstructorsEnum</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Generics.html#Rep"><span class="hs-identifier hs-type">Rep</span></a></span><span> </span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#StepKind"><span class="hs-identifier hs-type">StepKind</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-333"></span><span class="hs-comment">-- | The total number of counters that we need, one extra for the total counter.</span><span>
</span><span id="line-334"></span><span class="hs-comment">-- See Note [Structure of the step counter]</span><span>
</span><span id="line-335"></span><span class="hs-keyword">type</span><span> </span><span id="CounterSize"><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#CounterSize"><span class="hs-identifier hs-var">CounterSize</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#NumberOfStepCounters"><span class="hs-identifier hs-type">NumberOfStepCounters</span></a></span><span> </span><span class="annot"><a href="../../../ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.TypeNats.html#%2B"><span class="hs-operator hs-type">+</span></a></span><span> </span><span class="annot"><span class="hs-number">1</span></span><span>
</span><span id="line-336"></span><span class="hs-comment">-- | The index at which the total step counter is kept.</span><span>
</span><span id="line-337"></span><span class="hs-comment">-- See Note [Structure of the step counter]</span><span>
</span><span id="line-338"></span><span class="hs-keyword">type</span><span> </span><span id="TotalCountIndex"><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#TotalCountIndex"><span class="hs-identifier hs-var">TotalCountIndex</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#NumberOfStepCounters"><span class="hs-identifier hs-type">NumberOfStepCounters</span></a></span><span>
</span><span id="line-339"></span><span>
</span><span id="line-340"></span><span class="hs-keyword">type</span><span> </span><span id="Slippage"><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#Slippage"><span class="hs-identifier hs-var">Slippage</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="../../../ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Word.html#Word8"><span class="hs-identifier hs-type">Word8</span></a></span><span>
</span><span id="line-341"></span><span class="hs-comment">-- See Note [Cost slippage]</span><span>
</span><span id="line-342"></span><span class="annot"><span class="hs-comment">-- | The default number of slippage (in machine steps) to allow.</span></span><span>
</span><span id="line-343"></span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#defaultSlippage"><span class="hs-identifier hs-type">defaultSlippage</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#Slippage"><span class="hs-identifier hs-type">Slippage</span></a></span><span>
</span><span id="line-344"></span><span id="defaultSlippage"><span class="annot"><span class="annottext">defaultSlippage :: Slippage
</span><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#defaultSlippage"><span class="hs-identifier hs-var hs-var">defaultSlippage</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Slippage
</span><span class="hs-number">200</span></span><span>
</span><span id="line-345"></span><span>
</span><span id="line-346"></span><span class="hs-comment">{- Note [DList-based emitting]
Instead of emitting log lines one by one, we have a 'DList' of them in the type of emitters
(see 'CekEmitter'). That 'DList' comes from 'Emitter' and allows the latter to be an efficient
monad for logging. We leak this implementation detail in the type of emitters, because it's the
most efficient way of doing emitting, see
https://github.com/IntersectMBO/plutus/pull/4421#issuecomment-1059186586
-}</span><span>
</span><span id="line-353"></span><span>
</span><span id="line-354"></span><span class="hs-comment">-- See Note [DList-based emitting].</span><span>
</span><span id="line-355"></span><span class="annot"><span class="hs-comment">-- | The CEK machine is parameterized over an emitter function, similar to 'CekBudgetSpender'.</span></span><span>
</span><span id="line-356"></span><span class="hs-keyword">type</span><span> </span><span id="CekEmitter"><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#CekEmitter"><span class="hs-identifier hs-var">CekEmitter</span></a></span></span><span> </span><span id="local-6989586621681866234"><span class="annot"><a href="#local-6989586621681866234"><span class="hs-identifier hs-type">uni</span></a></span></span><span> </span><span id="local-6989586621681866235"><span class="annot"><a href="#local-6989586621681866235"><span class="hs-identifier hs-type">fun</span></a></span></span><span> </span><span id="local-6989586621681866236"><span class="annot"><a href="#local-6989586621681866236"><span class="hs-identifier hs-type">s</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">DList.DList</span></span><span> </span><span class="annot"><a href="../../../ghc-9.6.6/html/libraries/text-2.0.2/src/Data.Text.Internal.html#Text"><span class="hs-identifier hs-type">Text</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#CekM"><span class="hs-identifier hs-type">CekM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681866234"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681866235"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681866236"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-357"></span><span>
</span><span id="line-358"></span><span class="annot"><span class="hs-comment">-- | Runtime emitter info, similar to 'ExBudgetInfo'.</span></span><span>
</span><span id="line-359"></span><span class="hs-keyword">data</span><span> </span><span id="CekEmitterInfo"><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#CekEmitterInfo"><span class="hs-identifier hs-var">CekEmitterInfo</span></a></span></span><span> </span><span id="local-6989586621681865372"><span class="annot"><a href="#local-6989586621681865372"><span class="hs-identifier hs-type">uni</span></a></span></span><span> </span><span id="local-6989586621681865373"><span class="annot"><a href="#local-6989586621681865373"><span class="hs-identifier hs-type">fun</span></a></span></span><span> </span><span id="local-6989586621681865374"><span class="annot"><a href="#local-6989586621681865374"><span class="hs-identifier hs-type">s</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="CekEmitterInfo"><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#CekEmitterInfo"><span class="hs-identifier hs-var">CekEmitterInfo</span></a></span></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-360"></span><span>    </span><span id="_cekEmitterInfoEmit"><span class="annot"><span class="annottext">forall (uni :: * -&gt; *) fun s.
CekEmitterInfo uni fun s -&gt; CekEmitter uni fun s
</span><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#_cekEmitterInfoEmit"><span class="hs-identifier hs-var hs-var">_cekEmitterInfoEmit</span></a></span></span><span>       </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#CekEmitter"><span class="hs-identifier hs-type">CekEmitter</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865372"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865373"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865374"><span class="hs-identifier hs-type">s</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-361"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="_cekEmitterInfoGetFinal"><span class="annot"><span class="annottext">forall (uni :: * -&gt; *) fun s.
CekEmitterInfo uni fun s -&gt; ST s [Text]
</span><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#_cekEmitterInfoGetFinal"><span class="hs-identifier hs-var hs-var">_cekEmitterInfoGetFinal</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="../../../ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.ST.html#ST"><span class="hs-identifier hs-type">ST</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865374"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="../../../ghc-9.6.6/html/libraries/text-2.0.2/src/Data.Text.Internal.html#Text"><span class="hs-identifier hs-type">Text</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-362"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-363"></span><span>
</span><span id="line-364"></span><span class="annot"><span class="hs-comment">-- | An emitting mode to execute the CEK machine in, similar to 'ExBudgetMode'.</span></span><span>
</span><span id="line-365"></span><span class="hs-keyword">newtype</span><span> </span><span id="EmitterMode"><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#EmitterMode"><span class="hs-identifier hs-var">EmitterMode</span></a></span></span><span> </span><span id="local-6989586621681865384"><span class="annot"><a href="#local-6989586621681865384"><span class="hs-identifier hs-type">uni</span></a></span></span><span> </span><span id="local-6989586621681865385"><span class="annot"><a href="#local-6989586621681865385"><span class="hs-identifier hs-type">fun</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="EmitterMode"><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#EmitterMode"><span class="hs-identifier hs-var">EmitterMode</span></a></span></span><span>
</span><span id="line-366"></span><span>    </span><span class="hs-special">{</span><span> </span><span id="unEmitterMode"><span class="annot"><span class="annottext">forall (uni :: * -&gt; *) fun.
EmitterMode uni fun
-&gt; forall s. ST s ExBudget -&gt; ST s (CekEmitterInfo uni fun s)
</span><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#unEmitterMode"><span class="hs-identifier hs-var hs-var">unEmitterMode</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621681865387"><span class="annot"><a href="#local-6989586621681865387"><span class="hs-identifier hs-type">s</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><a href="../../../ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.ST.html#ST"><span class="hs-identifier hs-type">ST</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865387"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="annot"><a href="PlutusCore.Evaluation.Machine.ExBudget.html#ExBudget"><span class="hs-identifier hs-type">ExBudget</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.ST.html#ST"><span class="hs-identifier hs-type">ST</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865387"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#CekEmitterInfo"><span class="hs-identifier hs-type">CekEmitterInfo</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865384"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865385"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865387"><span class="hs-identifier hs-type">s</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-367"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-368"></span><span>
</span><span id="line-369"></span><span class="hs-comment">{- Note [Implicit parameters in the machine]
The traditional way to pass context into a function is to use 'ReaderT'. However, 'ReaderT' has some
disadvantages.
- It requires threading through the context even where you don't need it (every monadic bind)
- It *can* often be optimized away, but this requires GHC to be somewhat clever and do a lot of
  case-of-case to lift all the arguments out.

Moreover, if your context is global (i.e. constant across the lifetime of the monad, i.e. you don't
need 'local'), then you're buying some extra power (the ability to pass in a different context somewhere
deep inside the computation) which you don't need.

There are three main alternatives:
- Explicit function parameters. Simple, doesn't get tied up in the Monad operations, *does* still
present the appearance of letting you do 'local'. But a bit cluttered.
- Implicit parameters. A bit esoteric, can be bundled up into a constraint synonym and just piped to
where they're needed, essentially the same as explicit parameters in terms of runtime.
- Constraints via 'reflection'. Quite esoteric, *does* get you global parameters (within their scope),
bit of a hassle threading around all the extra type parameters.

We're using implicit parameters for now, which seems to strike a good balance of speed and convenience.
I haven't tried 'reflection' in detail, but I believe the main thing it would do is to make the parameters
global - but we already have this for most of the hot functions by making them all local definitions, so
they don't actually take the context as an argument even at the source level.
-}</span><span>
</span><span id="line-393"></span><span>
</span><span id="line-394"></span><span class="annot"><span class="hs-comment">-- | Implicit parameter for the builtin runtime.</span></span><span>
</span><span id="line-395"></span><span class="hs-keyword">type</span><span> </span><span id="GivenCekRuntime"><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#GivenCekRuntime"><span class="hs-identifier hs-var">GivenCekRuntime</span></a></span></span><span> </span><span id="local-6989586621681866242"><span class="annot"><a href="#local-6989586621681866242"><span class="hs-identifier hs-type">uni</span></a></span></span><span> </span><span id="local-6989586621681866243"><span class="annot"><a href="#local-6989586621681866243"><span class="hs-identifier hs-type">fun</span></a></span></span><span> </span><span id="local-6989586621681866244"><span class="annot"><a href="#local-6989586621681866244"><span class="hs-identifier hs-type">ann</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="">?cekRuntime</span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PlutusCore.Builtin.Runtime.html#BuiltinsRuntime"><span class="hs-identifier hs-type">BuiltinsRuntime</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681866243"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#CekValue"><span class="hs-identifier hs-type">CekValue</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681866242"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681866243"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681866244"><span class="hs-identifier hs-type">ann</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-396"></span><span class="annot"><span class="hs-comment">-- | Implicit parameter for the log emitter reference.</span></span><span>
</span><span id="line-397"></span><span class="hs-keyword">type</span><span> </span><span id="GivenCekEmitter"><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#GivenCekEmitter"><span class="hs-identifier hs-var">GivenCekEmitter</span></a></span></span><span> </span><span id="local-6989586621681866245"><span class="annot"><a href="#local-6989586621681866245"><span class="hs-identifier hs-type">uni</span></a></span></span><span> </span><span id="local-6989586621681866246"><span class="annot"><a href="#local-6989586621681866246"><span class="hs-identifier hs-type">fun</span></a></span></span><span> </span><span id="local-6989586621681866247"><span class="annot"><a href="#local-6989586621681866247"><span class="hs-identifier hs-type">s</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="">?cekEmitter</span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#CekEmitter"><span class="hs-identifier hs-type">CekEmitter</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681866245"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681866246"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681866247"><span class="hs-identifier hs-type">s</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-398"></span><span class="annot"><span class="hs-comment">-- | Implicit parameter for budget spender.</span></span><span>
</span><span id="line-399"></span><span class="hs-keyword">type</span><span> </span><span id="GivenCekSpender"><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#GivenCekSpender"><span class="hs-identifier hs-var">GivenCekSpender</span></a></span></span><span> </span><span id="local-6989586621681866248"><span class="annot"><a href="#local-6989586621681866248"><span class="hs-identifier hs-type">uni</span></a></span></span><span> </span><span id="local-6989586621681866249"><span class="annot"><a href="#local-6989586621681866249"><span class="hs-identifier hs-type">fun</span></a></span></span><span> </span><span id="local-6989586621681866250"><span class="annot"><a href="#local-6989586621681866250"><span class="hs-identifier hs-type">s</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="">?cekBudgetSpender</span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#CekBudgetSpender"><span class="hs-identifier hs-type">CekBudgetSpender</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681866248"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681866249"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681866250"><span class="hs-identifier hs-type">s</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-400"></span><span class="hs-keyword">type</span><span> </span><span id="GivenCekSlippage"><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#GivenCekSlippage"><span class="hs-identifier hs-var">GivenCekSlippage</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="">?cekSlippage</span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#Slippage"><span class="hs-identifier hs-type">Slippage</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-401"></span><span class="hs-keyword">type</span><span> </span><span id="GivenCekStepCounter"><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#GivenCekStepCounter"><span class="hs-identifier hs-var">GivenCekStepCounter</span></a></span></span><span> </span><span id="local-6989586621681866252"><span class="annot"><a href="#local-6989586621681866252"><span class="hs-identifier hs-type">s</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="">?cekStepCounter</span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.StepCounter.html#StepCounter"><span class="hs-identifier hs-type">StepCounter</span></a></span><span> </span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#CounterSize"><span class="hs-identifier hs-type">CounterSize</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681866252"><span class="hs-identifier hs-type">s</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-402"></span><span class="hs-keyword">type</span><span> </span><span id="GivenCekCosts"><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#GivenCekCosts"><span class="hs-identifier hs-var">GivenCekCosts</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="">?cekCosts</span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.CekMachineCosts.html#CekMachineCosts"><span class="hs-identifier hs-type">CekMachineCosts</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-403"></span><span>
</span><span id="line-404"></span><span class="annot"><span class="hs-comment">-- | Constraint requiring all of the machine's implicit parameters.</span></span><span>
</span><span id="line-405"></span><span class="hs-keyword">type</span><span> </span><span id="GivenCekReqs"><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#GivenCekReqs"><span class="hs-identifier hs-var">GivenCekReqs</span></a></span></span><span> </span><span id="local-6989586621681866254"><span class="annot"><a href="#local-6989586621681866254"><span class="hs-identifier hs-type">uni</span></a></span></span><span> </span><span id="local-6989586621681866255"><span class="annot"><a href="#local-6989586621681866255"><span class="hs-identifier hs-type">fun</span></a></span></span><span> </span><span id="local-6989586621681866256"><span class="annot"><a href="#local-6989586621681866256"><span class="hs-identifier hs-type">ann</span></a></span></span><span> </span><span id="local-6989586621681866257"><span class="annot"><a href="#local-6989586621681866257"><span class="hs-identifier hs-type">s</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#GivenCekRuntime"><span class="hs-identifier hs-type">GivenCekRuntime</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681866254"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681866255"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681866256"><span class="hs-identifier hs-type">ann</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#GivenCekEmitter"><span class="hs-identifier hs-type">GivenCekEmitter</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681866254"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681866255"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681866257"><span class="hs-identifier hs-type">s</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#GivenCekSpender"><span class="hs-identifier hs-type">GivenCekSpender</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681866254"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681866255"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681866257"><span class="hs-identifier hs-type">s</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#GivenCekSlippage"><span class="hs-identifier hs-type">GivenCekSlippage</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#GivenCekStepCounter"><span class="hs-identifier hs-type">GivenCekStepCounter</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681866257"><span class="hs-identifier hs-type">s</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#GivenCekCosts"><span class="hs-identifier hs-type">GivenCekCosts</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-406"></span><span>
</span><span id="line-407"></span><span class="hs-keyword">data</span><span> </span><span id="CekUserError"><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#CekUserError"><span class="hs-identifier hs-var">CekUserError</span></a></span></span><span>
</span><span id="line-408"></span><span>    </span><span class="hs-glyph">=</span><span> </span><span id="CekOutOfExError"><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#CekOutOfExError"><span class="hs-identifier hs-var">CekOutOfExError</span></a></span></span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="PlutusCore.Evaluation.Machine.ExBudget.html#ExRestrictingBudget"><span class="hs-identifier hs-type">ExRestrictingBudget</span></a></span><span> </span><span class="annot"><span class="hs-comment">-- ^ The final overspent (i.e. negative) budget.</span></span><span>
</span><span id="line-409"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span id="CekEvaluationFailure"><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#CekEvaluationFailure"><span class="hs-identifier hs-var">CekEvaluationFailure</span></a></span></span><span> </span><span class="annot"><span class="hs-comment">-- ^ Error has been called or a builtin application has failed</span></span><span>
</span><span id="line-410"></span><span>    </span><span class="hs-keyword">deriving</span><span> </span><span class="annot"><span class="hs-keyword">stock</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621681866261"><span id="local-6989586621681866266"><span id="local-6989586621681866270"><span class="annot"><span class="annottext">Int -&gt; CekUserError -&gt; ShowS
[CekUserError] -&gt; ShowS
CekUserError -&gt; String
(Int -&gt; CekUserError -&gt; ShowS)
-&gt; (CekUserError -&gt; String)
-&gt; ([CekUserError] -&gt; ShowS)
-&gt; Show CekUserError
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
$cshowsPrec :: Int -&gt; CekUserError -&gt; ShowS
showsPrec :: Int -&gt; CekUserError -&gt; ShowS
$cshow :: CekUserError -&gt; String
show :: CekUserError -&gt; String
$cshowList :: [CekUserError] -&gt; ShowS
showList :: [CekUserError] -&gt; ShowS
</span><a href="../../../ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Show.html#Show"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></a></span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681866273"><span id="local-6989586621681866277"><span class="annot"><span class="annottext">CekUserError -&gt; CekUserError -&gt; Bool
(CekUserError -&gt; CekUserError -&gt; Bool)
-&gt; (CekUserError -&gt; CekUserError -&gt; Bool) -&gt; Eq CekUserError
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
$c== :: CekUserError -&gt; CekUserError -&gt; Bool
== :: CekUserError -&gt; CekUserError -&gt; Bool
$c/= :: CekUserError -&gt; CekUserError -&gt; Bool
/= :: CekUserError -&gt; CekUserError -&gt; Bool
</span><a href="../../../ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#Eq"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></a></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681866281"><span id="local-6989586621681866283"><span class="annot"><span class="annottext">(forall x. CekUserError -&gt; Rep CekUserError x)
-&gt; (forall x. Rep CekUserError x -&gt; CekUserError)
-&gt; Generic CekUserError
forall x. Rep CekUserError x -&gt; CekUserError
forall x. CekUserError -&gt; Rep CekUserError x
forall a.
(forall x. a -&gt; Rep a x) -&gt; (forall x. Rep a x -&gt; a) -&gt; Generic a
$cfrom :: forall x. CekUserError -&gt; Rep CekUserError x
from :: forall x. CekUserError -&gt; Rep CekUserError x
$cto :: forall x. Rep CekUserError x -&gt; CekUserError
to :: forall x. Rep CekUserError x -&gt; CekUserError
</span><a href="../../../ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Generics.html#Generic"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Generic</span></a></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-411"></span><span>    </span><span class="hs-keyword">deriving</span><span> </span><span class="annot"><span class="hs-keyword">anyclass</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621681866286"><span class="annot"><span class="annottext">CekUserError -&gt; ()
(CekUserError -&gt; ()) -&gt; NFData CekUserError
forall a. (a -&gt; ()) -&gt; NFData a
$crnf :: CekUserError -&gt; ()
rnf :: CekUserError -&gt; ()
</span><a href="../../../ghc-9.6.6/html/libraries/deepseq-1.4.8.1/src/Control.DeepSeq.html#NFData"><span class="hs-identifier hs-var hs-var hs-var hs-var">NFData</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-412"></span><span>
</span><span id="line-413"></span><span class="hs-keyword">type</span><span> </span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#CekM"><span class="hs-identifier hs-type">CekM</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Type"><span class="hs-identifier hs-type">GHC.Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Type"><span class="hs-identifier hs-type">GHC.Type</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Type"><span class="hs-identifier hs-type">GHC.Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Type"><span class="hs-identifier hs-type">GHC.Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Type"><span class="hs-identifier hs-type">GHC.Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Type"><span class="hs-identifier hs-type">GHC.Type</span></a></span><span>
</span><span id="line-414"></span><span class="annot"><span class="hs-comment">-- | The monad the CEK machine runs in.</span></span><span>
</span><span id="line-415"></span><span class="hs-keyword">newtype</span><span> </span><span id="CekM"><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#CekM"><span class="hs-identifier hs-var">CekM</span></a></span></span><span> </span><span id="local-6989586621681865393"><span class="annot"><a href="#local-6989586621681865393"><span class="hs-identifier hs-type">uni</span></a></span></span><span> </span><span id="local-6989586621681865394"><span class="annot"><a href="#local-6989586621681865394"><span class="hs-identifier hs-type">fun</span></a></span></span><span> </span><span id="local-6989586621681865395"><span class="annot"><a href="#local-6989586621681865395"><span class="hs-identifier hs-type">s</span></a></span></span><span> </span><span id="local-6989586621681865396"><span class="annot"><a href="#local-6989586621681865396"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="CekM"><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#CekM"><span class="hs-identifier hs-var">CekM</span></a></span></span><span>
</span><span id="line-416"></span><span>    </span><span class="hs-special">{</span><span> </span><span id="unCekM"><span class="annot"><span class="annottext">forall (uni :: * -&gt; *) fun s a. CekM uni fun s a -&gt; ST s a
</span><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#unCekM"><span class="hs-identifier hs-var hs-var">unCekM</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.ST.html#ST"><span class="hs-identifier hs-type">ST</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865395"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865396"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-417"></span><span>    </span><span class="hs-special">}</span><span> </span><span class="hs-keyword">deriving</span><span> </span><span class="annot"><span class="hs-keyword">newtype</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621681866303"><span id="local-6989586621681866308"><span class="annot"><span class="annottext">(forall a b. (a -&gt; b) -&gt; CekM uni fun s a -&gt; CekM uni fun s b)
-&gt; (forall a b. a -&gt; CekM uni fun s b -&gt; CekM uni fun s a)
-&gt; Functor (CekM uni fun s)
forall a b. a -&gt; CekM uni fun s b -&gt; CekM uni fun s a
forall a b. (a -&gt; b) -&gt; CekM uni fun s a -&gt; CekM uni fun s b
forall (f :: * -&gt; *).
(forall a b. (a -&gt; b) -&gt; f a -&gt; f b)
-&gt; (forall a b. a -&gt; f b -&gt; f a) -&gt; Functor f
forall (uni :: * -&gt; *) fun s a b.
a -&gt; CekM uni fun s b -&gt; CekM uni fun s a
forall (uni :: * -&gt; *) fun s a b.
(a -&gt; b) -&gt; CekM uni fun s a -&gt; CekM uni fun s b
$cfmap :: forall (uni :: * -&gt; *) fun s a b.
(a -&gt; b) -&gt; CekM uni fun s a -&gt; CekM uni fun s b
fmap :: forall a b. (a -&gt; b) -&gt; CekM uni fun s a -&gt; CekM uni fun s b
$c&lt;$ :: forall (uni :: * -&gt; *) fun s a b.
a -&gt; CekM uni fun s b -&gt; CekM uni fun s a
&lt;$ :: forall a b. a -&gt; CekM uni fun s b -&gt; CekM uni fun s a
</span><a href="../../../ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#Functor"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Functor</span></a></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681866316"><span id="local-6989586621681866321"><span id="local-6989586621681866325"><span id="local-6989586621681866329"><span id="local-6989586621681866333"><span class="annot"><span class="annottext">Functor (CekM uni fun s)
Functor (CekM uni fun s) =&gt;
(forall a. a -&gt; CekM uni fun s a)
-&gt; (forall a b.
    CekM uni fun s (a -&gt; b) -&gt; CekM uni fun s a -&gt; CekM uni fun s b)
-&gt; (forall a b c.
    (a -&gt; b -&gt; c)
    -&gt; CekM uni fun s a -&gt; CekM uni fun s b -&gt; CekM uni fun s c)
-&gt; (forall a b.
    CekM uni fun s a -&gt; CekM uni fun s b -&gt; CekM uni fun s b)
-&gt; (forall a b.
    CekM uni fun s a -&gt; CekM uni fun s b -&gt; CekM uni fun s a)
-&gt; Applicative (CekM uni fun s)
forall a. a -&gt; CekM uni fun s a
forall a b.
CekM uni fun s a -&gt; CekM uni fun s b -&gt; CekM uni fun s a
forall a b.
CekM uni fun s a -&gt; CekM uni fun s b -&gt; CekM uni fun s b
forall a b.
CekM uni fun s (a -&gt; b) -&gt; CekM uni fun s a -&gt; CekM uni fun s b
forall a b c.
(a -&gt; b -&gt; c)
-&gt; CekM uni fun s a -&gt; CekM uni fun s b -&gt; CekM uni fun s c
forall (f :: * -&gt; *).
Functor f =&gt;
(forall a. a -&gt; f a)
-&gt; (forall a b. f (a -&gt; b) -&gt; f a -&gt; f b)
-&gt; (forall a b c. (a -&gt; b -&gt; c) -&gt; f a -&gt; f b -&gt; f c)
-&gt; (forall a b. f a -&gt; f b -&gt; f b)
-&gt; (forall a b. f a -&gt; f b -&gt; f a)
-&gt; Applicative f
forall (uni :: * -&gt; *) fun s. Functor (CekM uni fun s)
forall (uni :: * -&gt; *) fun s a. a -&gt; CekM uni fun s a
forall (uni :: * -&gt; *) fun s a b.
CekM uni fun s a -&gt; CekM uni fun s b -&gt; CekM uni fun s a
forall (uni :: * -&gt; *) fun s a b.
CekM uni fun s a -&gt; CekM uni fun s b -&gt; CekM uni fun s b
forall (uni :: * -&gt; *) fun s a b.
CekM uni fun s (a -&gt; b) -&gt; CekM uni fun s a -&gt; CekM uni fun s b
forall (uni :: * -&gt; *) fun s a b c.
(a -&gt; b -&gt; c)
-&gt; CekM uni fun s a -&gt; CekM uni fun s b -&gt; CekM uni fun s c
$cpure :: forall (uni :: * -&gt; *) fun s a. a -&gt; CekM uni fun s a
pure :: forall a. a -&gt; CekM uni fun s a
$c&lt;*&gt; :: forall (uni :: * -&gt; *) fun s a b.
CekM uni fun s (a -&gt; b) -&gt; CekM uni fun s a -&gt; CekM uni fun s b
&lt;*&gt; :: forall a b.
CekM uni fun s (a -&gt; b) -&gt; CekM uni fun s a -&gt; CekM uni fun s b
$cliftA2 :: forall (uni :: * -&gt; *) fun s a b c.
(a -&gt; b -&gt; c)
-&gt; CekM uni fun s a -&gt; CekM uni fun s b -&gt; CekM uni fun s c
liftA2 :: forall a b c.
(a -&gt; b -&gt; c)
-&gt; CekM uni fun s a -&gt; CekM uni fun s b -&gt; CekM uni fun s c
$c*&gt; :: forall (uni :: * -&gt; *) fun s a b.
CekM uni fun s a -&gt; CekM uni fun s b -&gt; CekM uni fun s b
*&gt; :: forall a b.
CekM uni fun s a -&gt; CekM uni fun s b -&gt; CekM uni fun s b
$c&lt;* :: forall (uni :: * -&gt; *) fun s a b.
CekM uni fun s a -&gt; CekM uni fun s b -&gt; CekM uni fun s a
&lt;* :: forall a b.
CekM uni fun s a -&gt; CekM uni fun s b -&gt; CekM uni fun s a
</span><a href="../../../ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#Applicative"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Applicative</span></a></span></span></span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681866341"><span id="local-6989586621681866346"><span id="local-6989586621681866350"><span class="annot"><span class="annottext">Applicative (CekM uni fun s)
Applicative (CekM uni fun s) =&gt;
(forall a b.
 CekM uni fun s a -&gt; (a -&gt; CekM uni fun s b) -&gt; CekM uni fun s b)
-&gt; (forall a b.
    CekM uni fun s a -&gt; CekM uni fun s b -&gt; CekM uni fun s b)
-&gt; (forall a. a -&gt; CekM uni fun s a)
-&gt; Monad (CekM uni fun s)
forall a. a -&gt; CekM uni fun s a
forall a b.
CekM uni fun s a -&gt; CekM uni fun s b -&gt; CekM uni fun s b
forall a b.
CekM uni fun s a -&gt; (a -&gt; CekM uni fun s b) -&gt; CekM uni fun s b
forall (m :: * -&gt; *).
Applicative m =&gt;
(forall a b. m a -&gt; (a -&gt; m b) -&gt; m b)
-&gt; (forall a b. m a -&gt; m b -&gt; m b)
-&gt; (forall a. a -&gt; m a)
-&gt; Monad m
forall (uni :: * -&gt; *) fun s. Applicative (CekM uni fun s)
forall (uni :: * -&gt; *) fun s a. a -&gt; CekM uni fun s a
forall (uni :: * -&gt; *) fun s a b.
CekM uni fun s a -&gt; CekM uni fun s b -&gt; CekM uni fun s b
forall (uni :: * -&gt; *) fun s a b.
CekM uni fun s a -&gt; (a -&gt; CekM uni fun s b) -&gt; CekM uni fun s b
$c&gt;&gt;= :: forall (uni :: * -&gt; *) fun s a b.
CekM uni fun s a -&gt; (a -&gt; CekM uni fun s b) -&gt; CekM uni fun s b
&gt;&gt;= :: forall a b.
CekM uni fun s a -&gt; (a -&gt; CekM uni fun s b) -&gt; CekM uni fun s b
$c&gt;&gt; :: forall (uni :: * -&gt; *) fun s a b.
CekM uni fun s a -&gt; CekM uni fun s b -&gt; CekM uni fun s b
&gt;&gt; :: forall a b.
CekM uni fun s a -&gt; CekM uni fun s b -&gt; CekM uni fun s b
$creturn :: forall (uni :: * -&gt; *) fun s a. a -&gt; CekM uni fun s a
return :: forall a. a -&gt; CekM uni fun s a
</span><a href="../../../ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#Monad"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Monad</span></a></span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681866358"><span class="annot"><span class="annottext">Monad (CekM uni fun s)
Monad (CekM uni fun s) =&gt;
(forall a.
 (State# (PrimState (CekM uni fun s))
  -&gt; (# State# (PrimState (CekM uni fun s)), a #))
 -&gt; CekM uni fun s a)
-&gt; PrimMonad (CekM uni fun s)
forall a.
(State# (PrimState (CekM uni fun s))
 -&gt; (# State# (PrimState (CekM uni fun s)), a #))
-&gt; CekM uni fun s a
forall (m :: * -&gt; *).
Monad m =&gt;
(forall a.
 (State# (PrimState m) -&gt; (# State# (PrimState m), a #)) -&gt; m a)
-&gt; PrimMonad m
forall (uni :: * -&gt; *) fun s. Monad (CekM uni fun s)
forall (uni :: * -&gt; *) fun s a.
(State# (PrimState (CekM uni fun s))
 -&gt; (# State# (PrimState (CekM uni fun s)), a #))
-&gt; CekM uni fun s a
$cprimitive :: forall (uni :: * -&gt; *) fun s a.
(State# (PrimState (CekM uni fun s))
 -&gt; (# State# (PrimState (CekM uni fun s)), a #))
-&gt; CekM uni fun s a
primitive :: forall a.
(State# (PrimState (CekM uni fun s))
 -&gt; (# State# (PrimState (CekM uni fun s)), a #))
-&gt; CekM uni fun s a
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var">PrimMonad</span></span></span><span class="hs-special">)</span><span>
</span><span id="line-418"></span><span>
</span><span id="line-419"></span><span class="annot"><span class="hs-comment">-- | The CEK machine-specific 'EvaluationException'.</span></span><span>
</span><span id="line-420"></span><span class="hs-keyword">type</span><span> </span><span id="CekEvaluationException"><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#CekEvaluationException"><span class="hs-identifier hs-var">CekEvaluationException</span></a></span></span><span> </span><span id="local-6989586621681866366"><span class="annot"><a href="#local-6989586621681866366"><span class="hs-identifier hs-type">name</span></a></span></span><span> </span><span id="local-6989586621681866367"><span class="annot"><a href="#local-6989586621681866367"><span class="hs-identifier hs-type">uni</span></a></span></span><span> </span><span id="local-6989586621681866368"><span class="annot"><a href="#local-6989586621681866368"><span class="hs-identifier hs-type">fun</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-421"></span><span>    </span><span class="annot"><a href="PlutusCore.Evaluation.Machine.Exception.html#EvaluationException"><span class="hs-identifier hs-type">EvaluationException</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PlutusCore.Evaluation.Machine.Exception.html#MachineError"><span class="hs-identifier hs-type">MachineError</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681866368"><span class="hs-identifier hs-type">fun</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#CekUserError"><span class="hs-identifier hs-type">CekUserError</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="UntypedPlutusCore.Core.Type.html#Term"><span class="hs-identifier hs-type">Term</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681866366"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681866367"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681866368"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-422"></span><span>
</span><span id="line-423"></span><span class="hs-comment">{- Note [Throwing exceptions in ST]
This note represents MPJ's best understanding right now, might be wrong.

We use a moderately evil trick to throw exceptions in ST, but unlike the evil trick for catching them, it's hidden.

The evil is that the 'MonadThrow' instance for 'ST' uses 'unsafeIOToST . throwIO'! Sneaky! The author has marked it
&quot;Trustworthy&quot;, no less. However, I believe this to be safe for basically the same reasons as our trick to catch
exceptions is safe, see Note [Catching exceptions in ST]
-}</span><span>
</span><span id="line-432"></span><span>
</span><span id="line-433"></span><span class="hs-comment">{- Note [Catching exceptions in ST]
This note represents MPJ's best understanding right now, might be wrong.

We use a moderately evil trick to catch exceptions in ST. This uses the unsafe ST &lt;-&gt; IO conversion functions to go into IO,
catch the exception, and then go back into ST.

Why is this okay? Recall that IO ~= ST RealWorld, i.e. it is just ST with a special thread token. The unsafe conversion functions
just coerce from one to the other. So the thread token remains the same, it's just that we'll potentially leak it from ST, and we don't
get ordering guarantees with other IO actions.

But in our case this is okay, because:

1. We do not leak the original ST thread token, since we only pass it into IO and then immediately back again.
2. We don't have ordering guarantees with other IO actions, but we don't care because we don't do any side effects, we only catch a single kind of exception.
3. We *do* have ordering guarantees between the throws inside the ST action and the catch, since they are ultimately using the same thread token.
-}</span><span>
</span><span id="line-449"></span><span>
</span><span id="line-450"></span><span class="hs-comment">-- | Call 'dischargeCekValue' over the received 'CekVal' and feed the resulting 'Term' to</span><span>
</span><span id="line-451"></span><span class="hs-comment">-- 'throwingWithCause' as the cause of the failure.</span><span>
</span><span id="line-452"></span><span id="local-6989586621681865475"><span id="local-6989586621681865476"><span id="local-6989586621681865480"><span id="local-6989586621681865482"><span id="local-6989586621681865483"><span id="local-6989586621681865484"><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#throwingDischarged"><span class="hs-identifier hs-type">throwingDischarged</span></a></span><span>
</span><span id="line-453"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="PlutusCore.Pretty.PrettyConst.html#ThrowableBuiltins"><span class="hs-identifier hs-type">ThrowableBuiltins</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865475"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865476"><span class="hs-identifier hs-type">fun</span></a></span><span>
</span><span id="line-454"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">AReview</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PlutusCore.Evaluation.Error.html#EvaluationError"><span class="hs-identifier hs-type">EvaluationError</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PlutusCore.Evaluation.Machine.Exception.html#MachineError"><span class="hs-identifier hs-type">MachineError</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865476"><span class="hs-identifier hs-type">fun</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#CekUserError"><span class="hs-identifier hs-type">CekUserError</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621681865480"><span class="hs-identifier hs-type">t</span></a></span><span>
</span><span id="line-455"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621681865480"><span class="hs-identifier hs-type">t</span></a></span><span>
</span><span id="line-456"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#CekValue"><span class="hs-identifier hs-type">CekValue</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865475"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865476"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865482"><span class="hs-identifier hs-type">ann</span></a></span><span>
</span><span id="line-457"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#CekM"><span class="hs-identifier hs-type">CekM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865475"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865476"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865483"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865484"><span class="hs-identifier hs-type">x</span></a></span></span></span></span></span></span></span><span>
</span><span id="line-458"></span><span id="throwingDischarged"><span class="annot"><span class="annottext">throwingDischarged :: forall (uni :: * -&gt; *) fun t ann s x.
ThrowableBuiltins uni fun =&gt;
AReview (EvaluationError (MachineError fun) CekUserError) t
-&gt; t -&gt; CekValue uni fun ann -&gt; CekM uni fun s x
</span><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#throwingDischarged"><span class="hs-identifier hs-var hs-var">throwingDischarged</span></a></span></span><span> </span><span id="local-6989586621681866375"><span class="annot"><span class="annottext">AReview (EvaluationError (MachineError fun) CekUserError) t
</span><a href="#local-6989586621681866375"><span class="hs-identifier hs-var">l</span></a></span></span><span> </span><span id="local-6989586621681866376"><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621681866376"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AReview (EvaluationError (MachineError fun) CekUserError) t
-&gt; t -&gt; Maybe (NTerm uni fun ()) -&gt; CekM uni fun s x
forall exc e t term (m :: * -&gt; *) x.
(exc ~ ErrorWithCause e term, MonadError exc m) =&gt;
AReview e t -&gt; t -&gt; Maybe term -&gt; m x
</span><a href="PlutusCore.Evaluation.ErrorWithCause.html#throwingWithCause"><span class="hs-identifier hs-var">throwingWithCause</span></a></span><span> </span><span class="annot"><span class="annottext">AReview (EvaluationError (MachineError fun) CekUserError) t
</span><a href="#local-6989586621681866375"><span class="hs-identifier hs-var">l</span></a></span><span> </span><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621681866376"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe (NTerm uni fun ()) -&gt; CekM uni fun s x)
-&gt; (CekValue uni fun ann -&gt; Maybe (NTerm uni fun ()))
-&gt; CekValue uni fun ann
-&gt; CekM uni fun s x
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">NTerm uni fun () -&gt; Maybe (NTerm uni fun ())
forall a. a -&gt; Maybe a
</span><a href="../../../ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">(NTerm uni fun () -&gt; Maybe (NTerm uni fun ()))
-&gt; (CekValue uni fun ann -&gt; NTerm uni fun ())
-&gt; CekValue uni fun ann
-&gt; Maybe (NTerm uni fun ())
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">CekValue uni fun ann -&gt; NTerm uni fun ()
forall (uni :: * -&gt; *) fun ann.
CekValue uni fun ann -&gt; NTerm uni fun ()
</span><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#dischargeCekValue"><span class="hs-identifier hs-var">dischargeCekValue</span></a></span><span>
</span><span id="line-459"></span><span>
</span><span id="line-460"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621681865490"><span id="local-6989586621681865491"><span id="local-6989586621681865493"><span class="annot"><a href="PlutusCore.Pretty.PrettyConst.html#ThrowableBuiltins"><span class="hs-identifier hs-type">ThrowableBuiltins</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865490"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865491"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="../../../ghc-9.6.6/html/libraries/mtl-2.3.1/src/Control.Monad.Error.Class.html#MonadError"><span class="hs-identifier hs-type">MonadError</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#CekEvaluationException"><span class="hs-identifier hs-type">CekEvaluationException</span></a></span><span> </span><span class="annot"><a href="PlutusCore.DeBruijn.Internal.html#NamedDeBruijn"><span class="hs-identifier hs-type">NamedDeBruijn</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865490"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865491"><span class="hs-identifier hs-type">fun</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#CekM"><span class="hs-identifier hs-type">CekM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865490"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865491"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865493"><span class="hs-identifier hs-type">s</span></a></span><span class="hs-special">)</span></span></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-461"></span><span>    </span><span class="hs-comment">-- See Note [Throwing exceptions in ST].</span><span>
</span><span id="line-462"></span><span>    </span><span id="local-6989586621681866436"><span class="annot"><span class="annottext">throwError :: forall a.
CekEvaluationException NamedDeBruijn uni fun -&gt; CekM uni fun s a
</span><a href="../../../ghc-9.6.6/html/libraries/mtl-2.3.1/src/Control.Monad.Error.Class.html#throwError"><span class="hs-identifier hs-var hs-var hs-var hs-var">throwError</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ST s a -&gt; CekM uni fun s a
forall (uni :: * -&gt; *) fun s a. ST s a -&gt; CekM uni fun s a
</span><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#CekM"><span class="hs-identifier hs-var">CekM</span></a></span><span> </span><span class="annot"><span class="annottext">(ST s a -&gt; CekM uni fun s a)
-&gt; (CekEvaluationException NamedDeBruijn uni fun -&gt; ST s a)
-&gt; CekEvaluationException NamedDeBruijn uni fun
-&gt; CekM uni fun s a
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">CekEvaluationException NamedDeBruijn uni fun -&gt; ST s a
forall e a. (HasCallStack, Exception e) =&gt; e -&gt; ST s a
forall (m :: * -&gt; *) e a.
(MonadThrow m, HasCallStack, Exception e) =&gt;
e -&gt; m a
</span><a href="../../../ghc-9.6.6/html/libraries/exceptions-0.10.7/src/Control.Monad.Catch.html#throwM"><span class="hs-identifier hs-var">throwM</span></a></span><span>
</span><span id="line-463"></span><span>
</span><span id="line-464"></span><span>    </span><span class="hs-comment">-- See Note [Catching exceptions in ST].</span><span>
</span><span id="line-465"></span><span>    </span><span id="local-6989586621681866475"><span class="annot"><span class="annottext">CekM uni fun s a
</span><a href="#local-6989586621681866475"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span id="local-6989586621681866476"><span class="annot"><span class="annottext">catchError :: forall a.
CekM uni fun s a
-&gt; (CekEvaluationException NamedDeBruijn uni fun
    -&gt; CekM uni fun s a)
-&gt; CekM uni fun s a
</span><a href="../../../ghc-9.6.6/html/libraries/mtl-2.3.1/src/Control.Monad.Error.Class.html#catchError"><span class="hs-operator hs-var hs-var hs-var hs-var">`catchError`</span></a></span></span><span> </span><span id="local-6989586621681866477"><span class="annot"><span class="annottext">CekEvaluationException NamedDeBruijn uni fun -&gt; CekM uni fun s a
</span><a href="#local-6989586621681866477"><span class="hs-identifier hs-var">h</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ST s a -&gt; CekM uni fun s a
forall (uni :: * -&gt; *) fun s a. ST s a -&gt; CekM uni fun s a
</span><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#CekM"><span class="hs-identifier hs-var">CekM</span></a></span><span> </span><span class="annot"><span class="annottext">(ST s a -&gt; CekM uni fun s a)
-&gt; (IO a -&gt; ST s a) -&gt; IO a -&gt; CekM uni fun s a
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">IO a -&gt; ST s a
forall a s. IO a -&gt; ST s a
</span><a href="../../../ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.IO.html#unsafeIOToST"><span class="hs-identifier hs-var">unsafeIOToST</span></a></span><span> </span><span class="annot"><span class="annottext">(IO a -&gt; CekM uni fun s a) -&gt; IO a -&gt; CekM uni fun s a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">IO a
</span><a href="#local-6989586621681866479"><span class="hs-identifier hs-var">aIO</span></a></span><span> </span><span class="annot"><span class="annottext">IO a
-&gt; (CekEvaluationException NamedDeBruijn uni fun -&gt; IO a) -&gt; IO a
forall e a.
(HasCallStack, Exception e) =&gt;
IO a -&gt; (e -&gt; IO a) -&gt; IO a
forall (m :: * -&gt; *) e a.
(MonadCatch m, HasCallStack, Exception e) =&gt;
m a -&gt; (e -&gt; m a) -&gt; m a
</span><a href="../../../ghc-9.6.6/html/libraries/exceptions-0.10.7/src/Control.Monad.Catch.html#catch"><span class="hs-operator hs-var">`catch`</span></a></span><span> </span><span class="annot"><span class="annottext">CekEvaluationException NamedDeBruijn uni fun -&gt; IO a
</span><a href="#local-6989586621681866481"><span class="hs-identifier hs-var">hIO</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-466"></span><span>        </span><span id="local-6989586621681866479"><span class="annot"><span class="annottext">aIO :: IO a
</span><a href="#local-6989586621681866479"><span class="hs-identifier hs-var hs-var">aIO</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CekM uni fun s a -&gt; IO a
forall a. CekM uni fun s a -&gt; IO a
</span><a href="#local-6989586621681866482"><span class="hs-identifier hs-var">unsafeRunCekM</span></a></span><span> </span><span class="annot"><span class="annottext">CekM uni fun s a
</span><a href="#local-6989586621681866475"><span class="hs-identifier hs-var">a</span></a></span><span>
</span><span id="line-467"></span><span>        </span><span id="local-6989586621681866481"><span class="annot"><span class="annottext">hIO :: CekEvaluationException NamedDeBruijn uni fun -&gt; IO a
</span><a href="#local-6989586621681866481"><span class="hs-identifier hs-var hs-var">hIO</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CekM uni fun s a -&gt; IO a
forall a. CekM uni fun s a -&gt; IO a
</span><a href="#local-6989586621681866482"><span class="hs-identifier hs-var">unsafeRunCekM</span></a></span><span> </span><span class="annot"><span class="annottext">(CekM uni fun s a -&gt; IO a)
-&gt; (CekEvaluationException NamedDeBruijn uni fun
    -&gt; CekM uni fun s a)
-&gt; CekEvaluationException NamedDeBruijn uni fun
-&gt; IO a
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">CekEvaluationException NamedDeBruijn uni fun -&gt; CekM uni fun s a
</span><a href="#local-6989586621681866477"><span class="hs-identifier hs-var">h</span></a></span><span>
</span><span id="line-468"></span><span>
</span><span id="line-469"></span><span>        </span><span class="hs-comment">-- | Unsafely run a 'CekM' computation in the 'IO' monad by converting the</span><span>
</span><span id="line-470"></span><span>        </span><span class="hs-comment">-- underlying 'ST' to it.</span><span>
</span><span id="line-471"></span><span>        </span><span id="local-6989586621681865570"><span class="annot"><a href="#local-6989586621681866482"><span class="hs-identifier hs-type">unsafeRunCekM</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#CekM"><span class="hs-identifier hs-type">CekM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865490"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865491"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865493"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865570"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865570"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-472"></span><span>        </span><span id="local-6989586621681866482"><span class="annot"><span class="annottext">unsafeRunCekM :: forall a. CekM uni fun s a -&gt; IO a
</span><a href="#local-6989586621681866482"><span class="hs-identifier hs-var hs-var">unsafeRunCekM</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ST s a -&gt; IO a
forall s a. ST s a -&gt; IO a
</span><a href="../../../ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.IO.html#unsafeSTToIO"><span class="hs-identifier hs-var">unsafeSTToIO</span></a></span><span> </span><span class="annot"><span class="annottext">(ST s a -&gt; IO a)
-&gt; (CekM uni fun s a -&gt; ST s a) -&gt; CekM uni fun s a -&gt; IO a
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">CekM uni fun s a -&gt; ST s a
forall (uni :: * -&gt; *) fun s a. CekM uni fun s a -&gt; ST s a
</span><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#unCekM"><span class="hs-identifier hs-var">unCekM</span></a></span><span>
</span><span id="line-473"></span><span>
</span><span id="line-474"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="PlutusCore.Evaluation.Result.html#AsEvaluationFailure"><span class="hs-identifier hs-type">AsEvaluationFailure</span></a></span><span> </span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#CekUserError"><span class="hs-identifier hs-type">CekUserError</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-475"></span><span>    </span><span id="local-6989586621681866492"><span class="annot"><span class="annottext">_EvaluationFailure :: Prism' CekUserError ()
</span><a href="#local-6989586621681866492"><span class="hs-identifier hs-var hs-var hs-var hs-var">_EvaluationFailure</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CekUserError -&gt; Prism' CekUserError ()
forall err. Eq err =&gt; err -&gt; Prism' err ()
</span><a href="PlutusCore.Evaluation.Result.html#_EvaluationFailureVia"><span class="hs-identifier hs-var">_EvaluationFailureVia</span></a></span><span> </span><span class="annot"><span class="annottext">CekUserError
</span><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#CekEvaluationFailure"><span class="hs-identifier hs-var">CekEvaluationFailure</span></a></span><span>
</span><span id="line-476"></span><span>
</span><span id="line-477"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621681866497"><span class="annot"><a href="PlutusCore.Builtin.Result.html#AsUnliftingError"><span class="hs-identifier hs-type">AsUnliftingError</span></a></span><span> </span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#CekUserError"><span class="hs-identifier hs-type">CekUserError</span></a></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-478"></span><span>    </span><span id="local-6989586621681866510"><span class="annot"><span class="annottext">_UnliftingError :: Prism' CekUserError UnliftingError
</span><a href="#local-6989586621681866510"><span class="hs-identifier hs-var hs-var hs-var hs-var">_UnliftingError</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CekUserError -&gt; Prism' CekUserError UnliftingError
forall err. Pretty err =&gt; err -&gt; Prism' err UnliftingError
</span><a href="PlutusCore.Builtin.Result.html#_UnliftingErrorVia"><span class="hs-identifier hs-var">_UnliftingErrorVia</span></a></span><span> </span><span class="annot"><span class="annottext">CekUserError
</span><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#CekEvaluationFailure"><span class="hs-identifier hs-var">CekEvaluationFailure</span></a></span><span>
</span><span id="line-479"></span><span>
</span><span id="line-480"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621681866515"><span class="annot"><span class="hs-identifier hs-type">Pretty</span></span><span> </span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#CekUserError"><span class="hs-identifier hs-type">CekUserError</span></a></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-481"></span><span>    </span><span id="local-6989586621681866524"><span class="annot"><span class="annottext">pretty :: forall ann. CekUserError -&gt; Doc ann
</span><span class="hs-identifier hs-var hs-var hs-var hs-var">pretty</span></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#CekOutOfExError"><span class="hs-identifier hs-type">CekOutOfExError</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PlutusCore.Evaluation.Machine.ExBudget.html#ExRestrictingBudget"><span class="hs-identifier hs-type">ExRestrictingBudget</span></a></span><span> </span><span id="local-6989586621681866526"><span class="annot"><span class="annottext">ExBudget
</span><a href="#local-6989586621681866526"><span class="hs-identifier hs-var">res</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-482"></span><span>        </span><span class="annot"><span class="annottext">[Doc ann] -&gt; Doc ann
forall ann. [Doc ann] -&gt; Doc ann
</span><span class="hs-identifier hs-var">cat</span></span><span>
</span><span id="line-483"></span><span>          </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">Doc ann
</span><span class="hs-string">&quot;The machine terminated part way through evaluation due to overspending the budget.&quot;</span></span><span>
</span><span id="line-484"></span><span>          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Doc ann
</span><span class="hs-string">&quot;The budget when the machine terminated was:&quot;</span></span><span>
</span><span id="line-485"></span><span>          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ExBudget -&gt; Doc ann
forall a ann. Pretty a =&gt; a -&gt; Doc ann
forall ann. ExBudget -&gt; Doc ann
</span><span class="hs-identifier hs-var">pretty</span></span><span> </span><span class="annot"><span class="annottext">ExBudget
</span><a href="#local-6989586621681866526"><span class="hs-identifier hs-var">res</span></a></span><span>
</span><span id="line-486"></span><span>          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Doc ann
</span><span class="hs-string">&quot;Negative numbers indicate the overspent budget; note that this only indicates the budget that was needed for the next step, not to run the program to completion.&quot;</span></span><span>
</span><span id="line-487"></span><span>          </span><span class="hs-special">]</span><span>
</span><span id="line-488"></span><span>    </span><span class="annot"><span class="hs-identifier hs-var">pretty</span></span><span> </span><span class="annot"><span class="annottext">CekUserError
</span><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#CekEvaluationFailure"><span class="hs-identifier hs-var">CekEvaluationFailure</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Doc ann
</span><span class="hs-string">&quot;The machine terminated because of an error, either from a built-in function or from an explicit use of 'error'.&quot;</span></span><span>
</span><span id="line-489"></span><span>
</span><span id="line-490"></span><span class="hs-comment">-- | Instantiate all the free variables of a term by looking them up in an environment.</span><span>
</span><span id="line-491"></span><span class="hs-comment">-- Mutually recursive with dischargeCekVal.</span><span>
</span><span id="line-492"></span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#dischargeCekValEnv"><span class="hs-identifier hs-type">dischargeCekValEnv</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621681865592"><span class="annot"><a href="#local-6989586621681865592"><span class="hs-identifier hs-type">uni</span></a></span></span><span> </span><span id="local-6989586621681865593"><span class="annot"><a href="#local-6989586621681865593"><span class="hs-identifier hs-type">fun</span></a></span></span><span> </span><span id="local-6989586621681865594"><span class="annot"><a href="#local-6989586621681865594"><span class="hs-identifier hs-type">ann</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#CekValEnv"><span class="hs-identifier hs-type">CekValEnv</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865592"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865593"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865594"><span class="hs-identifier hs-type">ann</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#NTerm"><span class="hs-identifier hs-type">NTerm</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865592"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865593"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#NTerm"><span class="hs-identifier hs-type">NTerm</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865592"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865593"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-493"></span><span id="dischargeCekValEnv"><span class="annot"><span class="annottext">dischargeCekValEnv :: forall (uni :: * -&gt; *) fun ann.
CekValEnv uni fun ann -&gt; NTerm uni fun () -&gt; NTerm uni fun ()
</span><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#dischargeCekValEnv"><span class="hs-identifier hs-var hs-var">dischargeCekValEnv</span></a></span></span><span> </span><span id="local-6989586621681866539"><span class="annot"><span class="annottext">CekValEnv uni fun ann
</span><a href="#local-6989586621681866539"><span class="hs-identifier hs-var">valEnv</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; NTerm uni fun () -&gt; NTerm uni fun ()
</span><a href="#local-6989586621681866540"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><span class="hs-number">0</span></span><span>
</span><span id="line-494"></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-495"></span><span>  </span><span class="hs-comment">-- The lamCnt is just a counter that measures how many lambda-abstractions</span><span>
</span><span id="line-496"></span><span>  </span><span class="hs-comment">-- we have descended in the `go` loop.</span><span>
</span><span id="line-497"></span><span>  </span><span class="annot"><a href="#local-6989586621681866540"><span class="hs-identifier hs-type">go</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Word.html#Word64"><span class="hs-identifier hs-type">Word64</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#NTerm"><span class="hs-identifier hs-type">NTerm</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865592"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865593"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#NTerm"><span class="hs-identifier hs-type">NTerm</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865592"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865593"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-498"></span><span>  </span><span id="local-6989586621681866540"><span class="annot"><span class="annottext">go :: Word64 -&gt; NTerm uni fun () -&gt; NTerm uni fun ()
</span><a href="#local-6989586621681866540"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621681866541"><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621681866541"><span class="hs-identifier hs-var">lamCnt</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>  </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-499"></span><span>    </span><span class="annot"><a href="UntypedPlutusCore.Core.Type.html#LamAbs"><span class="hs-identifier hs-type">LamAbs</span></a></span><span> </span><span id="local-6989586621681866543"><span class="annot"><span class="annottext">()
</span><a href="#local-6989586621681866543"><span class="hs-identifier hs-var">ann</span></a></span></span><span> </span><span id="local-6989586621681866544"><span class="annot"><span class="annottext">NamedDeBruijn
</span><a href="#local-6989586621681866544"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span id="local-6989586621681866545"><span class="annot"><span class="annottext">NTerm uni fun ()
</span><a href="#local-6989586621681866545"><span class="hs-identifier hs-var">body</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; NamedDeBruijn -&gt; NTerm uni fun () -&gt; NTerm uni fun ()
forall name (uni :: * -&gt; *) fun ann.
ann -&gt; name -&gt; Term name uni fun ann -&gt; Term name uni fun ann
</span><a href="UntypedPlutusCore.Core.Type.html#LamAbs"><span class="hs-identifier hs-var">LamAbs</span></a></span><span> </span><span class="annot"><span class="annottext">()
</span><a href="#local-6989586621681866543"><span class="hs-identifier hs-var">ann</span></a></span><span> </span><span class="annot"><span class="annottext">NamedDeBruijn
</span><a href="#local-6989586621681866544"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">(NTerm uni fun () -&gt; NTerm uni fun ())
-&gt; NTerm uni fun () -&gt; NTerm uni fun ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; NTerm uni fun () -&gt; NTerm uni fun ()
</span><a href="#local-6989586621681866540"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621681866541"><span class="hs-identifier hs-var">lamCnt</span></a></span><span class="annot"><span class="annottext">Word64 -&gt; Word64 -&gt; Word64
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../../../ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Num.html#%2B"><span class="hs-operator hs-var">+</span></a></span><span class="annot"><span class="annottext">Word64
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">NTerm uni fun ()
</span><a href="#local-6989586621681866545"><span class="hs-identifier hs-var">body</span></a></span><span>
</span><span id="line-500"></span><span>    </span><span id="local-6989586621681866547"><span class="annot"><span class="annottext">var :: NTerm uni fun ()
</span><a href="#local-6989586621681866547"><span class="hs-identifier hs-var">var</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="UntypedPlutusCore.Core.Type.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span class="annot"><span class="annottext">()
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PlutusCore.DeBruijn.Internal.html#NamedDeBruijn"><span class="hs-identifier hs-type">NamedDeBruijn</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621681866550"><span class="annot"><span class="annottext">Index
</span><a href="#local-6989586621681866550"><span class="hs-identifier hs-var">ndbnIx</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681866551"><span class="annot"><span class="annottext">idx :: Word64
</span><a href="#local-6989586621681866551"><span class="hs-identifier hs-var hs-var">idx</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Index -&gt; Word64
forall a b. Coercible a b =&gt; a -&gt; b
</span><a href="../../../ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Prim.html#coerce"><span class="hs-identifier hs-var">coerce</span></a></span><span> </span><span class="annot"><span class="annottext">Index
</span><a href="#local-6989586621681866550"><span class="hs-identifier hs-var">ndbnIx</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Word.html#Word64"><span class="hs-identifier hs-type">Word64</span></a></span><span>  </span><span class="hs-keyword">in</span><span>
</span><span id="line-501"></span><span>        </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621681866541"><span class="hs-identifier hs-var">lamCnt</span></a></span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; Word64 -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><a href="../../../ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3E%3D"><span class="hs-operator hs-var">&gt;=</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621681866551"><span class="hs-identifier hs-var">idx</span></a></span><span>
</span><span id="line-502"></span><span>        </span><span class="hs-comment">-- the index n is less-than-or-equal than the number of lambdas we have descended</span><span>
</span><span id="line-503"></span><span>        </span><span class="hs-comment">-- this means that n points to a bound variable, so we don't discharge it.</span><span>
</span><span id="line-504"></span><span>        </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">NTerm uni fun ()
</span><a href="#local-6989586621681866547"><span class="hs-identifier hs-var">var</span></a></span><span>
</span><span id="line-505"></span><span>        </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">NTerm uni fun ()
-&gt; (CekValue uni fun ann -&gt; NTerm uni fun ())
-&gt; Maybe (CekValue uni fun ann)
-&gt; NTerm uni fun ()
forall b a. b -&gt; (a -&gt; b) -&gt; Maybe a -&gt; b
</span><a href="../../../ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.Maybe.html#maybe"><span class="hs-identifier hs-var">maybe</span></a></span><span>
</span><span id="line-506"></span><span>               </span><span class="hs-comment">-- var is free, leave it alone</span><span>
</span><span id="line-507"></span><span>               </span><span class="annot"><span class="annottext">NTerm uni fun ()
</span><a href="#local-6989586621681866547"><span class="hs-identifier hs-var">var</span></a></span><span>
</span><span id="line-508"></span><span>               </span><span class="hs-comment">-- var is in the env, discharge its value</span><span>
</span><span id="line-509"></span><span>               </span><span class="annot"><span class="annottext">CekValue uni fun ann -&gt; NTerm uni fun ()
forall (uni :: * -&gt; *) fun ann.
CekValue uni fun ann -&gt; NTerm uni fun ()
</span><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#dischargeCekValue"><span class="hs-identifier hs-var">dischargeCekValue</span></a></span><span>
</span><span id="line-510"></span><span>               </span><span class="hs-comment">-- index relative to (as seen from the point of view of) the environment</span><span>
</span><span id="line-511"></span><span>               </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CekValEnv uni fun ann
-&gt; Word64 -&gt; Maybe (Element (CekValEnv uni fun ann))
forall e. RandomAccessList e =&gt; e -&gt; Word64 -&gt; Maybe (Element e)
</span><span class="hs-identifier hs-var">Env.indexOne</span></span><span> </span><span class="annot"><span class="annottext">CekValEnv uni fun ann
</span><a href="#local-6989586621681866539"><span class="hs-identifier hs-var">valEnv</span></a></span><span> </span><span class="annot"><span class="annottext">(Word64 -&gt; Maybe (Element (CekValEnv uni fun ann)))
-&gt; Word64 -&gt; Maybe (Element (CekValEnv uni fun ann))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621681866551"><span class="hs-identifier hs-var">idx</span></a></span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; Word64 -&gt; Word64
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../../../ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Num.html#-"><span class="hs-glyph hs-var">-</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621681866541"><span class="hs-identifier hs-var">lamCnt</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-512"></span><span>    </span><span class="annot"><a href="UntypedPlutusCore.Core.Type.html#Apply"><span class="hs-identifier hs-type">Apply</span></a></span><span> </span><span id="local-6989586621681866555"><span class="annot"><span class="annottext">()
</span><a href="#local-6989586621681866555"><span class="hs-identifier hs-var">ann</span></a></span></span><span> </span><span id="local-6989586621681866556"><span class="annot"><span class="annottext">NTerm uni fun ()
</span><a href="#local-6989586621681866556"><span class="hs-identifier hs-var">fun</span></a></span></span><span> </span><span id="local-6989586621681866557"><span class="annot"><span class="annottext">NTerm uni fun ()
</span><a href="#local-6989586621681866557"><span class="hs-identifier hs-var">arg</span></a></span></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; NTerm uni fun () -&gt; NTerm uni fun () -&gt; NTerm uni fun ()
forall name (uni :: * -&gt; *) fun ann.
ann
-&gt; Term name uni fun ann
-&gt; Term name uni fun ann
-&gt; Term name uni fun ann
</span><a href="UntypedPlutusCore.Core.Type.html#Apply"><span class="hs-identifier hs-var">Apply</span></a></span><span> </span><span class="annot"><span class="annottext">()
</span><a href="#local-6989586621681866555"><span class="hs-identifier hs-var">ann</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word64 -&gt; NTerm uni fun () -&gt; NTerm uni fun ()
</span><a href="#local-6989586621681866540"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621681866541"><span class="hs-identifier hs-var">lamCnt</span></a></span><span> </span><span class="annot"><span class="annottext">NTerm uni fun ()
</span><a href="#local-6989586621681866556"><span class="hs-identifier hs-var">fun</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(NTerm uni fun () -&gt; NTerm uni fun ())
-&gt; NTerm uni fun () -&gt; NTerm uni fun ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; NTerm uni fun () -&gt; NTerm uni fun ()
</span><a href="#local-6989586621681866540"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621681866541"><span class="hs-identifier hs-var">lamCnt</span></a></span><span> </span><span class="annot"><span class="annottext">NTerm uni fun ()
</span><a href="#local-6989586621681866557"><span class="hs-identifier hs-var">arg</span></a></span><span>
</span><span id="line-513"></span><span>    </span><span class="annot"><a href="UntypedPlutusCore.Core.Type.html#Delay"><span class="hs-identifier hs-type">Delay</span></a></span><span> </span><span id="local-6989586621681866559"><span class="annot"><span class="annottext">()
</span><a href="#local-6989586621681866559"><span class="hs-identifier hs-var">ann</span></a></span></span><span> </span><span id="local-6989586621681866560"><span class="annot"><span class="annottext">NTerm uni fun ()
</span><a href="#local-6989586621681866560"><span class="hs-identifier hs-var">term</span></a></span></span><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; NTerm uni fun () -&gt; NTerm uni fun ()
forall name (uni :: * -&gt; *) fun ann.
ann -&gt; Term name uni fun ann -&gt; Term name uni fun ann
</span><a href="UntypedPlutusCore.Core.Type.html#Delay"><span class="hs-identifier hs-var">Delay</span></a></span><span> </span><span class="annot"><span class="annottext">()
</span><a href="#local-6989586621681866559"><span class="hs-identifier hs-var">ann</span></a></span><span> </span><span class="annot"><span class="annottext">(NTerm uni fun () -&gt; NTerm uni fun ())
-&gt; NTerm uni fun () -&gt; NTerm uni fun ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; NTerm uni fun () -&gt; NTerm uni fun ()
</span><a href="#local-6989586621681866540"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621681866541"><span class="hs-identifier hs-var">lamCnt</span></a></span><span> </span><span class="annot"><span class="annottext">NTerm uni fun ()
</span><a href="#local-6989586621681866560"><span class="hs-identifier hs-var">term</span></a></span><span>
</span><span id="line-514"></span><span>    </span><span class="annot"><a href="UntypedPlutusCore.Core.Type.html#Force"><span class="hs-identifier hs-type">Force</span></a></span><span> </span><span id="local-6989586621681866562"><span class="annot"><span class="annottext">()
</span><a href="#local-6989586621681866562"><span class="hs-identifier hs-var">ann</span></a></span></span><span> </span><span id="local-6989586621681866563"><span class="annot"><span class="annottext">NTerm uni fun ()
</span><a href="#local-6989586621681866563"><span class="hs-identifier hs-var">term</span></a></span></span><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; NTerm uni fun () -&gt; NTerm uni fun ()
forall name (uni :: * -&gt; *) fun ann.
ann -&gt; Term name uni fun ann -&gt; Term name uni fun ann
</span><a href="UntypedPlutusCore.Core.Type.html#Force"><span class="hs-identifier hs-var">Force</span></a></span><span> </span><span class="annot"><span class="annottext">()
</span><a href="#local-6989586621681866562"><span class="hs-identifier hs-var">ann</span></a></span><span> </span><span class="annot"><span class="annottext">(NTerm uni fun () -&gt; NTerm uni fun ())
-&gt; NTerm uni fun () -&gt; NTerm uni fun ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; NTerm uni fun () -&gt; NTerm uni fun ()
</span><a href="#local-6989586621681866540"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621681866541"><span class="hs-identifier hs-var">lamCnt</span></a></span><span> </span><span class="annot"><span class="annottext">NTerm uni fun ()
</span><a href="#local-6989586621681866563"><span class="hs-identifier hs-var">term</span></a></span><span>
</span><span id="line-515"></span><span>    </span><span id="local-6989586621681866564"><span class="annot"><span class="annottext">NTerm uni fun ()
</span><a href="#local-6989586621681866564"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">NTerm uni fun ()
</span><a href="#local-6989586621681866564"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-516"></span><span>
</span><span id="line-517"></span><span class="hs-comment">-- | Convert a 'CekValue' into a 'Term' by replacing all bound variables with the terms</span><span>
</span><span id="line-518"></span><span class="hs-comment">-- they're bound to (which themselves have to be obtain by recursively discharging values).</span><span>
</span><span id="line-519"></span><span id="local-6989586621681865503"><span id="local-6989586621681865504"><span id="local-6989586621681865505"><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#dischargeCekValue"><span class="hs-identifier hs-type">dischargeCekValue</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#CekValue"><span class="hs-identifier hs-type">CekValue</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865503"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865504"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865505"><span class="hs-identifier hs-type">ann</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#NTerm"><span class="hs-identifier hs-type">NTerm</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865503"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865504"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span></span></span><span>
</span><span id="line-520"></span><span id="dischargeCekValue"><span class="annot"><span class="annottext">dischargeCekValue :: forall (uni :: * -&gt; *) fun ann.
CekValue uni fun ann -&gt; NTerm uni fun ()
</span><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#dischargeCekValue"><span class="hs-identifier hs-var hs-var">dischargeCekValue</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-521"></span><span>    </span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#VCon"><span class="hs-identifier hs-type">VCon</span></a></span><span>     </span><span id="local-6989586621681866570"><span class="annot"><span class="annottext">Some (ValueOf uni)
</span><a href="#local-6989586621681866570"><span class="hs-identifier hs-var">val</span></a></span></span><span>                         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; Some (ValueOf uni) -&gt; NTerm uni fun ()
forall name (uni :: * -&gt; *) fun ann.
ann -&gt; Some (ValueOf uni) -&gt; Term name uni fun ann
</span><a href="UntypedPlutusCore.Core.Type.html#Constant"><span class="hs-identifier hs-var">Constant</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Some (ValueOf uni)
</span><a href="#local-6989586621681866570"><span class="hs-identifier hs-var">val</span></a></span><span>
</span><span id="line-522"></span><span>    </span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#VDelay"><span class="hs-identifier hs-type">VDelay</span></a></span><span>   </span><span id="local-6989586621681866572"><span class="annot"><span class="annottext">NTerm uni fun ann
</span><a href="#local-6989586621681866572"><span class="hs-identifier hs-var">body</span></a></span></span><span> </span><span id="local-6989586621681866573"><span class="annot"><span class="annottext">CekValEnv uni fun ann
</span><a href="#local-6989586621681866573"><span class="hs-identifier hs-var">env</span></a></span></span><span>                    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">CekValEnv uni fun ann -&gt; NTerm uni fun () -&gt; NTerm uni fun ()
forall (uni :: * -&gt; *) fun ann.
CekValEnv uni fun ann -&gt; NTerm uni fun () -&gt; NTerm uni fun ()
</span><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#dischargeCekValEnv"><span class="hs-identifier hs-var">dischargeCekValEnv</span></a></span><span> </span><span class="annot"><span class="annottext">CekValEnv uni fun ann
</span><a href="#local-6989586621681866573"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">(NTerm uni fun () -&gt; NTerm uni fun ())
-&gt; NTerm uni fun () -&gt; NTerm uni fun ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">() -&gt; NTerm uni fun () -&gt; NTerm uni fun ()
forall name (uni :: * -&gt; *) fun ann.
ann -&gt; Term name uni fun ann -&gt; Term name uni fun ann
</span><a href="UntypedPlutusCore.Core.Type.html#Delay"><span class="hs-identifier hs-var">Delay</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">NTerm uni fun ann -&gt; NTerm uni fun ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><a href="../../../ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.Functor.html#void"><span class="hs-identifier hs-var">void</span></a></span><span> </span><span class="annot"><span class="annottext">NTerm uni fun ann
</span><a href="#local-6989586621681866572"><span class="hs-identifier hs-var">body</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-523"></span><span>    </span><span class="hs-comment">-- 'computeCek' turns @LamAbs _ name body@ into @VLamAbs name body env@ where @env@ is an</span><span>
</span><span id="line-524"></span><span>    </span><span class="hs-comment">-- argument of 'computeCek' and hence we need to start discharging outside of the reassembled</span><span>
</span><span id="line-525"></span><span>    </span><span class="hs-comment">-- lambda, otherwise @name@ could clash with the names that we have in @env@.</span><span>
</span><span id="line-526"></span><span>    </span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#VLamAbs"><span class="hs-identifier hs-type">VLamAbs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PlutusCore.DeBruijn.Internal.html#NamedDeBruijn"><span class="hs-identifier hs-type">NamedDeBruijn</span></a></span><span> </span><span id="local-6989586621681866575"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621681866575"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span id="local-6989586621681866576"><span class="annot"><span class="annottext">Index
</span><a href="#local-6989586621681866576"><span class="hs-identifier hs-var">_ix</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621681866577"><span class="annot"><span class="annottext">NTerm uni fun ann
</span><a href="#local-6989586621681866577"><span class="hs-identifier hs-var">body</span></a></span></span><span> </span><span id="local-6989586621681866578"><span class="annot"><span class="annottext">CekValEnv uni fun ann
</span><a href="#local-6989586621681866578"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-527"></span><span>        </span><span class="hs-comment">-- The index on the binder is meaningless, we put `0` by convention, see 'Binder'.</span><span>
</span><span id="line-528"></span><span>        </span><span class="annot"><span class="annottext">CekValEnv uni fun ann -&gt; NTerm uni fun () -&gt; NTerm uni fun ()
forall (uni :: * -&gt; *) fun ann.
CekValEnv uni fun ann -&gt; NTerm uni fun () -&gt; NTerm uni fun ()
</span><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#dischargeCekValEnv"><span class="hs-identifier hs-var">dischargeCekValEnv</span></a></span><span> </span><span class="annot"><span class="annottext">CekValEnv uni fun ann
</span><a href="#local-6989586621681866578"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">(NTerm uni fun () -&gt; NTerm uni fun ())
-&gt; NTerm uni fun () -&gt; NTerm uni fun ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">() -&gt; NamedDeBruijn -&gt; NTerm uni fun () -&gt; NTerm uni fun ()
forall name (uni :: * -&gt; *) fun ann.
ann -&gt; name -&gt; Term name uni fun ann -&gt; Term name uni fun ann
</span><a href="UntypedPlutusCore.Core.Type.html#LamAbs"><span class="hs-identifier hs-var">LamAbs</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Text -&gt; Index -&gt; NamedDeBruijn
</span><a href="PlutusCore.DeBruijn.Internal.html#NamedDeBruijn"><span class="hs-identifier hs-var">NamedDeBruijn</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621681866575"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">Index
</span><a href="PlutusCore.DeBruijn.Internal.html#deBruijnInitIndex"><span class="hs-identifier hs-var">deBruijnInitIndex</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">NTerm uni fun ann -&gt; NTerm uni fun ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><a href="../../../ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.Functor.html#void"><span class="hs-identifier hs-var">void</span></a></span><span> </span><span class="annot"><span class="annottext">NTerm uni fun ann
</span><a href="#local-6989586621681866577"><span class="hs-identifier hs-var">body</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-529"></span><span>    </span><span class="hs-comment">-- We only return a discharged builtin application when (a) it's being returned by the machine,</span><span>
</span><span id="line-530"></span><span>    </span><span class="hs-comment">-- or (b) it's needed for an error message.</span><span>
</span><span id="line-531"></span><span>    </span><span class="hs-comment">-- @term@ is fully discharged, so we can return it directly without any further discharging.</span><span>
</span><span id="line-532"></span><span>    </span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#VBuiltin"><span class="hs-identifier hs-type">VBuiltin</span></a></span><span> </span><span class="annot"><span class="annottext">fun
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621681866580"><span class="annot"><span class="annottext">NTerm uni fun ()
</span><a href="#local-6989586621681866580"><span class="hs-identifier hs-var">term</span></a></span></span><span> </span><span class="annot"><span class="annottext">BuiltinRuntime (CekValue uni fun ann)
</span><span class="hs-identifier">_</span></span><span>                    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">NTerm uni fun ()
</span><a href="#local-6989586621681866580"><span class="hs-identifier hs-var">term</span></a></span><span>
</span><span id="line-533"></span><span>    </span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#VConstr"><span class="hs-identifier hs-type">VConstr</span></a></span><span> </span><span id="local-6989586621681866581"><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621681866581"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span id="local-6989586621681866582"><span class="annot"><span class="annottext">ArgStack uni fun ann
</span><a href="#local-6989586621681866582"><span class="hs-identifier hs-var">es</span></a></span></span><span>                         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; Word64 -&gt; [NTerm uni fun ()] -&gt; NTerm uni fun ()
forall name (uni :: * -&gt; *) fun ann.
ann -&gt; Word64 -&gt; [Term name uni fun ann] -&gt; Term name uni fun ann
</span><a href="UntypedPlutusCore.Core.Type.html#Constr"><span class="hs-identifier hs-var">Constr</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621681866581"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(CekValue uni fun ann -&gt; NTerm uni fun ())
-&gt; [CekValue uni fun ann] -&gt; [NTerm uni fun ()]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#fmap"><span class="hs-identifier hs-var">fmap</span></a></span><span> </span><span class="annot"><span class="annottext">CekValue uni fun ann -&gt; NTerm uni fun ()
forall (uni :: * -&gt; *) fun ann.
CekValue uni fun ann -&gt; NTerm uni fun ()
</span><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#dischargeCekValue"><span class="hs-identifier hs-var">dischargeCekValue</span></a></span><span> </span><span class="annot"><span class="annottext">([CekValue uni fun ann] -&gt; [NTerm uni fun ()])
-&gt; [CekValue uni fun ann] -&gt; [NTerm uni fun ()]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">ArgStack uni fun ann -&gt; [CekValue uni fun ann]
forall {uni :: * -&gt; *} {fun} {ann}.
ArgStack uni fun ann -&gt; [CekValue uni fun ann]
</span><a href="#local-6989586621681866584"><span class="hs-identifier hs-var">stack2list</span></a></span><span> </span><span class="annot"><span class="annottext">ArgStack uni fun ann
</span><a href="#local-6989586621681866582"><span class="hs-identifier hs-var">es</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-534"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-535"></span><span>        </span><span id="local-6989586621681866584"><span class="annot"><span class="annottext">stack2list :: ArgStack uni fun ann -&gt; [CekValue uni fun ann]
</span><a href="#local-6989586621681866584"><span class="hs-identifier hs-var hs-var">stack2list</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[CekValue uni fun ann]
-&gt; ArgStack uni fun ann -&gt; [CekValue uni fun ann]
forall {uni :: * -&gt; *} {fun} {ann}.
[CekValue uni fun ann]
-&gt; ArgStack uni fun ann -&gt; [CekValue uni fun ann]
</span><a href="#local-6989586621681866585"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-536"></span><span>        </span><span id="local-6989586621681866585"><span class="annot"><span class="annottext">go :: [CekValue uni fun ann]
-&gt; ArgStack uni fun ann -&gt; [CekValue uni fun ann]
</span><a href="#local-6989586621681866585"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span id="local-6989586621681866586"><span class="annot"><span class="annottext">[CekValue uni fun ann]
</span><a href="#local-6989586621681866586"><span class="hs-identifier hs-var">acc</span></a></span></span><span> </span><span class="annot"><span class="annottext">ArgStack uni fun ann
</span><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#EmptyStack"><span class="hs-identifier hs-var">EmptyStack</span></a></span><span>           </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[CekValue uni fun ann]
</span><a href="#local-6989586621681866586"><span class="hs-identifier hs-var">acc</span></a></span><span>
</span><span id="line-537"></span><span>        </span><span class="annot"><a href="#local-6989586621681866585"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span id="local-6989586621681866587"><span class="annot"><span class="annottext">[CekValue uni fun ann]
</span><a href="#local-6989586621681866587"><span class="hs-identifier hs-var">acc</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#ConsStack"><span class="hs-identifier hs-type">ConsStack</span></a></span><span> </span><span id="local-6989586621681866588"><span class="annot"><span class="annottext">CekValue uni fun ann
</span><a href="#local-6989586621681866588"><span class="hs-identifier hs-var">arg</span></a></span></span><span> </span><span id="local-6989586621681866589"><span class="annot"><span class="annottext">ArgStack uni fun ann
</span><a href="#local-6989586621681866589"><span class="hs-identifier hs-var">rest</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[CekValue uni fun ann]
-&gt; ArgStack uni fun ann -&gt; [CekValue uni fun ann]
</span><a href="#local-6989586621681866585"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CekValue uni fun ann
</span><a href="#local-6989586621681866588"><span class="hs-identifier hs-var">arg</span></a></span><span> </span><span class="annot"><span class="annottext">CekValue uni fun ann
-&gt; [CekValue uni fun ann] -&gt; [CekValue uni fun ann]
forall a. a -&gt; [a] -&gt; [a]
</span><a href="../../../ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#%3A"><span class="hs-glyph hs-var">:</span></a></span><span> </span><span class="annot"><span class="annottext">[CekValue uni fun ann]
</span><a href="#local-6989586621681866587"><span class="hs-identifier hs-var">acc</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">ArgStack uni fun ann
</span><a href="#local-6989586621681866589"><span class="hs-identifier hs-var">rest</span></a></span><span>
</span><span id="line-538"></span><span>
</span><span id="line-539"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621681865631"><span id="local-6989586621681865632"><span id="local-6989586621681865633"><span id="local-6989586621681866594"><span class="hs-special">(</span><span class="annot"><a href="PlutusCore.Pretty.PrettyConst.html#PrettyUni"><span class="hs-identifier hs-type">PrettyUni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865631"><span class="hs-identifier hs-type">uni</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Pretty</span></span><span> </span><span class="annot"><a href="#local-6989586621681865632"><span class="hs-identifier hs-type">fun</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">PrettyBy</span></span><span> </span><span class="annot"><a href="PlutusCore.Pretty.Plc.html#PrettyConfigPlc"><span class="hs-identifier hs-type">PrettyConfigPlc</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#CekValue"><span class="hs-identifier hs-type">CekValue</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865631"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865632"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865633"><span class="hs-identifier hs-type">ann</span></a></span><span class="hs-special">)</span></span></span></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-540"></span><span>    </span><span id="local-6989586621681866610"><span class="annot"><span class="annottext">prettyBy :: forall ann. PrettyConfigPlc -&gt; CekValue uni fun ann -&gt; Doc ann
</span><a href="#local-6989586621681866610"><span class="hs-identifier hs-var hs-var hs-var hs-var">prettyBy</span></a></span></span><span> </span><span id="local-6989586621681866612"><span class="annot"><span class="annottext">PrettyConfigPlc
</span><a href="#local-6989586621681866612"><span class="hs-identifier hs-var">cfg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PrettyConfigPlc -&gt; NTerm uni fun () -&gt; Doc ann
forall ann. PrettyConfigPlc -&gt; NTerm uni fun () -&gt; Doc ann
forall config a ann. PrettyBy config a =&gt; config -&gt; a -&gt; Doc ann
</span><span class="hs-identifier hs-var">prettyBy</span></span><span> </span><span class="annot"><span class="annottext">PrettyConfigPlc
</span><a href="#local-6989586621681866612"><span class="hs-identifier hs-var">cfg</span></a></span><span> </span><span class="annot"><span class="annottext">(NTerm uni fun () -&gt; Doc ann)
-&gt; (CekValue uni fun ann -&gt; NTerm uni fun ())
-&gt; CekValue uni fun ann
-&gt; Doc ann
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">CekValue uni fun ann -&gt; NTerm uni fun ()
forall (uni :: * -&gt; *) fun ann.
CekValue uni fun ann -&gt; NTerm uni fun ()
</span><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#dischargeCekValue"><span class="hs-identifier hs-var">dischargeCekValue</span></a></span><span>
</span><span id="line-541"></span><span>
</span><span id="line-542"></span><span class="hs-keyword">type</span><span> </span><span class="hs-keyword">instance</span><span> </span><span id="UniOf"><span class="annot"><a href="PlutusCore.Core.Type.html#UniOf"><span class="hs-identifier hs-var">UniOf</span></a></span></span><span> </span><span id="local-6989586621681866613"><span id="local-6989586621681866614"><span id="local-6989586621681866615"><span class="hs-special">(</span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#CekValue"><span class="hs-identifier hs-type">CekValue</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681866613"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681866614"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681866615"><span class="hs-identifier hs-type">ann</span></a></span><span class="hs-special">)</span></span></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621681866613"><span class="hs-identifier hs-type">uni</span></a></span><span>
</span><span id="line-543"></span><span>
</span><span id="line-544"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621681865642"><span id="local-6989586621681865643"><span id="local-6989586621681865644"><span class="annot"><a href="PlutusCore.Builtin.HasConstant.html#HasConstant"><span class="hs-identifier hs-type">HasConstant</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#CekValue"><span class="hs-identifier hs-type">CekValue</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865642"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865643"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865644"><span class="hs-identifier hs-type">ann</span></a></span><span class="hs-special">)</span></span></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-545"></span><span>    </span><span id="local-6989586621681866624"><span class="annot"><span class="annottext">asConstant :: CekValue uni fun ann
-&gt; Either
     BuiltinError (Some (ValueOf (UniOf (CekValue uni fun ann))))
</span><a href="#local-6989586621681866624"><span class="hs-identifier hs-var hs-var hs-var hs-var">asConstant</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#VCon"><span class="hs-identifier hs-type">VCon</span></a></span><span> </span><span id="local-6989586621681866626"><span class="annot"><span class="annottext">Some (ValueOf uni)
</span><a href="#local-6989586621681866626"><span class="hs-identifier hs-var">val</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Some (ValueOf uni) -&gt; Either BuiltinError (Some (ValueOf uni))
forall a. a -&gt; Either BuiltinError a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#pure"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">Some (ValueOf uni)
</span><a href="#local-6989586621681866626"><span class="hs-identifier hs-var">val</span></a></span><span>
</span><span id="line-546"></span><span>    </span><span class="annot"><a href="PlutusCore.Builtin.HasConstant.html#asConstant"><span class="hs-identifier hs-var">asConstant</span></a></span><span> </span><span class="annot"><span class="annottext">CekValue uni fun ann
</span><span class="hs-identifier">_</span></span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Either BuiltinError (Some (ValueOf uni))
Either BuiltinError (Some (ValueOf (UniOf (CekValue uni fun ann))))
forall (m :: * -&gt; *) void. MonadError BuiltinError m =&gt; m void
</span><a href="PlutusCore.Builtin.Result.html#throwNotAConstant"><span class="hs-identifier hs-var">throwNotAConstant</span></a></span><span>
</span><span id="line-547"></span><span>    </span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="PlutusCore.Builtin.HasConstant.html#asConstant"><span class="hs-pragma hs-type">asConstant</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-548"></span><span>
</span><span id="line-549"></span><span>    </span><span id="local-6989586621681866628"><span class="annot"><span class="annottext">fromConstant :: Some (ValueOf (UniOf (CekValue uni fun ann)))
-&gt; CekValue uni fun ann
</span><a href="#local-6989586621681866628"><span class="hs-identifier hs-var hs-var hs-var hs-var">fromConstant</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Some (ValueOf uni) -&gt; CekValue uni fun ann
Some (ValueOf (UniOf (CekValue uni fun ann)))
-&gt; CekValue uni fun ann
forall (uni :: * -&gt; *) fun ann.
Some (ValueOf uni) -&gt; CekValue uni fun ann
</span><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#VCon"><span class="hs-identifier hs-var">VCon</span></a></span><span>
</span><span id="line-550"></span><span>    </span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="PlutusCore.Builtin.HasConstant.html#fromConstant"><span class="hs-pragma hs-type">fromConstant</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-551"></span><span>
</span><span id="line-552"></span><span class="annot"><span class="hs-comment">{-|
The context in which the machine operates.

Morally, this is a stack of frames, but we use the &quot;intrusive list&quot; representation so that
we can match on context and the top frame in a single, strict pattern match.
-}</span></span><span>
</span><span id="line-558"></span><span class="hs-keyword">data</span><span> </span><span id="Context"><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#Context"><span class="hs-identifier hs-var">Context</span></a></span></span><span> </span><span id="local-6989586621681865679"><span class="annot"><a href="#local-6989586621681865679"><span class="hs-identifier hs-type">uni</span></a></span></span><span> </span><span id="local-6989586621681865680"><span class="annot"><a href="#local-6989586621681865680"><span class="hs-identifier hs-type">fun</span></a></span></span><span> </span><span id="local-6989586621681865681"><span class="annot"><a href="#local-6989586621681865681"><span class="hs-identifier hs-type">ann</span></a></span></span><span>
</span><span id="line-559"></span><span>    </span><span class="hs-glyph">=</span><span> </span><span id="FrameAwaitArg"><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#FrameAwaitArg"><span class="hs-identifier hs-var">FrameAwaitArg</span></a></span></span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#CekValue"><span class="hs-identifier hs-type">CekValue</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865679"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865680"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865681"><span class="hs-identifier hs-type">ann</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#Context"><span class="hs-identifier hs-type">Context</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865679"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865680"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865681"><span class="hs-identifier hs-type">ann</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-560"></span><span>    </span><span class="annot"><span class="hs-comment">-- ^ @[V _]@</span></span><span>
</span><span id="line-561"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span id="FrameAwaitFunTerm"><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#FrameAwaitFunTerm"><span class="hs-identifier hs-var">FrameAwaitFunTerm</span></a></span></span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#CekValEnv"><span class="hs-identifier hs-type">CekValEnv</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865679"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865680"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865681"><span class="hs-identifier hs-type">ann</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#NTerm"><span class="hs-identifier hs-type">NTerm</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865679"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865680"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865681"><span class="hs-identifier hs-type">ann</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#Context"><span class="hs-identifier hs-type">Context</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865679"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865680"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865681"><span class="hs-identifier hs-type">ann</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-562"></span><span>    </span><span class="annot"><span class="hs-comment">-- ^ @[_ N]@</span></span><span>
</span><span id="line-563"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span id="FrameAwaitFunValue"><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#FrameAwaitFunValue"><span class="hs-identifier hs-var">FrameAwaitFunValue</span></a></span></span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#CekValue"><span class="hs-identifier hs-type">CekValue</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865679"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865680"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865681"><span class="hs-identifier hs-type">ann</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#Context"><span class="hs-identifier hs-type">Context</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865679"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865680"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865681"><span class="hs-identifier hs-type">ann</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-564"></span><span>    </span><span class="annot"><span class="hs-comment">-- ^ @[_ V]@</span></span><span>
</span><span id="line-565"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span id="FrameForce"><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#FrameForce"><span class="hs-identifier hs-var">FrameForce</span></a></span></span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#Context"><span class="hs-identifier hs-type">Context</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865679"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865680"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865681"><span class="hs-identifier hs-type">ann</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-566"></span><span>    </span><span class="hs-comment">-- ^ @(force _)@</span><span>
</span><span id="line-567"></span><span>    </span><span class="hs-comment">-- See Note [Accumulators for terms]</span><span>
</span><span id="line-568"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span id="FrameConstr"><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#FrameConstr"><span class="hs-identifier hs-var">FrameConstr</span></a></span></span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#CekValEnv"><span class="hs-identifier hs-type">CekValEnv</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865679"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865680"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865681"><span class="hs-identifier hs-type">ann</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-pragma">{-# UNPACK</span><span> </span><span class="hs-pragma">#-}</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="../../../ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Word.html#Word64"><span class="hs-identifier hs-type">Word64</span></a></span><span> </span><span class="hs-glyph">!</span><span class="hs-special">[</span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#NTerm"><span class="hs-identifier hs-type">NTerm</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865679"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865680"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865681"><span class="hs-identifier hs-type">ann</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#ArgStack"><span class="hs-identifier hs-type">ArgStack</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865679"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865680"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865681"><span class="hs-identifier hs-type">ann</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#Context"><span class="hs-identifier hs-type">Context</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865679"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865680"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865681"><span class="hs-identifier hs-type">ann</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-569"></span><span>    </span><span class="annot"><span class="hs-comment">-- ^ @(constr i V0 ... Vj-1 _ Nj ... Nn)@</span></span><span>
</span><span id="line-570"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span id="FrameCases"><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#FrameCases"><span class="hs-identifier hs-var">FrameCases</span></a></span></span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#CekValEnv"><span class="hs-identifier hs-type">CekValEnv</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865679"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865680"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865681"><span class="hs-identifier hs-type">ann</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">V.Vector</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#NTerm"><span class="hs-identifier hs-type">NTerm</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865679"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865680"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865681"><span class="hs-identifier hs-type">ann</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#Context"><span class="hs-identifier hs-type">Context</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865679"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865680"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865681"><span class="hs-identifier hs-type">ann</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-571"></span><span>    </span><span class="annot"><span class="hs-comment">-- ^ @(case _ C0 .. Cn)@</span></span><span>
</span><span id="line-572"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span id="NoFrame"><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#NoFrame"><span class="hs-identifier hs-var">NoFrame</span></a></span></span><span>
</span><span id="line-573"></span><span>
</span><span id="line-574"></span><span id="local-6989586621681866643"><span id="local-6989586621681866675"><span id="local-6989586621681866679"><span class="hs-keyword">deriving</span><span> </span><span id="local-6989586621681865659"><span id="local-6989586621681865660"><span id="local-6989586621681865661"><span class="annot"><a href="#local-6989586621681865659"><span class="hs-keyword hs-type hs-type hs-type">stock</span></a></span></span></span></span><span> </span><span class="hs-keyword">instance</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">GShow</span></span><span> </span><span class="annot"><a href="#local-6989586621681865659"><span class="hs-identifier hs-type">uni</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Universe.Core.html#Everywhere"><span class="hs-identifier hs-type">Everywhere</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865659"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="../../../ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Show.html#Show"><span class="hs-identifier hs-type">Show</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Show.html#Show"><span class="hs-identifier hs-type">Show</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865660"><span class="hs-identifier hs-type">fun</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Show.html#Show"><span class="hs-identifier hs-type">Show</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865661"><span class="hs-identifier hs-type">ann</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Universe.Core.html#Closed"><span class="hs-identifier hs-type">Closed</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865659"><span class="hs-identifier hs-type">uni</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-575"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="../../../ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Show.html#Show"><span class="hs-identifier hs-type">Show</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#Context"><span class="hs-identifier hs-type">Context</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865659"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865660"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865661"><span class="hs-identifier hs-type">ann</span></a></span><span class="hs-special">)</span></span></span></span><span>
</span><span id="line-576"></span><span>
</span><span id="line-577"></span><span class="hs-comment">-- See Note [ExMemoryUsage instances for non-constants].</span><span>
</span><span id="line-578"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621681865668"><span id="local-6989586621681865669"><span id="local-6989586621681865670"><span class="hs-special">(</span><span class="annot"><a href="Universe.Core.html#Closed"><span class="hs-identifier hs-type">Closed</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865668"><span class="hs-identifier hs-type">uni</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621681865668"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="Universe.Core.html#Everywhere"><span class="hs-operator hs-type">`Everywhere`</span></a></span><span> </span><span class="annot"><a href="PlutusCore.Evaluation.Machine.ExMemoryUsage.html#ExMemoryUsage"><span class="hs-identifier hs-type">ExMemoryUsage</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="PlutusCore.Evaluation.Machine.ExMemoryUsage.html#ExMemoryUsage"><span class="hs-identifier hs-type">ExMemoryUsage</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#CekValue"><span class="hs-identifier hs-type">CekValue</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865668"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865669"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865670"><span class="hs-identifier hs-type">ann</span></a></span><span class="hs-special">)</span></span></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-579"></span><span>    </span><span id="local-6989586621681866695"><span class="annot"><span class="annottext">memoryUsage :: CekValue uni fun ann -&gt; CostRose
</span><a href="#local-6989586621681866695"><span class="hs-identifier hs-var hs-var hs-var hs-var">memoryUsage</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-580"></span><span>        </span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#VCon"><span class="hs-identifier hs-type">VCon</span></a></span><span> </span><span id="local-6989586621681866697"><span class="annot"><span class="annottext">Some (ValueOf uni)
</span><a href="#local-6989586621681866697"><span class="hs-identifier hs-var">c</span></a></span></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Some (ValueOf uni) -&gt; CostRose
forall a. ExMemoryUsage a =&gt; a -&gt; CostRose
</span><a href="PlutusCore.Evaluation.Machine.ExMemoryUsage.html#memoryUsage"><span class="hs-identifier hs-var">memoryUsage</span></a></span><span> </span><span class="annot"><span class="annottext">Some (ValueOf uni)
</span><a href="#local-6989586621681866697"><span class="hs-identifier hs-var">c</span></a></span><span>
</span><span id="line-581"></span><span>        </span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#VDelay"><span class="hs-identifier hs-type">VDelay</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">CostingInteger -&gt; CostRose
</span><a href="PlutusCore.Evaluation.Machine.ExMemoryUsage.html#singletonRose"><span class="hs-identifier hs-var">singletonRose</span></a></span><span> </span><span class="annot"><span class="annottext">CostingInteger
</span><span class="hs-number">1</span></span><span>
</span><span id="line-582"></span><span>        </span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#VLamAbs"><span class="hs-identifier hs-type">VLamAbs</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">CostingInteger -&gt; CostRose
</span><a href="PlutusCore.Evaluation.Machine.ExMemoryUsage.html#singletonRose"><span class="hs-identifier hs-var">singletonRose</span></a></span><span> </span><span class="annot"><span class="annottext">CostingInteger
</span><span class="hs-number">1</span></span><span>
</span><span id="line-583"></span><span>        </span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#VBuiltin"><span class="hs-identifier hs-type">VBuiltin</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">CostingInteger -&gt; CostRose
</span><a href="PlutusCore.Evaluation.Machine.ExMemoryUsage.html#singletonRose"><span class="hs-identifier hs-var">singletonRose</span></a></span><span> </span><span class="annot"><span class="annottext">CostingInteger
</span><span class="hs-number">1</span></span><span>
</span><span id="line-584"></span><span>        </span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#VConstr"><span class="hs-identifier hs-type">VConstr</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">CostingInteger -&gt; CostRose
</span><a href="PlutusCore.Evaluation.Machine.ExMemoryUsage.html#singletonRose"><span class="hs-identifier hs-var">singletonRose</span></a></span><span> </span><span class="annot"><span class="annottext">CostingInteger
</span><span class="hs-number">1</span></span><span>
</span><span id="line-585"></span><span>    </span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="PlutusCore.Evaluation.Machine.ExMemoryUsage.html#memoryUsage"><span class="hs-pragma hs-type">memoryUsage</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-586"></span><span>
</span><span id="line-587"></span><span class="hs-comment">{- Note [ArgStack vs Spine]
We use 'ArgStack' for collecting the arguments of a constructor to later pass it to the function in
the appropriate branch. Originally, all arguments of a constructor are terms and hence before we can
pass them to a function they need to be evaluated to values, which means that in case of the CEK
machine the evaluated arguments are going to be reversed: you evaluate the first argument and put
the result into a 'FrameConstr', then the second one and put it in a 'FrameConstr' again, this time
prepending it to the one that is already there etc -- in the end you get the arguments in reversed
order. Which is why 'transferArgStack' is a left fold (just like 'reverse').

But in case of 'Spine' the builtins machinery directly produces values, not terms. Meaning, a
'Spine' that we get from the builtins machinery isn't reversed, hence we can pass its contents
directly to the head of the application. Which is why 'transferSpine' is a right fold.
-}</span><span>
</span><span id="line-600"></span><span>
</span><span id="line-601"></span><span class="hs-comment">-- See Note [ArgStack vs Spine].</span><span>
</span><span id="line-602"></span><span class="annot"><span class="hs-comment">-- | Transfers an 'ArgStack' to a series of 'Context' frames.</span></span><span>
</span><span id="line-603"></span><span id="local-6989586621681865673"><span id="local-6989586621681865674"><span id="local-6989586621681865675"><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#transferArgStack"><span class="hs-identifier hs-type">transferArgStack</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#ArgStack"><span class="hs-identifier hs-type">ArgStack</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865673"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865674"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865675"><span class="hs-identifier hs-type">ann</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#Context"><span class="hs-identifier hs-type">Context</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865673"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865674"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865675"><span class="hs-identifier hs-type">ann</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#Context"><span class="hs-identifier hs-type">Context</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865673"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865674"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865675"><span class="hs-identifier hs-type">ann</span></a></span></span></span></span><span>
</span><span id="line-604"></span><span id="transferArgStack"><span class="annot"><span class="annottext">transferArgStack :: forall (uni :: * -&gt; *) fun ann.
ArgStack uni fun ann -&gt; Context uni fun ann -&gt; Context uni fun ann
</span><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#transferArgStack"><span class="hs-identifier hs-var hs-var">transferArgStack</span></a></span></span><span> </span><span class="annot"><span class="annottext">ArgStack uni fun ann
</span><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#EmptyStack"><span class="hs-identifier hs-var">EmptyStack</span></a></span><span> </span><span id="local-6989586621681866699"><span class="annot"><span class="annottext">Context uni fun ann
</span><a href="#local-6989586621681866699"><span class="hs-identifier hs-var">c</span></a></span></span><span>           </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Context uni fun ann
</span><a href="#local-6989586621681866699"><span class="hs-identifier hs-var">c</span></a></span><span>
</span><span id="line-605"></span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#transferArgStack"><span class="hs-identifier hs-var">transferArgStack</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#ConsStack"><span class="hs-identifier hs-type">ConsStack</span></a></span><span> </span><span id="local-6989586621681866700"><span class="annot"><span class="annottext">CekValue uni fun ann
</span><a href="#local-6989586621681866700"><span class="hs-identifier hs-var">arg</span></a></span></span><span> </span><span id="local-6989586621681866701"><span class="annot"><span class="annottext">ArgStack uni fun ann
</span><a href="#local-6989586621681866701"><span class="hs-identifier hs-var">rest</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621681866702"><span class="annot"><span class="annottext">Context uni fun ann
</span><a href="#local-6989586621681866702"><span class="hs-identifier hs-var">c</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ArgStack uni fun ann -&gt; Context uni fun ann -&gt; Context uni fun ann
forall (uni :: * -&gt; *) fun ann.
ArgStack uni fun ann -&gt; Context uni fun ann -&gt; Context uni fun ann
</span><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#transferArgStack"><span class="hs-identifier hs-var">transferArgStack</span></a></span><span> </span><span class="annot"><span class="annottext">ArgStack uni fun ann
</span><a href="#local-6989586621681866701"><span class="hs-identifier hs-var">rest</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CekValue uni fun ann -&gt; Context uni fun ann -&gt; Context uni fun ann
forall (uni :: * -&gt; *) fun ann.
CekValue uni fun ann -&gt; Context uni fun ann -&gt; Context uni fun ann
</span><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#FrameAwaitFunValue"><span class="hs-identifier hs-var">FrameAwaitFunValue</span></a></span><span> </span><span class="annot"><span class="annottext">CekValue uni fun ann
</span><a href="#local-6989586621681866700"><span class="hs-identifier hs-var">arg</span></a></span><span> </span><span class="annot"><span class="annottext">Context uni fun ann
</span><a href="#local-6989586621681866702"><span class="hs-identifier hs-var">c</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-606"></span><span>
</span><span id="line-607"></span><span class="hs-comment">-- See Note [ArgStack vs Spine].</span><span>
</span><span id="line-608"></span><span class="annot"><span class="hs-comment">-- | Transfers a 'Spine' onto the stack. The first argument will be at the top of the stack.</span></span><span>
</span><span id="line-609"></span><span id="local-6989586621681865682"><span id="local-6989586621681865683"><span id="local-6989586621681865684"><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#transferSpine"><span class="hs-identifier hs-type">transferSpine</span></a></span><span>
</span><span id="line-610"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="PlutusCore.Builtin.KnownType.html#Spine"><span class="hs-identifier hs-type">Spine</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#CekValue"><span class="hs-identifier hs-type">CekValue</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865682"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865683"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865684"><span class="hs-identifier hs-type">ann</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-611"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#Context"><span class="hs-identifier hs-type">Context</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865682"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865683"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865684"><span class="hs-identifier hs-type">ann</span></a></span><span>
</span><span id="line-612"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#Context"><span class="hs-identifier hs-type">Context</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865682"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865683"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865684"><span class="hs-identifier hs-type">ann</span></a></span></span></span></span><span>
</span><span id="line-613"></span><span id="transferSpine"><span class="annot"><span class="annottext">transferSpine :: forall (uni :: * -&gt; *) fun ann.
Spine (CekValue uni fun ann)
-&gt; Context uni fun ann -&gt; Context uni fun ann
</span><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#transferSpine"><span class="hs-identifier hs-var hs-var">transferSpine</span></a></span></span><span> </span><span id="local-6989586621681866706"><span class="annot"><span class="annottext">Spine (CekValue uni fun ann)
</span><a href="#local-6989586621681866706"><span class="hs-identifier hs-var">args</span></a></span></span><span> </span><span id="local-6989586621681866707"><span class="annot"><span class="annottext">Context uni fun ann
</span><a href="#local-6989586621681866707"><span class="hs-identifier hs-var">ctx</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(CekValue uni fun ann
 -&gt; Context uni fun ann -&gt; Context uni fun ann)
-&gt; Context uni fun ann
-&gt; Spine (CekValue uni fun ann)
-&gt; Context uni fun ann
forall a b. (a -&gt; b -&gt; b) -&gt; b -&gt; Spine a -&gt; b
forall (t :: * -&gt; *) a b.
Foldable t =&gt;
(a -&gt; b -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><a href="../../../ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.Foldable.html#foldr"><span class="hs-identifier hs-var">foldr</span></a></span><span> </span><span class="annot"><span class="annottext">CekValue uni fun ann -&gt; Context uni fun ann -&gt; Context uni fun ann
forall (uni :: * -&gt; *) fun ann.
CekValue uni fun ann -&gt; Context uni fun ann -&gt; Context uni fun ann
</span><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#FrameAwaitFunValue"><span class="hs-identifier hs-var">FrameAwaitFunValue</span></a></span><span> </span><span class="annot"><span class="annottext">Context uni fun ann
</span><a href="#local-6989586621681866707"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">Spine (CekValue uni fun ann)
</span><a href="#local-6989586621681866706"><span class="hs-identifier hs-var">args</span></a></span><span>
</span><span id="line-614"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#transferSpine"><span class="hs-pragma hs-type">transferSpine</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-615"></span><span>
</span><span id="line-616"></span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#runCekM"><span class="hs-identifier hs-type">runCekM</span></a></span><span>
</span><span id="line-617"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621681865699"><span class="annot"><a href="#local-6989586621681865699"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span id="local-6989586621681865696"><span class="annot"><a href="#local-6989586621681865696"><span class="hs-identifier hs-type">cost</span></a></span></span><span> </span><span id="local-6989586621681865692"><span class="annot"><a href="#local-6989586621681865692"><span class="hs-identifier hs-type">uni</span></a></span></span><span> </span><span id="local-6989586621681865693"><span class="annot"><a href="#local-6989586621681865693"><span class="hs-identifier hs-type">fun</span></a></span></span><span> </span><span id="local-6989586621681865694"><span class="annot"><a href="#local-6989586621681865694"><span class="hs-identifier hs-type">ann</span></a></span></span><span>
</span><span id="line-618"></span><span>    </span><span class="hs-operator">.</span><span> </span><span class="annot"><a href="PlutusCore.Pretty.PrettyConst.html#ThrowableBuiltins"><span class="hs-identifier hs-type">ThrowableBuiltins</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865692"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865693"><span class="hs-identifier hs-type">fun</span></a></span><span>
</span><span id="line-619"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="PlutusCore.Evaluation.Machine.MachineParameters.html#MachineParameters"><span class="hs-identifier hs-type">MachineParameters</span></a></span><span> </span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.CekMachineCosts.html#CekMachineCosts"><span class="hs-identifier hs-type">CekMachineCosts</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865693"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#CekValue"><span class="hs-identifier hs-type">CekValue</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865692"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865693"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865694"><span class="hs-identifier hs-type">ann</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-620"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#ExBudgetMode"><span class="hs-identifier hs-type">ExBudgetMode</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865696"><span class="hs-identifier hs-type">cost</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865692"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865693"><span class="hs-identifier hs-type">fun</span></a></span><span>
</span><span id="line-621"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#EmitterMode"><span class="hs-identifier hs-type">EmitterMode</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865692"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865693"><span class="hs-identifier hs-type">fun</span></a></span><span>
</span><span id="line-622"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621681865697"><span class="annot"><a href="#local-6989586621681865697"><span class="hs-identifier hs-type">s</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#GivenCekReqs"><span class="hs-identifier hs-type">GivenCekReqs</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865692"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865693"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865694"><span class="hs-identifier hs-type">ann</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865697"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#CekM"><span class="hs-identifier hs-type">CekM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865692"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865693"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865697"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865699"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-623"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.Either.html#Either"><span class="hs-identifier hs-type">Either</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#CekEvaluationException"><span class="hs-identifier hs-type">CekEvaluationException</span></a></span><span> </span><span class="annot"><a href="PlutusCore.DeBruijn.Internal.html#NamedDeBruijn"><span class="hs-identifier hs-type">NamedDeBruijn</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865692"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865693"><span class="hs-identifier hs-type">fun</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621681865699"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621681865696"><span class="hs-identifier hs-type">cost</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="../../../ghc-9.6.6/html/libraries/text-2.0.2/src/Data.Text.Internal.html#Text"><span class="hs-identifier hs-type">Text</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-624"></span><span id="runCekM"><span class="annot"><span class="annottext">runCekM :: forall a cost (uni :: * -&gt; *) fun ann.
ThrowableBuiltins uni fun =&gt;
MachineParameters CekMachineCosts fun (CekValue uni fun ann)
-&gt; ExBudgetMode cost uni fun
-&gt; EmitterMode uni fun
-&gt; (forall s. GivenCekReqs uni fun ann s =&gt; CekM uni fun s a)
-&gt; (Either (CekEvaluationException NamedDeBruijn uni fun) a, cost,
    [Text])
</span><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#runCekM"><span class="hs-identifier hs-var hs-var">runCekM</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PlutusCore.Evaluation.Machine.MachineParameters.html#MachineParameters"><span class="hs-identifier hs-type">MachineParameters</span></a></span><span> </span><span id="local-6989586621681866711"><span class="annot"><span class="annottext">CekMachineCosts
</span><a href="#local-6989586621681866711"><span class="hs-identifier hs-var">costs</span></a></span></span><span> </span><span id="local-6989586621681866712"><span class="annot"><span class="annottext">BuiltinsRuntime fun (CekValue uni fun ann)
</span><a href="#local-6989586621681866712"><span class="hs-identifier hs-var">runtime</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#ExBudgetMode"><span class="hs-identifier hs-type">ExBudgetMode</span></a></span><span> </span><span id="local-6989586621681866713"><span class="annot"><span class="annottext">forall s. ST s (ExBudgetInfo cost uni fun s)
</span><a href="#local-6989586621681866713"><span class="hs-identifier hs-var">getExBudgetInfo</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#EmitterMode"><span class="hs-identifier hs-type">EmitterMode</span></a></span><span> </span><span id="local-6989586621681866714"><span class="annot"><span class="annottext">forall s. ST s ExBudget -&gt; ST s (CekEmitterInfo uni fun s)
</span><a href="#local-6989586621681866714"><span class="hs-identifier hs-var">getEmitterMode</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621681866715"><span class="annot"><span class="annottext">forall s. GivenCekReqs uni fun ann s =&gt; CekM uni fun s a
</span><a href="#local-6989586621681866715"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(forall s.
 ST
   s
   (Either (CekEvaluationException NamedDeBruijn uni fun) a, cost,
    [Text]))
-&gt; (Either (CekEvaluationException NamedDeBruijn uni fun) a, cost,
    [Text])
forall a. (forall s. ST s a) -&gt; a
</span><a href="../../../ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.ST.html#runST"><span class="hs-identifier hs-var">runST</span></a></span><span> </span><span class="annot"><span class="annottext">((forall s.
  ST
    s
    (Either (CekEvaluationException NamedDeBruijn uni fun) a, cost,
     [Text]))
 -&gt; (Either (CekEvaluationException NamedDeBruijn uni fun) a, cost,
     [Text]))
-&gt; (forall s.
    ST
      s
      (Either (CekEvaluationException NamedDeBruijn uni fun) a, cost,
       [Text]))
-&gt; (Either (CekEvaluationException NamedDeBruijn uni fun) a, cost,
    [Text])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-625"></span><span>    </span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#ExBudgetInfo"><span class="hs-identifier hs-type">ExBudgetInfo</span></a></span><span class="hs-special">{</span><span id="local-6989586621681866722"><span class="annot"><span class="annottext">CekBudgetSpender uni fun s
_exBudgetModeSpender :: forall cost (uni :: * -&gt; *) fun s.
ExBudgetInfo cost uni fun s -&gt; CekBudgetSpender uni fun s
_exBudgetModeSpender :: CekBudgetSpender uni fun s
</span><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#_exBudgetModeSpender"><span class="hs-identifier hs-var hs-var">_exBudgetModeSpender</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681866723"><span class="annot"><span class="annottext">ST s cost
_exBudgetModeGetFinal :: forall cost (uni :: * -&gt; *) fun s.
ExBudgetInfo cost uni fun s -&gt; ST s cost
_exBudgetModeGetFinal :: ST s cost
</span><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#_exBudgetModeGetFinal"><span class="hs-identifier hs-var hs-var">_exBudgetModeGetFinal</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681866724"><span class="annot"><span class="annottext">ST s ExBudget
_exBudgetModeGetCumulative :: forall cost (uni :: * -&gt; *) fun s.
ExBudgetInfo cost uni fun s -&gt; ST s ExBudget
_exBudgetModeGetCumulative :: ST s ExBudget
</span><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#_exBudgetModeGetCumulative"><span class="hs-identifier hs-var hs-var">_exBudgetModeGetCumulative</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ST s (ExBudgetInfo cost uni fun s)
forall s. ST s (ExBudgetInfo cost uni fun s)
</span><a href="#local-6989586621681866713"><span class="hs-identifier hs-var">getExBudgetInfo</span></a></span><span>
</span><span id="line-626"></span><span>    </span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#CekEmitterInfo"><span class="hs-identifier hs-type">CekEmitterInfo</span></a></span><span class="hs-special">{</span><span id="local-6989586621681866725"><span class="annot"><span class="annottext">CekEmitter uni fun s
_cekEmitterInfoEmit :: forall (uni :: * -&gt; *) fun s.
CekEmitterInfo uni fun s -&gt; CekEmitter uni fun s
_cekEmitterInfoEmit :: CekEmitter uni fun s
</span><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#_cekEmitterInfoEmit"><span class="hs-identifier hs-var hs-var">_cekEmitterInfoEmit</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681866726"><span class="annot"><span class="annottext">ST s [Text]
_cekEmitterInfoGetFinal :: forall (uni :: * -&gt; *) fun s.
CekEmitterInfo uni fun s -&gt; ST s [Text]
_cekEmitterInfoGetFinal :: ST s [Text]
</span><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#_cekEmitterInfoGetFinal"><span class="hs-identifier hs-var hs-var">_cekEmitterInfoGetFinal</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ST s ExBudget -&gt; ST s (CekEmitterInfo uni fun s)
forall s. ST s ExBudget -&gt; ST s (CekEmitterInfo uni fun s)
</span><a href="#local-6989586621681866714"><span class="hs-identifier hs-var">getEmitterMode</span></a></span><span> </span><span class="annot"><span class="annottext">ST s ExBudget
</span><a href="#local-6989586621681866724"><span class="hs-identifier hs-var">_exBudgetModeGetCumulative</span></a></span><span>
</span><span id="line-627"></span><span>    </span><span id="local-6989586621681866727"><span class="annot"><span class="annottext">StepCounter 10 s
</span><a href="#local-6989586621681866727"><span class="hs-identifier hs-var">ctr</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Proxy 10 -&gt; ST s (StepCounter 10 (PrimState (ST s)))
forall (n :: Nat) (m :: * -&gt; *).
(KnownNat n, PrimMonad m) =&gt;
Proxy n -&gt; m (StepCounter n (PrimState m))
</span><a href="UntypedPlutusCore.Evaluation.Machine.Cek.StepCounter.html#newCounter"><span class="hs-identifier hs-var">newCounter</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (t :: Nat). Proxy t
forall {k} (t :: k). Proxy t
</span><a href="../../../ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.Proxy.html#Proxy"><span class="hs-identifier hs-var">Proxy</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#CounterSize"><span class="hs-identifier hs-type">CounterSize</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-628"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span class="">?cekRuntime</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">?cekRuntime::BuiltinsRuntime fun (CekValue uni fun ann)
BuiltinsRuntime fun (CekValue uni fun ann)
</span><a href="#local-6989586621681866712"><span class="hs-identifier hs-var">runtime</span></a></span><span>
</span><span id="line-629"></span><span>        </span><span class="">?cekEmitter</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">?cekEmitter::CekEmitter uni fun s
CekEmitter uni fun s
</span><a href="#local-6989586621681866725"><span class="hs-identifier hs-var">_cekEmitterInfoEmit</span></a></span><span>
</span><span id="line-630"></span><span>        </span><span class="">?cekBudgetSpender</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">?cekBudgetSpender::CekBudgetSpender uni fun s
CekBudgetSpender uni fun s
</span><a href="#local-6989586621681866722"><span class="hs-identifier hs-var">_exBudgetModeSpender</span></a></span><span>
</span><span id="line-631"></span><span>        </span><span class="">?cekCosts</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">?cekCosts::CekMachineCosts
CekMachineCosts
</span><a href="#local-6989586621681866711"><span class="hs-identifier hs-var">costs</span></a></span><span>
</span><span id="line-632"></span><span>        </span><span class="">?cekSlippage</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">?cekSlippage::Slippage
Slippage
</span><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#defaultSlippage"><span class="hs-identifier hs-var">defaultSlippage</span></a></span><span>
</span><span id="line-633"></span><span>        </span><span class="">?cekStepCounter</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">?cekStepCounter::StepCounter 10 s
StepCounter 10 s
</span><a href="#local-6989586621681866727"><span class="hs-identifier hs-var">ctr</span></a></span><span>
</span><span id="line-634"></span><span>    </span><span id="local-6989586621681866743"><span class="annot"><span class="annottext">Either (CekEvaluationException NamedDeBruijn uni fun) a
</span><a href="#local-6989586621681866743"><span class="hs-identifier hs-var">errOrRes</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CekM
  uni fun s (Either (CekEvaluationException NamedDeBruijn uni fun) a)
-&gt; ST s (Either (CekEvaluationException NamedDeBruijn uni fun) a)
forall (uni :: * -&gt; *) fun s a. CekM uni fun s a -&gt; ST s a
</span><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#unCekM"><span class="hs-identifier hs-var">unCekM</span></a></span><span> </span><span class="annot"><span class="annottext">(CekM
   uni fun s (Either (CekEvaluationException NamedDeBruijn uni fun) a)
 -&gt; ST s (Either (CekEvaluationException NamedDeBruijn uni fun) a))
-&gt; CekM
     uni fun s (Either (CekEvaluationException NamedDeBruijn uni fun) a)
-&gt; ST s (Either (CekEvaluationException NamedDeBruijn uni fun) a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">CekM uni fun s a
-&gt; CekM
     uni fun s (Either (CekEvaluationException NamedDeBruijn uni fun) a)
forall e (m :: * -&gt; *) a. MonadError e m =&gt; m a -&gt; m (Either e a)
</span><a href="PlutusPrelude.html#tryError"><span class="hs-identifier hs-var">tryError</span></a></span><span> </span><span class="annot"><span class="annottext">CekM uni fun s a
forall s. GivenCekReqs uni fun ann s =&gt; CekM uni fun s a
</span><a href="#local-6989586621681866715"><span class="hs-identifier hs-var">a</span></a></span><span>
</span><span id="line-635"></span><span>    </span><span id="local-6989586621681866745"><span class="annot"><span class="annottext">cost
</span><a href="#local-6989586621681866745"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ST s cost
</span><a href="#local-6989586621681866723"><span class="hs-identifier hs-var">_exBudgetModeGetFinal</span></a></span><span>
</span><span id="line-636"></span><span>    </span><span id="local-6989586621681866746"><span class="annot"><span class="annottext">[Text]
</span><a href="#local-6989586621681866746"><span class="hs-identifier hs-var">logs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ST s [Text]
</span><a href="#local-6989586621681866726"><span class="hs-identifier hs-var">_cekEmitterInfoGetFinal</span></a></span><span>
</span><span id="line-637"></span><span>    </span><span class="annot"><span class="annottext">(Either (CekEvaluationException NamedDeBruijn uni fun) a, cost,
 [Text])
-&gt; ST
     s
     (Either (CekEvaluationException NamedDeBruijn uni fun) a, cost,
      [Text])
forall a. a -&gt; ST s a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#pure"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Either (CekEvaluationException NamedDeBruijn uni fun) a
</span><a href="#local-6989586621681866743"><span class="hs-identifier hs-var">errOrRes</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">cost
</span><a href="#local-6989586621681866745"><span class="hs-identifier hs-var">st</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Text]
</span><a href="#local-6989586621681866746"><span class="hs-identifier hs-var">logs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-638"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#runCekM"><span class="hs-pragma hs-type">runCekM</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-639"></span><span>
</span><span id="line-640"></span><span class="hs-comment">-- See Note [Compilation peculiarities].</span><span>
</span><span id="line-641"></span><span class="annot"><span class="hs-comment">-- | The entering point to the CEK machine's engine.</span></span><span>
</span><span id="line-642"></span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#enterComputeCek"><span class="hs-identifier hs-type">enterComputeCek</span></a></span><span>
</span><span id="line-643"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621681865721"><span class="annot"><a href="#local-6989586621681865721"><span class="hs-identifier hs-type">uni</span></a></span></span><span> </span><span id="local-6989586621681865722"><span class="annot"><a href="#local-6989586621681865722"><span class="hs-identifier hs-type">fun</span></a></span></span><span> </span><span id="local-6989586621681865723"><span class="annot"><a href="#local-6989586621681865723"><span class="hs-identifier hs-type">ann</span></a></span></span><span> </span><span id="local-6989586621681865724"><span class="annot"><a href="#local-6989586621681865724"><span class="hs-identifier hs-type">s</span></a></span></span><span>
</span><span id="line-644"></span><span>    </span><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PlutusCore.Pretty.PrettyConst.html#ThrowableBuiltins"><span class="hs-identifier hs-type">ThrowableBuiltins</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865721"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865722"><span class="hs-identifier hs-type">fun</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#GivenCekReqs"><span class="hs-identifier hs-type">GivenCekReqs</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865721"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865722"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865723"><span class="hs-identifier hs-type">ann</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865724"><span class="hs-identifier hs-type">s</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-645"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#Context"><span class="hs-identifier hs-type">Context</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865721"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865722"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865723"><span class="hs-identifier hs-type">ann</span></a></span><span>
</span><span id="line-646"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#CekValEnv"><span class="hs-identifier hs-type">CekValEnv</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865721"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865722"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865723"><span class="hs-identifier hs-type">ann</span></a></span><span>
</span><span id="line-647"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#NTerm"><span class="hs-identifier hs-type">NTerm</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865721"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865722"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865723"><span class="hs-identifier hs-type">ann</span></a></span><span>
</span><span id="line-648"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#CekM"><span class="hs-identifier hs-type">CekM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865721"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865722"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865724"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#NTerm"><span class="hs-identifier hs-type">NTerm</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865721"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865722"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-649"></span><span id="enterComputeCek"><span class="annot"><span class="annottext">enterComputeCek :: forall (uni :: * -&gt; *) fun ann s.
(ThrowableBuiltins uni fun, GivenCekReqs uni fun ann s) =&gt;
Context uni fun ann
-&gt; CekValEnv uni fun ann
-&gt; NTerm uni fun ann
-&gt; CekM uni fun s (NTerm uni fun ())
</span><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#enterComputeCek"><span class="hs-identifier hs-var hs-var">enterComputeCek</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Context uni fun ann
-&gt; CekValEnv uni fun ann
-&gt; NTerm uni fun ann
-&gt; CekM uni fun s (Term NamedDeBruijn uni fun ())
</span><a href="#local-6989586621681866896"><span class="hs-identifier hs-var">computeCek</span></a></span><span>
</span><span id="line-650"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-651"></span><span>    </span><span class="hs-comment">-- | The computing part of the CEK machine.</span><span>
</span><span id="line-652"></span><span>    </span><span class="hs-comment">-- Either</span><span>
</span><span id="line-653"></span><span>    </span><span class="hs-comment">-- 1. adds a frame to the context and calls 'computeCek' ('Force', 'Apply')</span><span>
</span><span id="line-654"></span><span>    </span><span class="hs-comment">-- 2. calls 'returnCek' on values ('Delay', 'LamAbs', 'Constant', 'Builtin')</span><span>
</span><span id="line-655"></span><span>    </span><span class="hs-comment">-- 3. throws 'EvaluationFailure' ('Error')</span><span>
</span><span id="line-656"></span><span>    </span><span class="hs-comment">-- 4. looks up a variable in the environment and calls 'returnCek' ('Var')</span><span>
</span><span id="line-657"></span><span>    </span><span class="annot"><a href="#local-6989586621681866896"><span class="hs-identifier hs-type">computeCek</span></a></span><span>
</span><span id="line-658"></span><span>        </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#Context"><span class="hs-identifier hs-type">Context</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865721"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865722"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865723"><span class="hs-identifier hs-type">ann</span></a></span><span>
</span><span id="line-659"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#CekValEnv"><span class="hs-identifier hs-type">CekValEnv</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865721"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865722"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865723"><span class="hs-identifier hs-type">ann</span></a></span><span>
</span><span id="line-660"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#NTerm"><span class="hs-identifier hs-type">NTerm</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865721"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865722"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865723"><span class="hs-identifier hs-type">ann</span></a></span><span>
</span><span id="line-661"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#CekM"><span class="hs-identifier hs-type">CekM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865721"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865722"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865724"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#NTerm"><span class="hs-identifier hs-type">NTerm</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865721"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865722"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-662"></span><span>    </span><span class="hs-comment">-- s ; &#961; &#9659; {L A}  &#8614; s , {_ A} ; &#961; &#9659; L</span><span>
</span><span id="line-663"></span><span>    </span><span id="local-6989586621681866896"><span class="annot"><span class="annottext">computeCek :: Context uni fun ann
-&gt; CekValEnv uni fun ann
-&gt; NTerm uni fun ann
-&gt; CekM uni fun s (Term NamedDeBruijn uni fun ())
</span><a href="#local-6989586621681866896"><span class="hs-identifier hs-var hs-var">computeCek</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621681866897"><span class="annot"><span class="annottext">Context uni fun ann
</span><a href="#local-6989586621681866897"><span class="hs-identifier hs-var">ctx</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621681866898"><span class="annot"><span class="annottext">CekValEnv uni fun ann
</span><a href="#local-6989586621681866898"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="UntypedPlutusCore.Core.Type.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span class="annot"><span class="annottext">ann
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621681866899"><span class="annot"><span class="annottext">NamedDeBruijn
</span><a href="#local-6989586621681866899"><span class="hs-identifier hs-var">varName</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-664"></span><span>        </span><span class="annot"><span class="annottext">StepKind -&gt; CekM uni fun s ()
</span><a href="#local-6989586621681866900"><span class="hs-identifier hs-var">stepAndMaybeSpend</span></a></span><span> </span><span class="annot"><span class="annottext">StepKind
</span><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#BVar"><span class="hs-identifier hs-var">BVar</span></a></span><span>
</span><span id="line-665"></span><span>        </span><span id="local-6989586621681866901"><span class="annot"><span class="annottext">CekValue uni fun ann
</span><a href="#local-6989586621681866901"><span class="hs-identifier hs-var">val</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">NamedDeBruijn
-&gt; CekValEnv uni fun ann -&gt; CekM uni fun s (CekValue uni fun ann)
</span><a href="#local-6989586621681866902"><span class="hs-identifier hs-var">lookupVarName</span></a></span><span> </span><span class="annot"><span class="annottext">NamedDeBruijn
</span><a href="#local-6989586621681866899"><span class="hs-identifier hs-var">varName</span></a></span><span> </span><span class="annot"><span class="annottext">CekValEnv uni fun ann
</span><a href="#local-6989586621681866898"><span class="hs-identifier hs-var">env</span></a></span><span>
</span><span id="line-666"></span><span>        </span><span class="annot"><span class="annottext">Context uni fun ann
-&gt; CekValue uni fun ann
-&gt; CekM uni fun s (Term NamedDeBruijn uni fun ())
</span><a href="#local-6989586621681866903"><span class="hs-identifier hs-var">returnCek</span></a></span><span> </span><span class="annot"><span class="annottext">Context uni fun ann
</span><a href="#local-6989586621681866897"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">CekValue uni fun ann
</span><a href="#local-6989586621681866901"><span class="hs-identifier hs-var">val</span></a></span><span>
</span><span id="line-667"></span><span>    </span><span class="hs-comment">-- s ; &#961; &#9659; con c  &#8614;  s &#9669; con c</span><span>
</span><span id="line-668"></span><span>    </span><span class="annot"><a href="#local-6989586621681866896"><span class="hs-identifier hs-var">computeCek</span></a></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621681866904"><span class="annot"><span class="annottext">Context uni fun ann
</span><a href="#local-6989586621681866904"><span class="hs-identifier hs-var">ctx</span></a></span></span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="annottext">CekValEnv uni fun ann
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="UntypedPlutusCore.Core.Type.html#Constant"><span class="hs-identifier hs-type">Constant</span></a></span><span> </span><span class="annot"><span class="annottext">ann
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621681866905"><span class="annot"><span class="annottext">Some (ValueOf uni)
</span><a href="#local-6989586621681866905"><span class="hs-identifier hs-var">val</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-669"></span><span>        </span><span class="annot"><span class="annottext">StepKind -&gt; CekM uni fun s ()
</span><a href="#local-6989586621681866900"><span class="hs-identifier hs-var">stepAndMaybeSpend</span></a></span><span> </span><span class="annot"><span class="annottext">StepKind
</span><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#BConst"><span class="hs-identifier hs-var">BConst</span></a></span><span>
</span><span id="line-670"></span><span>        </span><span class="annot"><span class="annottext">Context uni fun ann
-&gt; CekValue uni fun ann
-&gt; CekM uni fun s (Term NamedDeBruijn uni fun ())
</span><a href="#local-6989586621681866903"><span class="hs-identifier hs-var">returnCek</span></a></span><span> </span><span class="annot"><span class="annottext">Context uni fun ann
</span><a href="#local-6989586621681866904"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Some (ValueOf uni) -&gt; CekValue uni fun ann
forall (uni :: * -&gt; *) fun ann.
Some (ValueOf uni) -&gt; CekValue uni fun ann
</span><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#VCon"><span class="hs-identifier hs-var">VCon</span></a></span><span> </span><span class="annot"><span class="annottext">Some (ValueOf uni)
</span><a href="#local-6989586621681866905"><span class="hs-identifier hs-var">val</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-671"></span><span>    </span><span class="hs-comment">-- s ; &#961; &#9659; lam x L  &#8614;  s &#9669; lam x (L , &#961;)</span><span>
</span><span id="line-672"></span><span>    </span><span class="annot"><a href="#local-6989586621681866896"><span class="hs-identifier hs-var">computeCek</span></a></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621681866906"><span class="annot"><span class="annottext">Context uni fun ann
</span><a href="#local-6989586621681866906"><span class="hs-identifier hs-var">ctx</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621681866907"><span class="annot"><span class="annottext">CekValEnv uni fun ann
</span><a href="#local-6989586621681866907"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="UntypedPlutusCore.Core.Type.html#LamAbs"><span class="hs-identifier hs-type">LamAbs</span></a></span><span> </span><span class="annot"><span class="annottext">ann
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621681866908"><span class="annot"><span class="annottext">NamedDeBruijn
</span><a href="#local-6989586621681866908"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span id="local-6989586621681866909"><span class="annot"><span class="annottext">NTerm uni fun ann
</span><a href="#local-6989586621681866909"><span class="hs-identifier hs-var">body</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-673"></span><span>        </span><span class="annot"><span class="annottext">StepKind -&gt; CekM uni fun s ()
</span><a href="#local-6989586621681866900"><span class="hs-identifier hs-var">stepAndMaybeSpend</span></a></span><span> </span><span class="annot"><span class="annottext">StepKind
</span><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#BLamAbs"><span class="hs-identifier hs-var">BLamAbs</span></a></span><span>
</span><span id="line-674"></span><span>        </span><span class="annot"><span class="annottext">Context uni fun ann
-&gt; CekValue uni fun ann
-&gt; CekM uni fun s (Term NamedDeBruijn uni fun ())
</span><a href="#local-6989586621681866903"><span class="hs-identifier hs-var">returnCek</span></a></span><span> </span><span class="annot"><span class="annottext">Context uni fun ann
</span><a href="#local-6989586621681866906"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">NamedDeBruijn
-&gt; NTerm uni fun ann
-&gt; CekValEnv uni fun ann
-&gt; CekValue uni fun ann
forall (uni :: * -&gt; *) fun ann.
NamedDeBruijn
-&gt; NTerm uni fun ann
-&gt; CekValEnv uni fun ann
-&gt; CekValue uni fun ann
</span><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#VLamAbs"><span class="hs-identifier hs-var">VLamAbs</span></a></span><span> </span><span class="annot"><span class="annottext">NamedDeBruijn
</span><a href="#local-6989586621681866908"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">NTerm uni fun ann
</span><a href="#local-6989586621681866909"><span class="hs-identifier hs-var">body</span></a></span><span> </span><span class="annot"><span class="annottext">CekValEnv uni fun ann
</span><a href="#local-6989586621681866907"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-675"></span><span>    </span><span class="hs-comment">-- s ; &#961; &#9659; delay L  &#8614;  s &#9669; delay (L , &#961;)</span><span>
</span><span id="line-676"></span><span>    </span><span class="annot"><a href="#local-6989586621681866896"><span class="hs-identifier hs-var">computeCek</span></a></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621681866910"><span class="annot"><span class="annottext">Context uni fun ann
</span><a href="#local-6989586621681866910"><span class="hs-identifier hs-var">ctx</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621681866911"><span class="annot"><span class="annottext">CekValEnv uni fun ann
</span><a href="#local-6989586621681866911"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="UntypedPlutusCore.Core.Type.html#Delay"><span class="hs-identifier hs-type">Delay</span></a></span><span> </span><span class="annot"><span class="annottext">ann
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621681866912"><span class="annot"><span class="annottext">NTerm uni fun ann
</span><a href="#local-6989586621681866912"><span class="hs-identifier hs-var">body</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-677"></span><span>        </span><span class="annot"><span class="annottext">StepKind -&gt; CekM uni fun s ()
</span><a href="#local-6989586621681866900"><span class="hs-identifier hs-var">stepAndMaybeSpend</span></a></span><span> </span><span class="annot"><span class="annottext">StepKind
</span><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#BDelay"><span class="hs-identifier hs-var">BDelay</span></a></span><span>
</span><span id="line-678"></span><span>        </span><span class="annot"><span class="annottext">Context uni fun ann
-&gt; CekValue uni fun ann
-&gt; CekM uni fun s (Term NamedDeBruijn uni fun ())
</span><a href="#local-6989586621681866903"><span class="hs-identifier hs-var">returnCek</span></a></span><span> </span><span class="annot"><span class="annottext">Context uni fun ann
</span><a href="#local-6989586621681866910"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">NTerm uni fun ann -&gt; CekValEnv uni fun ann -&gt; CekValue uni fun ann
forall (uni :: * -&gt; *) fun ann.
NTerm uni fun ann -&gt; CekValEnv uni fun ann -&gt; CekValue uni fun ann
</span><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#VDelay"><span class="hs-identifier hs-var">VDelay</span></a></span><span> </span><span class="annot"><span class="annottext">NTerm uni fun ann
</span><a href="#local-6989586621681866912"><span class="hs-identifier hs-var">body</span></a></span><span> </span><span class="annot"><span class="annottext">CekValEnv uni fun ann
</span><a href="#local-6989586621681866911"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-679"></span><span>    </span><span class="hs-comment">-- s ; &#961; &#9659; force T  &#8614;  s , force _ ; &#961; &#9659; L</span><span>
</span><span id="line-680"></span><span>    </span><span class="annot"><a href="#local-6989586621681866896"><span class="hs-identifier hs-var">computeCek</span></a></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621681866913"><span class="annot"><span class="annottext">Context uni fun ann
</span><a href="#local-6989586621681866913"><span class="hs-identifier hs-var">ctx</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621681866914"><span class="annot"><span class="annottext">CekValEnv uni fun ann
</span><a href="#local-6989586621681866914"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="UntypedPlutusCore.Core.Type.html#Force"><span class="hs-identifier hs-type">Force</span></a></span><span> </span><span class="annot"><span class="annottext">ann
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621681866915"><span class="annot"><span class="annottext">NTerm uni fun ann
</span><a href="#local-6989586621681866915"><span class="hs-identifier hs-var">body</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-681"></span><span>        </span><span class="annot"><span class="annottext">StepKind -&gt; CekM uni fun s ()
</span><a href="#local-6989586621681866900"><span class="hs-identifier hs-var">stepAndMaybeSpend</span></a></span><span> </span><span class="annot"><span class="annottext">StepKind
</span><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#BForce"><span class="hs-identifier hs-var">BForce</span></a></span><span>
</span><span id="line-682"></span><span>        </span><span class="annot"><span class="annottext">Context uni fun ann
-&gt; CekValEnv uni fun ann
-&gt; NTerm uni fun ann
-&gt; CekM uni fun s (Term NamedDeBruijn uni fun ())
</span><a href="#local-6989586621681866896"><span class="hs-identifier hs-var">computeCek</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Context uni fun ann -&gt; Context uni fun ann
forall (uni :: * -&gt; *) fun ann.
Context uni fun ann -&gt; Context uni fun ann
</span><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#FrameForce"><span class="hs-identifier hs-var">FrameForce</span></a></span><span> </span><span class="annot"><span class="annottext">Context uni fun ann
</span><a href="#local-6989586621681866913"><span class="hs-identifier hs-var">ctx</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CekValEnv uni fun ann
</span><a href="#local-6989586621681866914"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">NTerm uni fun ann
</span><a href="#local-6989586621681866915"><span class="hs-identifier hs-var">body</span></a></span><span>
</span><span id="line-683"></span><span>    </span><span class="hs-comment">-- s ; &#961; &#9659; [L M]  &#8614;  s , [_ (M,&#961;)]  ; &#961; &#9659; L</span><span>
</span><span id="line-684"></span><span>    </span><span class="annot"><a href="#local-6989586621681866896"><span class="hs-identifier hs-var">computeCek</span></a></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621681866916"><span class="annot"><span class="annottext">Context uni fun ann
</span><a href="#local-6989586621681866916"><span class="hs-identifier hs-var">ctx</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621681866917"><span class="annot"><span class="annottext">CekValEnv uni fun ann
</span><a href="#local-6989586621681866917"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="UntypedPlutusCore.Core.Type.html#Apply"><span class="hs-identifier hs-type">Apply</span></a></span><span> </span><span class="annot"><span class="annottext">ann
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621681866918"><span class="annot"><span class="annottext">NTerm uni fun ann
</span><a href="#local-6989586621681866918"><span class="hs-identifier hs-var">fun</span></a></span></span><span> </span><span id="local-6989586621681866919"><span class="annot"><span class="annottext">NTerm uni fun ann
</span><a href="#local-6989586621681866919"><span class="hs-identifier hs-var">arg</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-685"></span><span>        </span><span class="annot"><span class="annottext">StepKind -&gt; CekM uni fun s ()
</span><a href="#local-6989586621681866900"><span class="hs-identifier hs-var">stepAndMaybeSpend</span></a></span><span> </span><span class="annot"><span class="annottext">StepKind
</span><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#BApply"><span class="hs-identifier hs-var">BApply</span></a></span><span>
</span><span id="line-686"></span><span>        </span><span class="annot"><span class="annottext">Context uni fun ann
-&gt; CekValEnv uni fun ann
-&gt; NTerm uni fun ann
-&gt; CekM uni fun s (Term NamedDeBruijn uni fun ())
</span><a href="#local-6989586621681866896"><span class="hs-identifier hs-var">computeCek</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CekValEnv uni fun ann
-&gt; NTerm uni fun ann -&gt; Context uni fun ann -&gt; Context uni fun ann
forall (uni :: * -&gt; *) fun ann.
CekValEnv uni fun ann
-&gt; NTerm uni fun ann -&gt; Context uni fun ann -&gt; Context uni fun ann
</span><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#FrameAwaitFunTerm"><span class="hs-identifier hs-var">FrameAwaitFunTerm</span></a></span><span> </span><span class="annot"><span class="annottext">CekValEnv uni fun ann
</span><a href="#local-6989586621681866917"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">NTerm uni fun ann
</span><a href="#local-6989586621681866919"><span class="hs-identifier hs-var">arg</span></a></span><span> </span><span class="annot"><span class="annottext">Context uni fun ann
</span><a href="#local-6989586621681866916"><span class="hs-identifier hs-var">ctx</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CekValEnv uni fun ann
</span><a href="#local-6989586621681866917"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">NTerm uni fun ann
</span><a href="#local-6989586621681866918"><span class="hs-identifier hs-var">fun</span></a></span><span>
</span><span id="line-687"></span><span>    </span><span class="hs-comment">-- s ; &#961; &#9659; builtin bn  &#8614;  s &#9669; builtin bn arity arity [] [] &#961;</span><span>
</span><span id="line-688"></span><span>    </span><span class="annot"><a href="#local-6989586621681866896"><span class="hs-identifier hs-var">computeCek</span></a></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621681866920"><span class="annot"><span class="annottext">Context uni fun ann
</span><a href="#local-6989586621681866920"><span class="hs-identifier hs-var">ctx</span></a></span></span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="annottext">CekValEnv uni fun ann
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="UntypedPlutusCore.Core.Type.html#Builtin"><span class="hs-identifier hs-type">Builtin</span></a></span><span> </span><span class="annot"><span class="annottext">ann
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621681866922"><span class="annot"><span class="annottext">fun
</span><a href="#local-6989586621681866922"><span class="hs-identifier hs-var">bn</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-689"></span><span>        </span><span class="annot"><span class="annottext">StepKind -&gt; CekM uni fun s ()
</span><a href="#local-6989586621681866900"><span class="hs-identifier hs-var">stepAndMaybeSpend</span></a></span><span> </span><span class="annot"><span class="annottext">StepKind
</span><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#BBuiltin"><span class="hs-identifier hs-var">BBuiltin</span></a></span><span>
</span><span id="line-690"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681866923"><span class="annot"><span class="annottext">meaning :: BuiltinRuntime (CekValue uni fun ann)
</span><a href="#local-6989586621681866923"><span class="hs-identifier hs-var hs-var">meaning</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">fun
-&gt; BuiltinsRuntime fun (CekValue uni fun ann)
-&gt; BuiltinRuntime (CekValue uni fun ann)
forall fun val.
fun -&gt; BuiltinsRuntime fun val -&gt; BuiltinRuntime val
</span><a href="PlutusCore.Builtin.Runtime.html#lookupBuiltin"><span class="hs-identifier hs-var">lookupBuiltin</span></a></span><span> </span><span class="annot"><span class="annottext">fun
</span><a href="#local-6989586621681866922"><span class="hs-identifier hs-var">bn</span></a></span><span> </span><span class="annot"><span class="annottext">?cekRuntime::BuiltinsRuntime fun (CekValue uni fun ann)
BuiltinsRuntime fun (CekValue uni fun ann)
</span><a href="#local-6989586621681866872"><span class="hs-var">?cekRuntime</span></a></span><span>
</span><span id="line-691"></span><span>        </span><span class="hs-comment">-- 'Builtin' is fully discharged.</span><span>
</span><span id="line-692"></span><span>        </span><span class="annot"><span class="annottext">Context uni fun ann
-&gt; CekValue uni fun ann
-&gt; CekM uni fun s (Term NamedDeBruijn uni fun ())
</span><a href="#local-6989586621681866903"><span class="hs-identifier hs-var">returnCek</span></a></span><span> </span><span class="annot"><span class="annottext">Context uni fun ann
</span><a href="#local-6989586621681866920"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">fun
-&gt; Term NamedDeBruijn uni fun ()
-&gt; BuiltinRuntime (CekValue uni fun ann)
-&gt; CekValue uni fun ann
forall (uni :: * -&gt; *) fun ann.
fun
-&gt; NTerm uni fun ()
-&gt; BuiltinRuntime (CekValue uni fun ann)
-&gt; CekValue uni fun ann
</span><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#VBuiltin"><span class="hs-identifier hs-var">VBuiltin</span></a></span><span> </span><span class="annot"><span class="annottext">fun
</span><a href="#local-6989586621681866922"><span class="hs-identifier hs-var">bn</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">() -&gt; fun -&gt; Term NamedDeBruijn uni fun ()
forall name (uni :: * -&gt; *) fun ann.
ann -&gt; fun -&gt; Term name uni fun ann
</span><a href="UntypedPlutusCore.Core.Type.html#Builtin"><span class="hs-identifier hs-var">Builtin</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">fun
</span><a href="#local-6989586621681866922"><span class="hs-identifier hs-var">bn</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">BuiltinRuntime (CekValue uni fun ann)
</span><a href="#local-6989586621681866923"><span class="hs-identifier hs-var">meaning</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-693"></span><span>    </span><span class="hs-comment">-- s ; &#961; &#9659; constr I T0 .. Tn  &#8614;  s , constr I _ (T1 ... Tn, &#961;) ; &#961; &#9659; T0</span><span>
</span><span id="line-694"></span><span>    </span><span class="annot"><a href="#local-6989586621681866896"><span class="hs-identifier hs-var">computeCek</span></a></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621681866925"><span class="annot"><span class="annottext">Context uni fun ann
</span><a href="#local-6989586621681866925"><span class="hs-identifier hs-var">ctx</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621681866926"><span class="annot"><span class="annottext">CekValEnv uni fun ann
</span><a href="#local-6989586621681866926"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="UntypedPlutusCore.Core.Type.html#Constr"><span class="hs-identifier hs-type">Constr</span></a></span><span> </span><span class="annot"><span class="annottext">ann
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621681866927"><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621681866927"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span id="local-6989586621681866928"><span class="annot"><span class="annottext">[NTerm uni fun ann]
</span><a href="#local-6989586621681866928"><span class="hs-identifier hs-var">es</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-695"></span><span>        </span><span class="annot"><span class="annottext">StepKind -&gt; CekM uni fun s ()
</span><a href="#local-6989586621681866900"><span class="hs-identifier hs-var">stepAndMaybeSpend</span></a></span><span> </span><span class="annot"><span class="annottext">StepKind
</span><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#BConstr"><span class="hs-identifier hs-var">BConstr</span></a></span><span>
</span><span id="line-696"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">[NTerm uni fun ann]
</span><a href="#local-6989586621681866928"><span class="hs-identifier hs-var">es</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-697"></span><span>          </span><span class="hs-special">(</span><span id="local-6989586621681866929"><span class="annot"><span class="annottext">NTerm uni fun ann
</span><a href="#local-6989586621681866929"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="annot"><a href="../../../ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#%3A"><span class="hs-glyph hs-type">:</span></a></span><span> </span><span id="local-6989586621681866930"><span class="annot"><span class="annottext">[NTerm uni fun ann]
</span><a href="#local-6989586621681866930"><span class="hs-identifier hs-var">rest</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Context uni fun ann
-&gt; CekValEnv uni fun ann
-&gt; NTerm uni fun ann
-&gt; CekM uni fun s (Term NamedDeBruijn uni fun ())
</span><a href="#local-6989586621681866896"><span class="hs-identifier hs-var">computeCek</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CekValEnv uni fun ann
-&gt; Word64
-&gt; [NTerm uni fun ann]
-&gt; ArgStack uni fun ann
-&gt; Context uni fun ann
-&gt; Context uni fun ann
forall (uni :: * -&gt; *) fun ann.
CekValEnv uni fun ann
-&gt; Word64
-&gt; [NTerm uni fun ann]
-&gt; ArgStack uni fun ann
-&gt; Context uni fun ann
-&gt; Context uni fun ann
</span><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#FrameConstr"><span class="hs-identifier hs-var">FrameConstr</span></a></span><span> </span><span class="annot"><span class="annottext">CekValEnv uni fun ann
</span><a href="#local-6989586621681866926"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621681866927"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">[NTerm uni fun ann]
</span><a href="#local-6989586621681866930"><span class="hs-identifier hs-var">rest</span></a></span><span> </span><span class="annot"><span class="annottext">ArgStack uni fun ann
forall (uni :: * -&gt; *) fun ann. ArgStack uni fun ann
</span><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#EmptyStack"><span class="hs-identifier hs-var">EmptyStack</span></a></span><span> </span><span class="annot"><span class="annottext">Context uni fun ann
</span><a href="#local-6989586621681866925"><span class="hs-identifier hs-var">ctx</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CekValEnv uni fun ann
</span><a href="#local-6989586621681866926"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">NTerm uni fun ann
</span><a href="#local-6989586621681866929"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-698"></span><span>          </span><span class="hs-special">[</span><span class="hs-special">]</span><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Context uni fun ann
-&gt; CekValue uni fun ann
-&gt; CekM uni fun s (Term NamedDeBruijn uni fun ())
</span><a href="#local-6989586621681866903"><span class="hs-identifier hs-var">returnCek</span></a></span><span> </span><span class="annot"><span class="annottext">Context uni fun ann
</span><a href="#local-6989586621681866925"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">(CekValue uni fun ann
 -&gt; CekM uni fun s (Term NamedDeBruijn uni fun ()))
-&gt; CekValue uni fun ann
-&gt; CekM uni fun s (Term NamedDeBruijn uni fun ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; ArgStack uni fun ann -&gt; CekValue uni fun ann
forall (uni :: * -&gt; *) fun ann.
Word64 -&gt; ArgStack uni fun ann -&gt; CekValue uni fun ann
</span><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#VConstr"><span class="hs-identifier hs-var">VConstr</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621681866927"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">ArgStack uni fun ann
forall (uni :: * -&gt; *) fun ann. ArgStack uni fun ann
</span><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#EmptyStack"><span class="hs-identifier hs-var">EmptyStack</span></a></span><span>
</span><span id="line-699"></span><span>    </span><span class="hs-comment">-- s ; &#961; &#9659; case S C0 ... Cn  &#8614;  s , case _ (C0 ... Cn, &#961;) ; &#961; &#9659; S</span><span>
</span><span id="line-700"></span><span>    </span><span class="annot"><a href="#local-6989586621681866896"><span class="hs-identifier hs-var">computeCek</span></a></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621681866931"><span class="annot"><span class="annottext">Context uni fun ann
</span><a href="#local-6989586621681866931"><span class="hs-identifier hs-var">ctx</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621681866932"><span class="annot"><span class="annottext">CekValEnv uni fun ann
</span><a href="#local-6989586621681866932"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="UntypedPlutusCore.Core.Type.html#Case"><span class="hs-identifier hs-type">Case</span></a></span><span> </span><span class="annot"><span class="annottext">ann
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621681866934"><span class="annot"><span class="annottext">NTerm uni fun ann
</span><a href="#local-6989586621681866934"><span class="hs-identifier hs-var">scrut</span></a></span></span><span> </span><span id="local-6989586621681866935"><span class="annot"><span class="annottext">Vector (NTerm uni fun ann)
</span><a href="#local-6989586621681866935"><span class="hs-identifier hs-var">cs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-701"></span><span>        </span><span class="annot"><span class="annottext">StepKind -&gt; CekM uni fun s ()
</span><a href="#local-6989586621681866900"><span class="hs-identifier hs-var">stepAndMaybeSpend</span></a></span><span> </span><span class="annot"><span class="annottext">StepKind
</span><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#BCase"><span class="hs-identifier hs-var">BCase</span></a></span><span>
</span><span id="line-702"></span><span>        </span><span class="annot"><span class="annottext">Context uni fun ann
-&gt; CekValEnv uni fun ann
-&gt; NTerm uni fun ann
-&gt; CekM uni fun s (Term NamedDeBruijn uni fun ())
</span><a href="#local-6989586621681866896"><span class="hs-identifier hs-var">computeCek</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CekValEnv uni fun ann
-&gt; Vector (NTerm uni fun ann)
-&gt; Context uni fun ann
-&gt; Context uni fun ann
forall (uni :: * -&gt; *) fun ann.
CekValEnv uni fun ann
-&gt; Vector (NTerm uni fun ann)
-&gt; Context uni fun ann
-&gt; Context uni fun ann
</span><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#FrameCases"><span class="hs-identifier hs-var">FrameCases</span></a></span><span> </span><span class="annot"><span class="annottext">CekValEnv uni fun ann
</span><a href="#local-6989586621681866932"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Vector (NTerm uni fun ann)
</span><a href="#local-6989586621681866935"><span class="hs-identifier hs-var">cs</span></a></span><span> </span><span class="annot"><span class="annottext">Context uni fun ann
</span><a href="#local-6989586621681866931"><span class="hs-identifier hs-var">ctx</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CekValEnv uni fun ann
</span><a href="#local-6989586621681866932"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">NTerm uni fun ann
</span><a href="#local-6989586621681866934"><span class="hs-identifier hs-var">scrut</span></a></span><span>
</span><span id="line-703"></span><span>    </span><span class="hs-comment">-- s ; &#961; &#9659; error  &#8614;  &lt;&gt; A</span><span>
</span><span id="line-704"></span><span>    </span><span class="annot"><a href="#local-6989586621681866896"><span class="hs-identifier hs-var">computeCek</span></a></span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="annottext">Context uni fun ann
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="annottext">CekValEnv uni fun ann
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="UntypedPlutusCore.Core.Type.html#Error"><span class="hs-identifier hs-type">Error</span></a></span><span> </span><span class="annot"><span class="annottext">ann
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-705"></span><span>        </span><span class="annot"><span class="annottext">AReview
  (ErrorWithCause
     (EvaluationError (MachineError fun) CekUserError)
     (Term NamedDeBruijn uni fun ()))
  ()
-&gt; CekM uni fun s (Term NamedDeBruijn uni fun ())
forall e (m :: * -&gt; *) x. MonadError e m =&gt; AReview e () -&gt; m x
</span><span class="hs-identifier hs-var">throwing_</span></span><span> </span><span class="annot"><span class="annottext">AReview
  (ErrorWithCause
     (EvaluationError (MachineError fun) CekUserError)
     (Term NamedDeBruijn uni fun ()))
  ()
forall err. AsEvaluationFailure err =&gt; Prism' err ()
Prism'
  (ErrorWithCause
     (EvaluationError (MachineError fun) CekUserError)
     (Term NamedDeBruijn uni fun ()))
  ()
</span><a href="PlutusCore.Evaluation.Result.html#_EvaluationFailure"><span class="hs-identifier hs-var">_EvaluationFailure</span></a></span><span>
</span><span id="line-706"></span><span>
</span><span id="line-707"></span><span>    </span><span class="hs-comment">{- | The returning phase of the CEK machine.
    Returns 'EvaluationSuccess' in case the context is empty, otherwise pops up one frame
    from the context and uses it to decide how to proceed with the current value v.

      * 'FrameForce': call forceEvaluate
      * 'FrameApplyArg': call 'computeCek' over the context extended with 'FrameApplyFun'
      * 'FrameApplyFun': call 'applyEvaluate' to attempt to apply the function
          stored in the frame to an argument.
    -}</span><span>
</span><span id="line-716"></span><span>    </span><span class="annot"><a href="#local-6989586621681866903"><span class="hs-identifier hs-type">returnCek</span></a></span><span>
</span><span id="line-717"></span><span>        </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#Context"><span class="hs-identifier hs-type">Context</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865721"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865722"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865723"><span class="hs-identifier hs-type">ann</span></a></span><span>
</span><span id="line-718"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#CekValue"><span class="hs-identifier hs-type">CekValue</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865721"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865722"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865723"><span class="hs-identifier hs-type">ann</span></a></span><span>
</span><span id="line-719"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#CekM"><span class="hs-identifier hs-type">CekM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865721"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865722"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865724"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#NTerm"><span class="hs-identifier hs-type">NTerm</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865721"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865722"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-720"></span><span>    </span><span class="hs-comment">--- Instantiate all the free variable of the resulting term in case there are any.</span><span>
</span><span id="line-721"></span><span>    </span><span class="hs-comment">-- . &#9669; V           &#8614;  [] V</span><span>
</span><span id="line-722"></span><span>    </span><span id="local-6989586621681866903"><span class="annot"><span class="annottext">returnCek :: Context uni fun ann
-&gt; CekValue uni fun ann
-&gt; CekM uni fun s (Term NamedDeBruijn uni fun ())
</span><a href="#local-6989586621681866903"><span class="hs-identifier hs-var hs-var">returnCek</span></a></span></span><span> </span><span class="annot"><span class="annottext">Context uni fun ann
</span><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#NoFrame"><span class="hs-identifier hs-var">NoFrame</span></a></span><span> </span><span id="local-6989586621681866938"><span class="annot"><span class="annottext">CekValue uni fun ann
</span><a href="#local-6989586621681866938"><span class="hs-identifier hs-var">val</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-723"></span><span>        </span><span class="annot"><span class="annottext">CekM uni fun s ()
</span><a href="#local-6989586621681866939"><span class="hs-identifier hs-var">spendAccumulatedBudget</span></a></span><span>
</span><span id="line-724"></span><span>        </span><span class="annot"><span class="annottext">Term NamedDeBruijn uni fun ()
-&gt; CekM uni fun s (Term NamedDeBruijn uni fun ())
forall a. a -&gt; CekM uni fun s a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#pure"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">(Term NamedDeBruijn uni fun ()
 -&gt; CekM uni fun s (Term NamedDeBruijn uni fun ()))
-&gt; Term NamedDeBruijn uni fun ()
-&gt; CekM uni fun s (Term NamedDeBruijn uni fun ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">CekValue uni fun ann -&gt; Term NamedDeBruijn uni fun ()
forall (uni :: * -&gt; *) fun ann.
CekValue uni fun ann -&gt; NTerm uni fun ()
</span><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#dischargeCekValue"><span class="hs-identifier hs-var">dischargeCekValue</span></a></span><span> </span><span class="annot"><span class="annottext">CekValue uni fun ann
</span><a href="#local-6989586621681866938"><span class="hs-identifier hs-var">val</span></a></span><span>
</span><span id="line-725"></span><span>    </span><span class="hs-comment">-- s , {_ A} &#9669; abs &#945; M  &#8614;  s ; &#961; &#9659; M [ &#945; / A ]*</span><span>
</span><span id="line-726"></span><span>    </span><span class="annot"><a href="#local-6989586621681866903"><span class="hs-identifier hs-var">returnCek</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#FrameForce"><span class="hs-identifier hs-type">FrameForce</span></a></span><span> </span><span id="local-6989586621681866940"><span class="annot"><span class="annottext">Context uni fun ann
</span><a href="#local-6989586621681866940"><span class="hs-identifier hs-var">ctx</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621681866941"><span class="annot"><span class="annottext">CekValue uni fun ann
</span><a href="#local-6989586621681866941"><span class="hs-identifier hs-var">fun</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Context uni fun ann
-&gt; CekValue uni fun ann
-&gt; CekM uni fun s (Term NamedDeBruijn uni fun ())
</span><a href="#local-6989586621681866942"><span class="hs-identifier hs-var">forceEvaluate</span></a></span><span> </span><span class="annot"><span class="annottext">Context uni fun ann
</span><a href="#local-6989586621681866940"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">CekValue uni fun ann
</span><a href="#local-6989586621681866941"><span class="hs-identifier hs-var">fun</span></a></span><span>
</span><span id="line-727"></span><span>    </span><span class="hs-comment">-- s , [_ (M,&#961;)] &#9669; V  &#8614;  s , [V _] ; &#961; &#9659; M</span><span>
</span><span id="line-728"></span><span>    </span><span class="annot"><a href="#local-6989586621681866903"><span class="hs-identifier hs-var">returnCek</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#FrameAwaitFunTerm"><span class="hs-identifier hs-type">FrameAwaitFunTerm</span></a></span><span> </span><span id="local-6989586621681866943"><span class="annot"><span class="annottext">CekValEnv uni fun ann
</span><a href="#local-6989586621681866943"><span class="hs-identifier hs-var">argVarEnv</span></a></span></span><span> </span><span id="local-6989586621681866944"><span class="annot"><span class="annottext">NTerm uni fun ann
</span><a href="#local-6989586621681866944"><span class="hs-identifier hs-var">arg</span></a></span></span><span> </span><span id="local-6989586621681866945"><span class="annot"><span class="annottext">Context uni fun ann
</span><a href="#local-6989586621681866945"><span class="hs-identifier hs-var">ctx</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621681866946"><span class="annot"><span class="annottext">CekValue uni fun ann
</span><a href="#local-6989586621681866946"><span class="hs-identifier hs-var">fun</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-729"></span><span>        </span><span class="annot"><span class="annottext">Context uni fun ann
-&gt; CekValEnv uni fun ann
-&gt; NTerm uni fun ann
-&gt; CekM uni fun s (Term NamedDeBruijn uni fun ())
</span><a href="#local-6989586621681866896"><span class="hs-identifier hs-var">computeCek</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CekValue uni fun ann -&gt; Context uni fun ann -&gt; Context uni fun ann
forall (uni :: * -&gt; *) fun ann.
CekValue uni fun ann -&gt; Context uni fun ann -&gt; Context uni fun ann
</span><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#FrameAwaitArg"><span class="hs-identifier hs-var">FrameAwaitArg</span></a></span><span> </span><span class="annot"><span class="annottext">CekValue uni fun ann
</span><a href="#local-6989586621681866946"><span class="hs-identifier hs-var">fun</span></a></span><span> </span><span class="annot"><span class="annottext">Context uni fun ann
</span><a href="#local-6989586621681866945"><span class="hs-identifier hs-var">ctx</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CekValEnv uni fun ann
</span><a href="#local-6989586621681866943"><span class="hs-identifier hs-var">argVarEnv</span></a></span><span> </span><span class="annot"><span class="annottext">NTerm uni fun ann
</span><a href="#local-6989586621681866944"><span class="hs-identifier hs-var">arg</span></a></span><span>
</span><span id="line-730"></span><span>    </span><span class="hs-comment">-- s , [(lam x (M,&#961;)) _] &#9669; V  &#8614;  s ; &#961; [ x  &#8614;  V ] &#9659; M</span><span>
</span><span id="line-731"></span><span>    </span><span class="hs-comment">-- FIXME: add rule for VBuiltin once it's in the specification.</span><span>
</span><span id="line-732"></span><span>    </span><span class="annot"><a href="#local-6989586621681866903"><span class="hs-identifier hs-var">returnCek</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#FrameAwaitArg"><span class="hs-identifier hs-type">FrameAwaitArg</span></a></span><span> </span><span id="local-6989586621681866947"><span class="annot"><span class="annottext">CekValue uni fun ann
</span><a href="#local-6989586621681866947"><span class="hs-identifier hs-var">fun</span></a></span></span><span> </span><span id="local-6989586621681866948"><span class="annot"><span class="annottext">Context uni fun ann
</span><a href="#local-6989586621681866948"><span class="hs-identifier hs-var">ctx</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621681866949"><span class="annot"><span class="annottext">CekValue uni fun ann
</span><a href="#local-6989586621681866949"><span class="hs-identifier hs-var">arg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-733"></span><span>        </span><span class="annot"><span class="annottext">Context uni fun ann
-&gt; CekValue uni fun ann
-&gt; CekValue uni fun ann
-&gt; CekM uni fun s (Term NamedDeBruijn uni fun ())
</span><a href="#local-6989586621681866950"><span class="hs-identifier hs-var">applyEvaluate</span></a></span><span> </span><span class="annot"><span class="annottext">Context uni fun ann
</span><a href="#local-6989586621681866948"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">CekValue uni fun ann
</span><a href="#local-6989586621681866947"><span class="hs-identifier hs-var">fun</span></a></span><span> </span><span class="annot"><span class="annottext">CekValue uni fun ann
</span><a href="#local-6989586621681866949"><span class="hs-identifier hs-var">arg</span></a></span><span>
</span><span id="line-734"></span><span>    </span><span class="hs-comment">-- s , [_ V] &#9669; lam x (M,&#961;)  &#8614;  s ; &#961; [ x  &#8614;  V ] &#9659; M</span><span>
</span><span id="line-735"></span><span>    </span><span class="annot"><a href="#local-6989586621681866903"><span class="hs-identifier hs-var">returnCek</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#FrameAwaitFunValue"><span class="hs-identifier hs-type">FrameAwaitFunValue</span></a></span><span> </span><span id="local-6989586621681866951"><span class="annot"><span class="annottext">CekValue uni fun ann
</span><a href="#local-6989586621681866951"><span class="hs-identifier hs-var">arg</span></a></span></span><span> </span><span id="local-6989586621681866952"><span class="annot"><span class="annottext">Context uni fun ann
</span><a href="#local-6989586621681866952"><span class="hs-identifier hs-var">ctx</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621681866953"><span class="annot"><span class="annottext">CekValue uni fun ann
</span><a href="#local-6989586621681866953"><span class="hs-identifier hs-var">fun</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-736"></span><span>        </span><span class="annot"><span class="annottext">Context uni fun ann
-&gt; CekValue uni fun ann
-&gt; CekValue uni fun ann
-&gt; CekM uni fun s (Term NamedDeBruijn uni fun ())
</span><a href="#local-6989586621681866950"><span class="hs-identifier hs-var">applyEvaluate</span></a></span><span> </span><span class="annot"><span class="annottext">Context uni fun ann
</span><a href="#local-6989586621681866952"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">CekValue uni fun ann
</span><a href="#local-6989586621681866953"><span class="hs-identifier hs-var">fun</span></a></span><span> </span><span class="annot"><span class="annottext">CekValue uni fun ann
</span><a href="#local-6989586621681866951"><span class="hs-identifier hs-var">arg</span></a></span><span>
</span><span id="line-737"></span><span>    </span><span class="hs-comment">-- s , constr I V0 ... Vj-1 _ (Tj+1 ... Tn, &#961;) &#9669; Vj  &#8614;  s , constr i V0 ... Vj _ (Tj+2... Tn, &#961;)  ; &#961; &#9659; Tj+1</span><span>
</span><span id="line-738"></span><span>    </span><span class="annot"><a href="#local-6989586621681866903"><span class="hs-identifier hs-var">returnCek</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#FrameConstr"><span class="hs-identifier hs-type">FrameConstr</span></a></span><span> </span><span id="local-6989586621681866954"><span class="annot"><span class="annottext">CekValEnv uni fun ann
</span><a href="#local-6989586621681866954"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621681866955"><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621681866955"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span id="local-6989586621681866956"><span class="annot"><span class="annottext">[NTerm uni fun ann]
</span><a href="#local-6989586621681866956"><span class="hs-identifier hs-var">todo</span></a></span></span><span> </span><span id="local-6989586621681866957"><span class="annot"><span class="annottext">ArgStack uni fun ann
</span><a href="#local-6989586621681866957"><span class="hs-identifier hs-var">done</span></a></span></span><span> </span><span id="local-6989586621681866958"><span class="annot"><span class="annottext">Context uni fun ann
</span><a href="#local-6989586621681866958"><span class="hs-identifier hs-var">ctx</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621681866959"><span class="annot"><span class="annottext">CekValue uni fun ann
</span><a href="#local-6989586621681866959"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-739"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681866960"><span class="annot"><span class="annottext">done' :: ArgStack uni fun ann
</span><a href="#local-6989586621681866960"><span class="hs-identifier hs-var hs-var">done'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CekValue uni fun ann
-&gt; ArgStack uni fun ann -&gt; ArgStack uni fun ann
forall (uni :: * -&gt; *) fun ann.
CekValue uni fun ann
-&gt; ArgStack uni fun ann -&gt; ArgStack uni fun ann
</span><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#ConsStack"><span class="hs-identifier hs-var">ConsStack</span></a></span><span> </span><span class="annot"><span class="annottext">CekValue uni fun ann
</span><a href="#local-6989586621681866959"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="annot"><span class="annottext">ArgStack uni fun ann
</span><a href="#local-6989586621681866957"><span class="hs-identifier hs-var">done</span></a></span><span>
</span><span id="line-740"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">[NTerm uni fun ann]
</span><a href="#local-6989586621681866956"><span class="hs-identifier hs-var">todo</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-741"></span><span>          </span><span class="hs-special">(</span><span id="local-6989586621681866961"><span class="annot"><span class="annottext">NTerm uni fun ann
</span><a href="#local-6989586621681866961"><span class="hs-identifier hs-var">next</span></a></span></span><span> </span><span class="annot"><a href="../../../ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#%3A"><span class="hs-glyph hs-type">:</span></a></span><span> </span><span id="local-6989586621681866962"><span class="annot"><span class="annottext">[NTerm uni fun ann]
</span><a href="#local-6989586621681866962"><span class="hs-identifier hs-var">todo'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Context uni fun ann
-&gt; CekValEnv uni fun ann
-&gt; NTerm uni fun ann
-&gt; CekM uni fun s (Term NamedDeBruijn uni fun ())
</span><a href="#local-6989586621681866896"><span class="hs-identifier hs-var">computeCek</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CekValEnv uni fun ann
-&gt; Word64
-&gt; [NTerm uni fun ann]
-&gt; ArgStack uni fun ann
-&gt; Context uni fun ann
-&gt; Context uni fun ann
forall (uni :: * -&gt; *) fun ann.
CekValEnv uni fun ann
-&gt; Word64
-&gt; [NTerm uni fun ann]
-&gt; ArgStack uni fun ann
-&gt; Context uni fun ann
-&gt; Context uni fun ann
</span><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#FrameConstr"><span class="hs-identifier hs-var">FrameConstr</span></a></span><span> </span><span class="annot"><span class="annottext">CekValEnv uni fun ann
</span><a href="#local-6989586621681866954"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621681866955"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">[NTerm uni fun ann]
</span><a href="#local-6989586621681866962"><span class="hs-identifier hs-var">todo'</span></a></span><span> </span><span class="annot"><span class="annottext">ArgStack uni fun ann
</span><a href="#local-6989586621681866960"><span class="hs-identifier hs-var">done'</span></a></span><span> </span><span class="annot"><span class="annottext">Context uni fun ann
</span><a href="#local-6989586621681866958"><span class="hs-identifier hs-var">ctx</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CekValEnv uni fun ann
</span><a href="#local-6989586621681866954"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">NTerm uni fun ann
</span><a href="#local-6989586621681866961"><span class="hs-identifier hs-var">next</span></a></span><span>
</span><span id="line-742"></span><span>          </span><span class="hs-special">[</span><span class="hs-special">]</span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Context uni fun ann
-&gt; CekValue uni fun ann
-&gt; CekM uni fun s (Term NamedDeBruijn uni fun ())
</span><a href="#local-6989586621681866903"><span class="hs-identifier hs-var">returnCek</span></a></span><span> </span><span class="annot"><span class="annottext">Context uni fun ann
</span><a href="#local-6989586621681866958"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">(CekValue uni fun ann
 -&gt; CekM uni fun s (Term NamedDeBruijn uni fun ()))
-&gt; CekValue uni fun ann
-&gt; CekM uni fun s (Term NamedDeBruijn uni fun ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; ArgStack uni fun ann -&gt; CekValue uni fun ann
forall (uni :: * -&gt; *) fun ann.
Word64 -&gt; ArgStack uni fun ann -&gt; CekValue uni fun ann
</span><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#VConstr"><span class="hs-identifier hs-var">VConstr</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621681866955"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">ArgStack uni fun ann
</span><a href="#local-6989586621681866960"><span class="hs-identifier hs-var">done'</span></a></span><span>
</span><span id="line-743"></span><span>    </span><span class="hs-comment">-- s , case _ (C0 ... CN, &#961;) &#9669; constr i V1 .. Vm  &#8614;  s , [_ V1 ... Vm] ; &#961; &#9659; Ci</span><span>
</span><span id="line-744"></span><span>    </span><span class="annot"><a href="#local-6989586621681866903"><span class="hs-identifier hs-var">returnCek</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#FrameCases"><span class="hs-identifier hs-type">FrameCases</span></a></span><span> </span><span id="local-6989586621681866963"><span class="annot"><span class="annottext">CekValEnv uni fun ann
</span><a href="#local-6989586621681866963"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621681866964"><span class="annot"><span class="annottext">Vector (NTerm uni fun ann)
</span><a href="#local-6989586621681866964"><span class="hs-identifier hs-var">cs</span></a></span></span><span> </span><span id="local-6989586621681866965"><span class="annot"><span class="annottext">Context uni fun ann
</span><a href="#local-6989586621681866965"><span class="hs-identifier hs-var">ctx</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621681866966"><span class="annot"><span class="annottext">CekValue uni fun ann
</span><a href="#local-6989586621681866966"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">CekValue uni fun ann
</span><a href="#local-6989586621681866966"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-745"></span><span>        </span><span class="hs-comment">-- If the index is larger than the max bound of an Int, or negative, then it's a bad index</span><span>
</span><span id="line-746"></span><span>        </span><span class="hs-comment">-- As it happens, this will currently never trigger, since i is a Word64, and the largest</span><span>
</span><span id="line-747"></span><span>        </span><span class="hs-comment">-- Word64 value wraps to -1 as an Int64. So you can't wrap around enough to get an</span><span>
</span><span id="line-748"></span><span>        </span><span class="hs-comment">-- &quot;apparently good&quot; value.</span><span>
</span><span id="line-749"></span><span>        </span><span class="hs-special">(</span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#VConstr"><span class="hs-identifier hs-type">VConstr</span></a></span><span> </span><span id="local-6989586621681866967"><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621681866967"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span class="annot"><span class="annottext">ArgStack uni fun ann
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><a href="../../../ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Real.html#fromIntegral"><span class="hs-identifier hs-var">fromIntegral</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="../../../ghc-9.6.6/html/libraries/ghc-bignum-1.3/src/GHC.Num.Integer.html#Integer"><span class="hs-identifier hs-type">Integer</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621681866967"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">Integer -&gt; Integer -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><a href="../../../ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3E"><span class="hs-operator hs-var">&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><a href="../../../ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Real.html#fromIntegral"><span class="hs-identifier hs-var">fromIntegral</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="../../../ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Int"><span class="hs-identifier hs-type">Int</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="../../../ghc-9.6.6/html/libraries/ghc-bignum-1.3/src/GHC.Num.Integer.html#Integer"><span class="hs-identifier hs-type">Integer</span></a></span><span> </span><span class="annot"><span class="annottext">Int
forall a. Bounded a =&gt; a
</span><a href="../../../ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Enum.html#maxBound"><span class="hs-identifier hs-var">maxBound</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-750"></span><span>                        </span><span class="annot"><span class="annottext">AReview
  (EvaluationError (MachineError fun) CekUserError)
  (MachineError fun)
-&gt; MachineError fun
-&gt; CekValue uni fun ann
-&gt; CekM uni fun s (Term NamedDeBruijn uni fun ())
forall (uni :: * -&gt; *) fun t ann s x.
ThrowableBuiltins uni fun =&gt;
AReview (EvaluationError (MachineError fun) CekUserError) t
-&gt; t -&gt; CekValue uni fun ann -&gt; CekM uni fun s x
</span><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#throwingDischarged"><span class="hs-identifier hs-var">throwingDischarged</span></a></span><span> </span><span class="annot"><span class="annottext">AReview
  (EvaluationError (MachineError fun) CekUserError)
  (MachineError fun)
forall r fun. AsMachineError r fun =&gt; Prism' r (MachineError fun)
Prism'
  (EvaluationError (MachineError fun) CekUserError)
  (MachineError fun)
</span><a href="PlutusCore.Evaluation.Machine.Exception.html#_MachineError"><span class="hs-identifier hs-var">_MachineError</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word64 -&gt; MachineError fun
forall fun. Word64 -&gt; MachineError fun
</span><a href="PlutusCore.Evaluation.Machine.Exception.html#MissingCaseBranch"><span class="hs-identifier hs-var">MissingCaseBranch</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621681866967"><span class="hs-identifier hs-var">i</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CekValue uni fun ann
</span><a href="#local-6989586621681866966"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-751"></span><span>        </span><span class="hs-comment">-- Otherwise, we can safely convert the index to an Int and use it</span><span>
</span><span id="line-752"></span><span>        </span><span class="hs-special">(</span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#VConstr"><span class="hs-identifier hs-type">VConstr</span></a></span><span> </span><span id="local-6989586621681866972"><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621681866972"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span id="local-6989586621681866973"><span class="annot"><span class="annottext">ArgStack uni fun ann
</span><a href="#local-6989586621681866973"><span class="hs-identifier hs-var">args</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Vector (NTerm uni fun ann) -&gt; Int -&gt; Maybe (NTerm uni fun ann)
forall a. Vector a -&gt; Int -&gt; Maybe a
</span><span class="hs-operator hs-var">(V.!?)</span></span><span> </span><span class="annot"><span class="annottext">Vector (NTerm uni fun ann)
</span><a href="#local-6989586621681866964"><span class="hs-identifier hs-var">cs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word64 -&gt; Int
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><a href="../../../ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Real.html#fromIntegral"><span class="hs-identifier hs-var">fromIntegral</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621681866972"><span class="hs-identifier hs-var">i</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-753"></span><span>            </span><span class="annot"><a href="../../../ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621681866975"><span class="annot"><span class="annottext">NTerm uni fun ann
</span><a href="#local-6989586621681866975"><span class="hs-identifier hs-var">t</span></a></span></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Context uni fun ann
-&gt; CekValEnv uni fun ann
-&gt; NTerm uni fun ann
-&gt; CekM uni fun s (Term NamedDeBruijn uni fun ())
</span><a href="#local-6989586621681866896"><span class="hs-identifier hs-var">computeCek</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ArgStack uni fun ann -&gt; Context uni fun ann -&gt; Context uni fun ann
forall (uni :: * -&gt; *) fun ann.
ArgStack uni fun ann -&gt; Context uni fun ann -&gt; Context uni fun ann
</span><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#transferArgStack"><span class="hs-identifier hs-var">transferArgStack</span></a></span><span> </span><span class="annot"><span class="annottext">ArgStack uni fun ann
</span><a href="#local-6989586621681866973"><span class="hs-identifier hs-var">args</span></a></span><span> </span><span class="annot"><span class="annottext">Context uni fun ann
</span><a href="#local-6989586621681866965"><span class="hs-identifier hs-var">ctx</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CekValEnv uni fun ann
</span><a href="#local-6989586621681866963"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">NTerm uni fun ann
</span><a href="#local-6989586621681866975"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-754"></span><span>            </span><span class="annot"><span class="annottext">Maybe (NTerm uni fun ann)
</span><a href="../../../ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">AReview
  (EvaluationError (MachineError fun) CekUserError)
  (MachineError fun)
-&gt; MachineError fun
-&gt; CekValue uni fun ann
-&gt; CekM uni fun s (Term NamedDeBruijn uni fun ())
forall (uni :: * -&gt; *) fun t ann s x.
ThrowableBuiltins uni fun =&gt;
AReview (EvaluationError (MachineError fun) CekUserError) t
-&gt; t -&gt; CekValue uni fun ann -&gt; CekM uni fun s x
</span><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#throwingDischarged"><span class="hs-identifier hs-var">throwingDischarged</span></a></span><span> </span><span class="annot"><span class="annottext">AReview
  (EvaluationError (MachineError fun) CekUserError)
  (MachineError fun)
forall r fun. AsMachineError r fun =&gt; Prism' r (MachineError fun)
Prism'
  (EvaluationError (MachineError fun) CekUserError)
  (MachineError fun)
</span><a href="PlutusCore.Evaluation.Machine.Exception.html#_MachineError"><span class="hs-identifier hs-var">_MachineError</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word64 -&gt; MachineError fun
forall fun. Word64 -&gt; MachineError fun
</span><a href="PlutusCore.Evaluation.Machine.Exception.html#MissingCaseBranch"><span class="hs-identifier hs-var">MissingCaseBranch</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621681866972"><span class="hs-identifier hs-var">i</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CekValue uni fun ann
</span><a href="#local-6989586621681866966"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-755"></span><span>        </span><span class="annot"><span class="annottext">CekValue uni fun ann
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">AReview
  (EvaluationError (MachineError fun) CekUserError)
  (MachineError fun)
-&gt; MachineError fun
-&gt; CekValue uni fun ann
-&gt; CekM uni fun s (Term NamedDeBruijn uni fun ())
forall (uni :: * -&gt; *) fun t ann s x.
ThrowableBuiltins uni fun =&gt;
AReview (EvaluationError (MachineError fun) CekUserError) t
-&gt; t -&gt; CekValue uni fun ann -&gt; CekM uni fun s x
</span><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#throwingDischarged"><span class="hs-identifier hs-var">throwingDischarged</span></a></span><span> </span><span class="annot"><span class="annottext">AReview
  (EvaluationError (MachineError fun) CekUserError)
  (MachineError fun)
forall r fun. AsMachineError r fun =&gt; Prism' r (MachineError fun)
Prism'
  (EvaluationError (MachineError fun) CekUserError)
  (MachineError fun)
</span><a href="PlutusCore.Evaluation.Machine.Exception.html#_MachineError"><span class="hs-identifier hs-var">_MachineError</span></a></span><span> </span><span class="annot"><span class="annottext">MachineError fun
forall fun. MachineError fun
</span><a href="PlutusCore.Evaluation.Machine.Exception.html#NonConstrScrutinized"><span class="hs-identifier hs-var">NonConstrScrutinized</span></a></span><span> </span><span class="annot"><span class="annottext">CekValue uni fun ann
</span><a href="#local-6989586621681866966"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-756"></span><span>
</span><span id="line-757"></span><span>    </span><span class="hs-comment">-- | Evaluate a 'HeadSpine' by pushing the arguments (if any) onto the stack and proceeding with</span><span>
</span><span id="line-758"></span><span>    </span><span class="hs-comment">-- the returning phase of the CEK machine.</span><span>
</span><span id="line-759"></span><span>    </span><span class="annot"><a href="#local-6989586621681866977"><span class="hs-identifier hs-type">returnCekHeadSpine</span></a></span><span>
</span><span id="line-760"></span><span>        </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#Context"><span class="hs-identifier hs-type">Context</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865721"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865722"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865723"><span class="hs-identifier hs-type">ann</span></a></span><span>
</span><span id="line-761"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="PlutusCore.Builtin.KnownType.html#HeadSpine"><span class="hs-identifier hs-type">HeadSpine</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#CekValue"><span class="hs-identifier hs-type">CekValue</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865721"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865722"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865723"><span class="hs-identifier hs-type">ann</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-762"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#CekM"><span class="hs-identifier hs-type">CekM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865721"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865722"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865724"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="UntypedPlutusCore.Core.Type.html#Term"><span class="hs-identifier hs-type">Term</span></a></span><span> </span><span class="annot"><a href="PlutusCore.DeBruijn.Internal.html#NamedDeBruijn"><span class="hs-identifier hs-type">NamedDeBruijn</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865721"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865722"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-763"></span><span>    </span><span id="local-6989586621681866977"><span class="annot"><span class="annottext">returnCekHeadSpine :: Context uni fun ann
-&gt; HeadSpine (CekValue uni fun ann)
-&gt; CekM uni fun s (Term NamedDeBruijn uni fun ())
</span><a href="#local-6989586621681866977"><span class="hs-identifier hs-var hs-var">returnCekHeadSpine</span></a></span></span><span> </span><span id="local-6989586621681866978"><span class="annot"><span class="annottext">Context uni fun ann
</span><a href="#local-6989586621681866978"><span class="hs-identifier hs-var">ctx</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PlutusCore.Builtin.KnownType.html#HeadOnly"><span class="hs-identifier hs-type">HeadOnly</span></a></span><span>  </span><span id="local-6989586621681866980"><span class="annot"><span class="annottext">CekValue uni fun ann
</span><a href="#local-6989586621681866980"><span class="hs-identifier hs-var">x</span></a></span></span><span class="hs-special">)</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Context uni fun ann
-&gt; CekValue uni fun ann
-&gt; CekM uni fun s (Term NamedDeBruijn uni fun ())
</span><a href="#local-6989586621681866903"><span class="hs-identifier hs-var">returnCek</span></a></span><span> </span><span class="annot"><span class="annottext">Context uni fun ann
</span><a href="#local-6989586621681866978"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">CekValue uni fun ann
</span><a href="#local-6989586621681866980"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-764"></span><span>    </span><span class="annot"><a href="#local-6989586621681866977"><span class="hs-identifier hs-var">returnCekHeadSpine</span></a></span><span> </span><span id="local-6989586621681866981"><span class="annot"><span class="annottext">Context uni fun ann
</span><a href="#local-6989586621681866981"><span class="hs-identifier hs-var">ctx</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PlutusCore.Builtin.KnownType.html#HeadSpine"><span class="hs-identifier hs-type">HeadSpine</span></a></span><span> </span><span id="local-6989586621681866983"><span class="annot"><span class="annottext">CekValue uni fun ann
</span><a href="#local-6989586621681866983"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span id="local-6989586621681866984"><span class="annot"><span class="annottext">Spine (CekValue uni fun ann)
</span><a href="#local-6989586621681866984"><span class="hs-identifier hs-var">xs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Context uni fun ann
-&gt; CekValue uni fun ann
-&gt; CekM uni fun s (Term NamedDeBruijn uni fun ())
</span><a href="#local-6989586621681866903"><span class="hs-identifier hs-var">returnCek</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Spine (CekValue uni fun ann)
-&gt; Context uni fun ann -&gt; Context uni fun ann
forall (uni :: * -&gt; *) fun ann.
Spine (CekValue uni fun ann)
-&gt; Context uni fun ann -&gt; Context uni fun ann
</span><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#transferSpine"><span class="hs-identifier hs-var">transferSpine</span></a></span><span> </span><span class="annot"><span class="annottext">Spine (CekValue uni fun ann)
</span><a href="#local-6989586621681866984"><span class="hs-identifier hs-var">xs</span></a></span><span> </span><span class="annot"><span class="annottext">Context uni fun ann
</span><a href="#local-6989586621681866981"><span class="hs-identifier hs-var">ctx</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CekValue uni fun ann
</span><a href="#local-6989586621681866983"><span class="hs-identifier hs-var">f</span></a></span><span>
</span><span id="line-765"></span><span>
</span><span id="line-766"></span><span>    </span><span class="hs-comment">-- | @force@ a term and proceed.</span><span>
</span><span id="line-767"></span><span>    </span><span class="hs-comment">-- If v is a delay then compute the body of v;</span><span>
</span><span id="line-768"></span><span>    </span><span class="hs-comment">-- if v is a builtin application then check that it's expecting a type argument,</span><span>
</span><span id="line-769"></span><span>    </span><span class="hs-comment">-- and either calculate the builtin application or stick a 'Force' on top of its 'Term'</span><span>
</span><span id="line-770"></span><span>    </span><span class="hs-comment">-- representation depending on whether the application is saturated or not,</span><span>
</span><span id="line-771"></span><span>    </span><span class="hs-comment">-- if v is anything else, fail.</span><span>
</span><span id="line-772"></span><span>    </span><span class="annot"><a href="#local-6989586621681866942"><span class="hs-identifier hs-type">forceEvaluate</span></a></span><span>
</span><span id="line-773"></span><span>        </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#Context"><span class="hs-identifier hs-type">Context</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865721"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865722"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865723"><span class="hs-identifier hs-type">ann</span></a></span><span>
</span><span id="line-774"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#CekValue"><span class="hs-identifier hs-type">CekValue</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865721"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865722"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865723"><span class="hs-identifier hs-type">ann</span></a></span><span>
</span><span id="line-775"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#CekM"><span class="hs-identifier hs-type">CekM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865721"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865722"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865724"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#NTerm"><span class="hs-identifier hs-type">NTerm</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865721"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865722"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-776"></span><span>    </span><span id="local-6989586621681866942"><span class="annot"><span class="annottext">forceEvaluate :: Context uni fun ann
-&gt; CekValue uni fun ann
-&gt; CekM uni fun s (Term NamedDeBruijn uni fun ())
</span><a href="#local-6989586621681866942"><span class="hs-identifier hs-var hs-var">forceEvaluate</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621681866985"><span class="annot"><span class="annottext">Context uni fun ann
</span><a href="#local-6989586621681866985"><span class="hs-identifier hs-var">ctx</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#VDelay"><span class="hs-identifier hs-type">VDelay</span></a></span><span> </span><span id="local-6989586621681866986"><span class="annot"><span class="annottext">NTerm uni fun ann
</span><a href="#local-6989586621681866986"><span class="hs-identifier hs-var">body</span></a></span></span><span> </span><span id="local-6989586621681866987"><span class="annot"><span class="annottext">CekValEnv uni fun ann
</span><a href="#local-6989586621681866987"><span class="hs-identifier hs-var">env</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Context uni fun ann
-&gt; CekValEnv uni fun ann
-&gt; NTerm uni fun ann
-&gt; CekM uni fun s (Term NamedDeBruijn uni fun ())
</span><a href="#local-6989586621681866896"><span class="hs-identifier hs-var">computeCek</span></a></span><span> </span><span class="annot"><span class="annottext">Context uni fun ann
</span><a href="#local-6989586621681866985"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">CekValEnv uni fun ann
</span><a href="#local-6989586621681866987"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">NTerm uni fun ann
</span><a href="#local-6989586621681866986"><span class="hs-identifier hs-var">body</span></a></span><span>
</span><span id="line-777"></span><span>    </span><span class="annot"><a href="#local-6989586621681866942"><span class="hs-identifier hs-var">forceEvaluate</span></a></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621681866988"><span class="annot"><span class="annottext">Context uni fun ann
</span><a href="#local-6989586621681866988"><span class="hs-identifier hs-var">ctx</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#VBuiltin"><span class="hs-identifier hs-type">VBuiltin</span></a></span><span> </span><span id="local-6989586621681866989"><span class="annot"><span class="annottext">fun
</span><a href="#local-6989586621681866989"><span class="hs-identifier hs-var">fun</span></a></span></span><span> </span><span id="local-6989586621681866990"><span class="annot"><span class="annottext">Term NamedDeBruijn uni fun ()
</span><a href="#local-6989586621681866990"><span class="hs-identifier hs-var">term</span></a></span></span><span> </span><span id="local-6989586621681866991"><span class="annot"><span class="annottext">BuiltinRuntime (CekValue uni fun ann)
</span><a href="#local-6989586621681866991"><span class="hs-identifier hs-var">runtime</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-778"></span><span>        </span><span class="hs-comment">-- @term@ is fully discharged, and so @term'@ is, hence we can put it in a 'VBuiltin'.</span><span>
</span><span id="line-779"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681866992"><span class="annot"><span class="annottext">term' :: Term NamedDeBruijn uni fun ()
</span><a href="#local-6989586621681866992"><span class="hs-identifier hs-var hs-var">term'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">()
-&gt; Term NamedDeBruijn uni fun () -&gt; Term NamedDeBruijn uni fun ()
forall name (uni :: * -&gt; *) fun ann.
ann -&gt; Term name uni fun ann -&gt; Term name uni fun ann
</span><a href="UntypedPlutusCore.Core.Type.html#Force"><span class="hs-identifier hs-var">Force</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Term NamedDeBruijn uni fun ()
</span><a href="#local-6989586621681866990"><span class="hs-identifier hs-var">term</span></a></span><span>
</span><span id="line-780"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">BuiltinRuntime (CekValue uni fun ann)
</span><a href="#local-6989586621681866991"><span class="hs-identifier hs-var">runtime</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-781"></span><span>            </span><span class="hs-comment">-- It's only possible to force a builtin application if the builtin expects a type</span><span>
</span><span id="line-782"></span><span>            </span><span class="hs-comment">-- argument next.</span><span>
</span><span id="line-783"></span><span>            </span><span class="annot"><a href="PlutusCore.Builtin.Runtime.html#BuiltinExpectForce"><span class="hs-identifier hs-type">BuiltinExpectForce</span></a></span><span> </span><span id="local-6989586621681866994"><span class="annot"><span class="annottext">BuiltinRuntime (CekValue uni fun ann)
</span><a href="#local-6989586621681866994"><span class="hs-identifier hs-var">runtime'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-784"></span><span>                </span><span class="hs-comment">-- We allow a type argument to appear last in the type of a built-in function,</span><span>
</span><span id="line-785"></span><span>                </span><span class="hs-comment">-- otherwise we could just assemble a 'VBuiltin' without trying to evaluate the</span><span>
</span><span id="line-786"></span><span>                </span><span class="hs-comment">-- application.</span><span>
</span><span id="line-787"></span><span>                </span><span class="annot"><span class="annottext">Context uni fun ann
-&gt; fun
-&gt; Term NamedDeBruijn uni fun ()
-&gt; BuiltinRuntime (CekValue uni fun ann)
-&gt; CekM uni fun s (Term NamedDeBruijn uni fun ())
</span><a href="#local-6989586621681866995"><span class="hs-identifier hs-var">evalBuiltinApp</span></a></span><span> </span><span class="annot"><span class="annottext">Context uni fun ann
</span><a href="#local-6989586621681866988"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">fun
</span><a href="#local-6989586621681866989"><span class="hs-identifier hs-var">fun</span></a></span><span> </span><span class="annot"><span class="annottext">Term NamedDeBruijn uni fun ()
</span><a href="#local-6989586621681866992"><span class="hs-identifier hs-var">term'</span></a></span><span> </span><span class="annot"><span class="annottext">BuiltinRuntime (CekValue uni fun ann)
</span><a href="#local-6989586621681866994"><span class="hs-identifier hs-var">runtime'</span></a></span><span>
</span><span id="line-788"></span><span>            </span><span class="annot"><span class="annottext">BuiltinRuntime (CekValue uni fun ann)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-789"></span><span>                </span><span class="annot"><span class="annottext">AReview
  (EvaluationError (MachineError fun) CekUserError)
  (MachineError fun)
-&gt; MachineError fun
-&gt; Maybe (Term NamedDeBruijn uni fun ())
-&gt; CekM uni fun s (Term NamedDeBruijn uni fun ())
forall exc e t term (m :: * -&gt; *) x.
(exc ~ ErrorWithCause e term, MonadError exc m) =&gt;
AReview e t -&gt; t -&gt; Maybe term -&gt; m x
</span><a href="PlutusCore.Evaluation.ErrorWithCause.html#throwingWithCause"><span class="hs-identifier hs-var">throwingWithCause</span></a></span><span> </span><span class="annot"><span class="annottext">AReview
  (EvaluationError (MachineError fun) CekUserError)
  (MachineError fun)
forall r fun. AsMachineError r fun =&gt; Prism' r (MachineError fun)
Prism'
  (EvaluationError (MachineError fun) CekUserError)
  (MachineError fun)
</span><a href="PlutusCore.Evaluation.Machine.Exception.html#_MachineError"><span class="hs-identifier hs-var">_MachineError</span></a></span><span> </span><span class="annot"><span class="annottext">MachineError fun
forall fun. MachineError fun
</span><a href="PlutusCore.Evaluation.Machine.Exception.html#BuiltinTermArgumentExpectedMachineError"><span class="hs-identifier hs-var">BuiltinTermArgumentExpectedMachineError</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Term NamedDeBruijn uni fun ()
-&gt; Maybe (Term NamedDeBruijn uni fun ())
forall a. a -&gt; Maybe a
</span><a href="../../../ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">Term NamedDeBruijn uni fun ()
</span><a href="#local-6989586621681866992"><span class="hs-identifier hs-var">term'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-790"></span><span>    </span><span class="annot"><a href="#local-6989586621681866942"><span class="hs-identifier hs-var">forceEvaluate</span></a></span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="annottext">Context uni fun ann
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621681866997"><span class="annot"><span class="annottext">CekValue uni fun ann
</span><a href="#local-6989586621681866997"><span class="hs-identifier hs-var">val</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-791"></span><span>        </span><span class="annot"><span class="annottext">AReview
  (EvaluationError (MachineError fun) CekUserError)
  (MachineError fun)
-&gt; MachineError fun
-&gt; CekValue uni fun ann
-&gt; CekM uni fun s (Term NamedDeBruijn uni fun ())
forall (uni :: * -&gt; *) fun t ann s x.
ThrowableBuiltins uni fun =&gt;
AReview (EvaluationError (MachineError fun) CekUserError) t
-&gt; t -&gt; CekValue uni fun ann -&gt; CekM uni fun s x
</span><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#throwingDischarged"><span class="hs-identifier hs-var">throwingDischarged</span></a></span><span> </span><span class="annot"><span class="annottext">AReview
  (EvaluationError (MachineError fun) CekUserError)
  (MachineError fun)
forall r fun. AsMachineError r fun =&gt; Prism' r (MachineError fun)
Prism'
  (EvaluationError (MachineError fun) CekUserError)
  (MachineError fun)
</span><a href="PlutusCore.Evaluation.Machine.Exception.html#_MachineError"><span class="hs-identifier hs-var">_MachineError</span></a></span><span> </span><span class="annot"><span class="annottext">MachineError fun
forall fun. MachineError fun
</span><a href="PlutusCore.Evaluation.Machine.Exception.html#NonPolymorphicInstantiationMachineError"><span class="hs-identifier hs-var">NonPolymorphicInstantiationMachineError</span></a></span><span> </span><span class="annot"><span class="annottext">CekValue uni fun ann
</span><a href="#local-6989586621681866997"><span class="hs-identifier hs-var">val</span></a></span><span>
</span><span id="line-792"></span><span>
</span><span id="line-793"></span><span>    </span><span class="hs-comment">-- | Apply a function to an argument and proceed.</span><span>
</span><span id="line-794"></span><span>    </span><span class="hs-comment">-- If the function is a lambda 'lam x ty body' then extend the environment with a binding of @v@</span><span>
</span><span id="line-795"></span><span>    </span><span class="hs-comment">-- to x@ and call 'computeCek' on the body.</span><span>
</span><span id="line-796"></span><span>    </span><span class="hs-comment">-- If the function is a builtin application then check that it's expecting a term argument,</span><span>
</span><span id="line-797"></span><span>    </span><span class="hs-comment">-- and either calculate the builtin application or stick a 'Apply' on top of its 'Term'</span><span>
</span><span id="line-798"></span><span>    </span><span class="hs-comment">-- representation depending on whether the application is saturated or not.</span><span>
</span><span id="line-799"></span><span>    </span><span class="hs-comment">-- If v is anything else, fail.</span><span>
</span><span id="line-800"></span><span>    </span><span class="annot"><a href="#local-6989586621681866950"><span class="hs-identifier hs-type">applyEvaluate</span></a></span><span>
</span><span id="line-801"></span><span>        </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#Context"><span class="hs-identifier hs-type">Context</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865721"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865722"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865723"><span class="hs-identifier hs-type">ann</span></a></span><span>
</span><span id="line-802"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#CekValue"><span class="hs-identifier hs-type">CekValue</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865721"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865722"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865723"><span class="hs-identifier hs-type">ann</span></a></span><span>   </span><span class="hs-comment">-- lhs of application</span><span>
</span><span id="line-803"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#CekValue"><span class="hs-identifier hs-type">CekValue</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865721"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865722"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865723"><span class="hs-identifier hs-type">ann</span></a></span><span>   </span><span class="hs-comment">-- rhs of application</span><span>
</span><span id="line-804"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#CekM"><span class="hs-identifier hs-type">CekM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865721"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865722"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865724"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#NTerm"><span class="hs-identifier hs-type">NTerm</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865721"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865722"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-805"></span><span>    </span><span id="local-6989586621681866950"><span class="annot"><span class="annottext">applyEvaluate :: Context uni fun ann
-&gt; CekValue uni fun ann
-&gt; CekValue uni fun ann
-&gt; CekM uni fun s (Term NamedDeBruijn uni fun ())
</span><a href="#local-6989586621681866950"><span class="hs-identifier hs-var hs-var">applyEvaluate</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621681866999"><span class="annot"><span class="annottext">Context uni fun ann
</span><a href="#local-6989586621681866999"><span class="hs-identifier hs-var">ctx</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#VLamAbs"><span class="hs-identifier hs-type">VLamAbs</span></a></span><span> </span><span class="annot"><span class="annottext">NamedDeBruijn
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621681867000"><span class="annot"><span class="annottext">NTerm uni fun ann
</span><a href="#local-6989586621681867000"><span class="hs-identifier hs-var">body</span></a></span></span><span> </span><span id="local-6989586621681867001"><span class="annot"><span class="annottext">CekValEnv uni fun ann
</span><a href="#local-6989586621681867001"><span class="hs-identifier hs-var">env</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621681867002"><span class="annot"><span class="annottext">CekValue uni fun ann
</span><a href="#local-6989586621681867002"><span class="hs-identifier hs-var">arg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-806"></span><span>        </span><span class="annot"><span class="annottext">Context uni fun ann
-&gt; CekValEnv uni fun ann
-&gt; NTerm uni fun ann
-&gt; CekM uni fun s (Term NamedDeBruijn uni fun ())
</span><a href="#local-6989586621681866896"><span class="hs-identifier hs-var">computeCek</span></a></span><span> </span><span class="annot"><span class="annottext">Context uni fun ann
</span><a href="#local-6989586621681866999"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Element (CekValEnv uni fun ann)
-&gt; CekValEnv uni fun ann -&gt; CekValEnv uni fun ann
forall e. RandomAccessList e =&gt; Element e -&gt; e -&gt; e
</span><span class="hs-identifier hs-var">Env.cons</span></span><span> </span><span class="annot"><span class="annottext">Element (CekValEnv uni fun ann)
CekValue uni fun ann
</span><a href="#local-6989586621681867002"><span class="hs-identifier hs-var">arg</span></a></span><span> </span><span class="annot"><span class="annottext">CekValEnv uni fun ann
</span><a href="#local-6989586621681867001"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">NTerm uni fun ann
</span><a href="#local-6989586621681867000"><span class="hs-identifier hs-var">body</span></a></span><span>
</span><span id="line-807"></span><span>    </span><span class="hs-comment">-- Annotating @f@ and @exF@ with bangs gave us some speed-up, but only until we added a bang to</span><span>
</span><span id="line-808"></span><span>    </span><span class="hs-comment">-- 'VCon'. After that the bangs here were making things a tiny bit slower and so we removed them.</span><span>
</span><span id="line-809"></span><span>    </span><span class="annot"><a href="#local-6989586621681866950"><span class="hs-identifier hs-var">applyEvaluate</span></a></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621681867004"><span class="annot"><span class="annottext">Context uni fun ann
</span><a href="#local-6989586621681867004"><span class="hs-identifier hs-var">ctx</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#VBuiltin"><span class="hs-identifier hs-type">VBuiltin</span></a></span><span> </span><span id="local-6989586621681867005"><span class="annot"><span class="annottext">fun
</span><a href="#local-6989586621681867005"><span class="hs-identifier hs-var">fun</span></a></span></span><span> </span><span id="local-6989586621681867006"><span class="annot"><span class="annottext">Term NamedDeBruijn uni fun ()
</span><a href="#local-6989586621681867006"><span class="hs-identifier hs-var">term</span></a></span></span><span> </span><span id="local-6989586621681867007"><span class="annot"><span class="annottext">BuiltinRuntime (CekValue uni fun ann)
</span><a href="#local-6989586621681867007"><span class="hs-identifier hs-var">runtime</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621681867008"><span class="annot"><span class="annottext">CekValue uni fun ann
</span><a href="#local-6989586621681867008"><span class="hs-identifier hs-var">arg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-810"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681867009"><span class="annot"><span class="annottext">argTerm :: Term NamedDeBruijn uni fun ()
</span><a href="#local-6989586621681867009"><span class="hs-identifier hs-var hs-var">argTerm</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CekValue uni fun ann -&gt; Term NamedDeBruijn uni fun ()
forall (uni :: * -&gt; *) fun ann.
CekValue uni fun ann -&gt; NTerm uni fun ()
</span><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#dischargeCekValue"><span class="hs-identifier hs-var">dischargeCekValue</span></a></span><span> </span><span class="annot"><span class="annottext">CekValue uni fun ann
</span><a href="#local-6989586621681867008"><span class="hs-identifier hs-var">arg</span></a></span><span>
</span><span id="line-811"></span><span>            </span><span class="hs-comment">-- @term@ and @argTerm@ are fully discharged, and so @term'@ is, hence we can put it</span><span>
</span><span id="line-812"></span><span>            </span><span class="hs-comment">-- in a 'VBuiltin'.</span><span>
</span><span id="line-813"></span><span>            </span><span id="local-6989586621681867010"><span class="annot"><span class="annottext">term' :: Term NamedDeBruijn uni fun ()
</span><a href="#local-6989586621681867010"><span class="hs-identifier hs-var hs-var">term'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">()
-&gt; Term NamedDeBruijn uni fun ()
-&gt; Term NamedDeBruijn uni fun ()
-&gt; Term NamedDeBruijn uni fun ()
forall name (uni :: * -&gt; *) fun ann.
ann
-&gt; Term name uni fun ann
-&gt; Term name uni fun ann
-&gt; Term name uni fun ann
</span><a href="UntypedPlutusCore.Core.Type.html#Apply"><span class="hs-identifier hs-var">Apply</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Term NamedDeBruijn uni fun ()
</span><a href="#local-6989586621681867006"><span class="hs-identifier hs-var">term</span></a></span><span> </span><span class="annot"><span class="annottext">Term NamedDeBruijn uni fun ()
</span><a href="#local-6989586621681867009"><span class="hs-identifier hs-var">argTerm</span></a></span><span>
</span><span id="line-814"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">BuiltinRuntime (CekValue uni fun ann)
</span><a href="#local-6989586621681867007"><span class="hs-identifier hs-var">runtime</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-815"></span><span>            </span><span class="hs-comment">-- It's only possible to apply a builtin application if the builtin expects a term</span><span>
</span><span id="line-816"></span><span>            </span><span class="hs-comment">-- argument next.</span><span>
</span><span id="line-817"></span><span>            </span><span class="annot"><a href="PlutusCore.Builtin.Runtime.html#BuiltinExpectArgument"><span class="hs-identifier hs-type">BuiltinExpectArgument</span></a></span><span> </span><span id="local-6989586621681867012"><span class="annot"><span class="annottext">CekValue uni fun ann -&gt; BuiltinRuntime (CekValue uni fun ann)
</span><a href="#local-6989586621681867012"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-818"></span><span>                </span><span class="annot"><span class="annottext">Context uni fun ann
-&gt; fun
-&gt; Term NamedDeBruijn uni fun ()
-&gt; BuiltinRuntime (CekValue uni fun ann)
-&gt; CekM uni fun s (Term NamedDeBruijn uni fun ())
</span><a href="#local-6989586621681866995"><span class="hs-identifier hs-var">evalBuiltinApp</span></a></span><span> </span><span class="annot"><span class="annottext">Context uni fun ann
</span><a href="#local-6989586621681867004"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">fun
</span><a href="#local-6989586621681867005"><span class="hs-identifier hs-var">fun</span></a></span><span> </span><span class="annot"><span class="annottext">Term NamedDeBruijn uni fun ()
</span><a href="#local-6989586621681867010"><span class="hs-identifier hs-var">term'</span></a></span><span> </span><span class="annot"><span class="annottext">(BuiltinRuntime (CekValue uni fun ann)
 -&gt; CekM uni fun s (Term NamedDeBruijn uni fun ()))
-&gt; BuiltinRuntime (CekValue uni fun ann)
-&gt; CekM uni fun s (Term NamedDeBruijn uni fun ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">CekValue uni fun ann -&gt; BuiltinRuntime (CekValue uni fun ann)
</span><a href="#local-6989586621681867012"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">CekValue uni fun ann
</span><a href="#local-6989586621681867008"><span class="hs-identifier hs-var">arg</span></a></span><span>
</span><span id="line-819"></span><span>            </span><span class="annot"><span class="annottext">BuiltinRuntime (CekValue uni fun ann)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-820"></span><span>                </span><span class="annot"><span class="annottext">AReview
  (EvaluationError (MachineError fun) CekUserError)
  (MachineError fun)
-&gt; MachineError fun
-&gt; Maybe (Term NamedDeBruijn uni fun ())
-&gt; CekM uni fun s (Term NamedDeBruijn uni fun ())
forall exc e t term (m :: * -&gt; *) x.
(exc ~ ErrorWithCause e term, MonadError exc m) =&gt;
AReview e t -&gt; t -&gt; Maybe term -&gt; m x
</span><a href="PlutusCore.Evaluation.ErrorWithCause.html#throwingWithCause"><span class="hs-identifier hs-var">throwingWithCause</span></a></span><span> </span><span class="annot"><span class="annottext">AReview
  (EvaluationError (MachineError fun) CekUserError)
  (MachineError fun)
forall r fun. AsMachineError r fun =&gt; Prism' r (MachineError fun)
Prism'
  (EvaluationError (MachineError fun) CekUserError)
  (MachineError fun)
</span><a href="PlutusCore.Evaluation.Machine.Exception.html#_MachineError"><span class="hs-identifier hs-var">_MachineError</span></a></span><span> </span><span class="annot"><span class="annottext">MachineError fun
forall fun. MachineError fun
</span><a href="PlutusCore.Evaluation.Machine.Exception.html#UnexpectedBuiltinTermArgumentMachineError"><span class="hs-identifier hs-var">UnexpectedBuiltinTermArgumentMachineError</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Term NamedDeBruijn uni fun ()
-&gt; Maybe (Term NamedDeBruijn uni fun ())
forall a. a -&gt; Maybe a
</span><a href="../../../ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">Term NamedDeBruijn uni fun ()
</span><a href="#local-6989586621681867010"><span class="hs-identifier hs-var">term'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-821"></span><span>    </span><span class="annot"><a href="#local-6989586621681866950"><span class="hs-identifier hs-var">applyEvaluate</span></a></span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="annottext">Context uni fun ann
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621681867014"><span class="annot"><span class="annottext">CekValue uni fun ann
</span><a href="#local-6989586621681867014"><span class="hs-identifier hs-var">val</span></a></span></span><span> </span><span class="annot"><span class="annottext">CekValue uni fun ann
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-822"></span><span>        </span><span class="annot"><span class="annottext">AReview
  (EvaluationError (MachineError fun) CekUserError)
  (MachineError fun)
-&gt; MachineError fun
-&gt; CekValue uni fun ann
-&gt; CekM uni fun s (Term NamedDeBruijn uni fun ())
forall (uni :: * -&gt; *) fun t ann s x.
ThrowableBuiltins uni fun =&gt;
AReview (EvaluationError (MachineError fun) CekUserError) t
-&gt; t -&gt; CekValue uni fun ann -&gt; CekM uni fun s x
</span><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#throwingDischarged"><span class="hs-identifier hs-var">throwingDischarged</span></a></span><span> </span><span class="annot"><span class="annottext">AReview
  (EvaluationError (MachineError fun) CekUserError)
  (MachineError fun)
forall r fun. AsMachineError r fun =&gt; Prism' r (MachineError fun)
Prism'
  (EvaluationError (MachineError fun) CekUserError)
  (MachineError fun)
</span><a href="PlutusCore.Evaluation.Machine.Exception.html#_MachineError"><span class="hs-identifier hs-var">_MachineError</span></a></span><span> </span><span class="annot"><span class="annottext">MachineError fun
forall fun. MachineError fun
</span><a href="PlutusCore.Evaluation.Machine.Exception.html#NonFunctionalApplicationMachineError"><span class="hs-identifier hs-var">NonFunctionalApplicationMachineError</span></a></span><span> </span><span class="annot"><span class="annottext">CekValue uni fun ann
</span><a href="#local-6989586621681867014"><span class="hs-identifier hs-var">val</span></a></span><span>
</span><span id="line-823"></span><span>
</span><span id="line-824"></span><span>    </span><span class="hs-comment">-- | Spend the budget that has been accumulated for a number of machine steps.</span><span>
</span><span id="line-825"></span><span>    </span><span class="annot"><a href="#local-6989586621681866939"><span class="hs-identifier hs-type">spendAccumulatedBudget</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#CekM"><span class="hs-identifier hs-type">CekM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865721"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865722"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865724"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-826"></span><span>    </span><span id="local-6989586621681866939"><span class="annot"><span class="annottext">spendAccumulatedBudget :: CekM uni fun s ()
</span><a href="#local-6989586621681866939"><span class="hs-identifier hs-var hs-var">spendAccumulatedBudget</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-827"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681867017"><span class="annot"><span class="annottext">ctr :: StepCounter 10 s
</span><a href="#local-6989586621681867017"><span class="hs-identifier hs-var hs-var">ctr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">?cekStepCounter::StepCounter 10 s
StepCounter 10 s
</span><a href="#local-6989586621681867016"><span class="hs-var">?cekStepCounter</span></a></span><span>
</span><span id="line-828"></span><span>        </span><span class="annot"><span class="annottext">StepCounter 10 (PrimState (CekM uni fun s))
-&gt; (Int -&gt; Slippage -&gt; CekM uni fun s ()) -&gt; CekM uni fun s ()
forall (m :: * -&gt; *) (n :: Nat).
(UpwardsM m (NatToPeano n), PrimMonad m) =&gt;
StepCounter n (PrimState m) -&gt; (Int -&gt; Slippage -&gt; m ()) -&gt; m ()
</span><a href="UntypedPlutusCore.Evaluation.Machine.Cek.StepCounter.html#iforCounter_"><span class="hs-identifier hs-var">iforCounter_</span></a></span><span> </span><span class="annot"><span class="annottext">StepCounter 10 s
StepCounter 10 (PrimState (CekM uni fun s))
</span><a href="#local-6989586621681867017"><span class="hs-identifier hs-var">ctr</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Slippage -&gt; CekM uni fun s ()
</span><a href="#local-6989586621681867019"><span class="hs-identifier hs-var">spend</span></a></span><span>
</span><span id="line-829"></span><span>        </span><span class="annot"><span class="annottext">StepCounter 10 (PrimState (CekM uni fun s)) -&gt; CekM uni fun s ()
forall (n :: Nat) (m :: * -&gt; *).
(KnownNat n, PrimMonad m) =&gt;
StepCounter n (PrimState m) -&gt; m ()
</span><a href="UntypedPlutusCore.Evaluation.Machine.Cek.StepCounter.html#resetCounter"><span class="hs-identifier hs-var">resetCounter</span></a></span><span> </span><span class="annot"><span class="annottext">StepCounter 10 s
StepCounter 10 (PrimState (CekM uni fun s))
</span><a href="#local-6989586621681867017"><span class="hs-identifier hs-var">ctr</span></a></span><span>
</span><span id="line-830"></span><span>    </span><span class="hs-comment">-- It's very important for this definition not to get inlined. Inlining it caused performance to</span><span>
</span><span id="line-831"></span><span>    </span><span class="hs-comment">-- degrade by 16+%: https://github.com/IntersectMBO/plutus/pull/5931</span><span>
</span><span id="line-832"></span><span>    </span><span class="hs-pragma">{-# OPAQUE</span><span> </span><span class="annot"><a href="#local-6989586621681866939"><span class="hs-pragma hs-type">spendAccumulatedBudget</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-833"></span><span>
</span><span id="line-834"></span><span>    </span><span class="hs-comment">-- Making this a definition of its own causes it to inline better than actually writing it inline, for</span><span>
</span><span id="line-835"></span><span>    </span><span class="hs-comment">-- some reason.</span><span>
</span><span id="line-836"></span><span>    </span><span class="hs-comment">-- Skip index 7, that's the total counter!</span><span>
</span><span id="line-837"></span><span>    </span><span class="hs-comment">-- See Note [Structure of the step counter]</span><span>
</span><span id="line-838"></span><span>    </span><span id="local-6989586621681867019"><span class="annot"><span class="annottext">spend :: Int -&gt; Slippage -&gt; CekM uni fun s ()
</span><a href="#local-6989586621681867019"><span class="hs-identifier hs-var hs-var">spend</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621681867021"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681867021"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621681867022"><span class="annot"><span class="annottext">Slippage
</span><a href="#local-6989586621681867022"><span class="hs-identifier hs-var">w</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; CekM uni fun s () -&gt; CekM uni fun s ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><a href="../../../ghc-9.6.6/html/libraries/base-4.18.2.1/src/Control.Monad.html#unless"><span class="hs-identifier hs-var">unless</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681867021"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="../../../ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3D%3D"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Integer -&gt; Int
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><a href="../../../ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Real.html#fromIntegral"><span class="hs-identifier hs-var">fromIntegral</span></a></span><span> </span><span class="annot"><span class="annottext">(Integer -&gt; Int) -&gt; Integer -&gt; Int
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Proxy 9 -&gt; Integer
forall (n :: Nat) (proxy :: Nat -&gt; *).
KnownNat n =&gt;
proxy n -&gt; Integer
</span><a href="../../../ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.TypeLits.html#natVal"><span class="hs-identifier hs-var">natVal</span></a></span><span> </span><span class="annot"><span class="annottext">(Proxy 9 -&gt; Integer) -&gt; Proxy 9 -&gt; Integer
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">forall (t :: Nat). Proxy t
forall {k} (t :: k). Proxy t
</span><a href="../../../ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.Proxy.html#Proxy"><span class="hs-identifier hs-var">Proxy</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#TotalCountIndex"><span class="hs-identifier hs-type">TotalCountIndex</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(CekM uni fun s () -&gt; CekM uni fun s ())
-&gt; CekM uni fun s () -&gt; CekM uni fun s ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-839"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681867024"><span class="annot"><span class="annottext">kind :: StepKind
</span><a href="#local-6989586621681867024"><span class="hs-identifier hs-var hs-var">kind</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; StepKind
forall a. Enum a =&gt; Int -&gt; a
</span><a href="../../../ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Enum.html#toEnum"><span class="hs-identifier hs-var">toEnum</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681867021"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">ExBudgetCategory fun -&gt; ExBudget -&gt; CekM uni fun s ()
</span><a href="#local-6989586621681867026"><span class="hs-identifier hs-var">spendBudget</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StepKind -&gt; ExBudgetCategory fun
forall fun. StepKind -&gt; ExBudgetCategory fun
</span><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#BStep"><span class="hs-identifier hs-var">BStep</span></a></span><span> </span><span class="annot"><span class="annottext">StepKind
</span><a href="#local-6989586621681867024"><span class="hs-identifier hs-var">kind</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Slippage -&gt; ExBudget -&gt; ExBudget
forall b. Integral b =&gt; b -&gt; ExBudget -&gt; ExBudget
forall a b. (Semigroup a, Integral b) =&gt; b -&gt; a -&gt; a
</span><a href="../../../ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#stimes"><span class="hs-identifier hs-var">stimes</span></a></span><span> </span><span class="annot"><span class="annottext">Slippage
</span><a href="#local-6989586621681867022"><span class="hs-identifier hs-var">w</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CekMachineCosts -&gt; StepKind -&gt; ExBudget
</span><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#cekStepCost"><span class="hs-identifier hs-var">cekStepCost</span></a></span><span> </span><span class="annot"><span class="annottext">?cekCosts::CekMachineCosts
CekMachineCosts
</span><a href="#local-6989586621681866774"><span class="hs-var">?cekCosts</span></a></span><span> </span><span class="annot"><span class="annottext">StepKind
</span><a href="#local-6989586621681867024"><span class="hs-identifier hs-var">kind</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-840"></span><span>    </span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="#local-6989586621681867019"><span class="hs-pragma hs-type">spend</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-841"></span><span>
</span><span id="line-842"></span><span>    </span><span class="hs-comment">-- | Accumulate a step, and maybe spend the budget that has accumulated for a number of machine steps, but only if we've exceeded our slippage.</span><span>
</span><span id="line-843"></span><span>    </span><span class="annot"><a href="#local-6989586621681866900"><span class="hs-identifier hs-type">stepAndMaybeSpend</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#StepKind"><span class="hs-identifier hs-type">StepKind</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#CekM"><span class="hs-identifier hs-type">CekM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865721"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865722"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865724"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-844"></span><span>    </span><span id="local-6989586621681866900"><span class="annot"><span class="annottext">stepAndMaybeSpend :: StepKind -&gt; CekM uni fun s ()
</span><a href="#local-6989586621681866900"><span class="hs-identifier hs-var hs-var">stepAndMaybeSpend</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621681867027"><span class="annot"><span class="annottext">StepKind
</span><a href="#local-6989586621681867027"><span class="hs-identifier hs-var">kind</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-845"></span><span>        </span><span class="hs-comment">-- See Note [Structure of the step counter]</span><span>
</span><span id="line-846"></span><span>        </span><span class="hs-comment">-- This generates let-expressions in GHC Core, however all of them bind unboxed things and</span><span>
</span><span id="line-847"></span><span>        </span><span class="hs-comment">-- so they don't survive further compilation, see https://stackoverflow.com/a/14090277</span><span>
</span><span id="line-848"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621681867028"><span class="annot"><span class="annottext">counterIndex :: Int
</span><a href="#local-6989586621681867028"><span class="hs-identifier hs-var hs-var">counterIndex</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StepKind -&gt; Int
forall a. Enum a =&gt; a -&gt; Int
</span><a href="../../../ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Enum.html#fromEnum"><span class="hs-identifier hs-var">fromEnum</span></a></span><span> </span><span class="annot"><span class="annottext">StepKind
</span><a href="#local-6989586621681867027"><span class="hs-identifier hs-var">kind</span></a></span><span>
</span><span id="line-849"></span><span>            </span><span id="local-6989586621681867031"><span class="annot"><span class="annottext">ctr :: StepCounter 10 s
</span><a href="#local-6989586621681867031"><span class="hs-identifier hs-var hs-var">ctr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">?cekStepCounter::StepCounter 10 s
StepCounter 10 s
</span><a href="#local-6989586621681867030"><span class="hs-var">?cekStepCounter</span></a></span><span>
</span><span id="line-850"></span><span>            </span><span class="hs-glyph">!</span><span id="local-6989586621681867035"><span class="annot"><span class="annottext">totalStepIndex :: Int
</span><a href="#local-6989586621681867035"><span class="hs-identifier hs-var hs-var">totalStepIndex</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Integer -&gt; Int
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><a href="../../../ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Real.html#fromIntegral"><span class="hs-identifier hs-var">fromIntegral</span></a></span><span> </span><span class="annot"><span class="annottext">(Integer -&gt; Int) -&gt; Integer -&gt; Int
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Proxy 9 -&gt; Integer
forall (n :: Nat) (proxy :: Nat -&gt; *).
KnownNat n =&gt;
proxy n -&gt; Integer
</span><a href="../../../ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.TypeLits.html#natVal"><span class="hs-identifier hs-var">natVal</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (t :: Nat). Proxy t
forall {k} (t :: k). Proxy t
</span><a href="../../../ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.Proxy.html#Proxy"><span class="hs-identifier hs-var">Proxy</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#TotalCountIndex"><span class="hs-identifier hs-type">TotalCountIndex</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-851"></span><span>        </span><span class="hs-glyph">!</span><span id="local-6989586621681867036"><span class="annot"><span class="annottext">Slippage
</span><a href="#local-6989586621681867036"><span class="hs-identifier hs-var">unbudgetedStepsTotal</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>  </span><span class="annot"><span class="annottext">Int
-&gt; (Slippage -&gt; Slippage)
-&gt; StepCounter 10 (PrimState (CekM uni fun s))
-&gt; CekM uni fun s Slippage
forall (m :: * -&gt; *) (n :: Nat).
PrimMonad m =&gt;
Int
-&gt; (Slippage -&gt; Slippage)
-&gt; StepCounter n (PrimState m)
-&gt; m Slippage
</span><a href="UntypedPlutusCore.Evaluation.Machine.Cek.StepCounter.html#modifyCounter"><span class="hs-identifier hs-var">modifyCounter</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681867035"><span class="hs-identifier hs-var">totalStepIndex</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Slippage -&gt; Slippage -&gt; Slippage
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../../../ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Num.html#%2B"><span class="hs-operator hs-var">+</span></a></span><span class="annot"><span class="annottext">Slippage
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">StepCounter 10 s
StepCounter 10 (PrimState (CekM uni fun s))
</span><a href="#local-6989586621681867031"><span class="hs-identifier hs-var">ctr</span></a></span><span>
</span><span id="line-852"></span><span>        </span><span class="annot"><span class="annottext">Slippage
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Int
-&gt; (Slippage -&gt; Slippage)
-&gt; StepCounter 10 (PrimState (CekM uni fun s))
-&gt; CekM uni fun s Slippage
forall (m :: * -&gt; *) (n :: Nat).
PrimMonad m =&gt;
Int
-&gt; (Slippage -&gt; Slippage)
-&gt; StepCounter n (PrimState m)
-&gt; m Slippage
</span><a href="UntypedPlutusCore.Evaluation.Machine.Cek.StepCounter.html#modifyCounter"><span class="hs-identifier hs-var">modifyCounter</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681867028"><span class="hs-identifier hs-var">counterIndex</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Slippage -&gt; Slippage -&gt; Slippage
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../../../ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Num.html#%2B"><span class="hs-operator hs-var">+</span></a></span><span class="annot"><span class="annottext">Slippage
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">StepCounter 10 s
StepCounter 10 (PrimState (CekM uni fun s))
</span><a href="#local-6989586621681867031"><span class="hs-identifier hs-var">ctr</span></a></span><span>
</span><span id="line-853"></span><span>        </span><span class="hs-comment">-- There's no risk of overflow here, since we only ever increment the total</span><span>
</span><span id="line-854"></span><span>        </span><span class="hs-comment">-- steps by 1 and then check this condition.</span><span>
</span><span id="line-855"></span><span>        </span><span class="annot"><span class="annottext">Bool -&gt; CekM uni fun s () -&gt; CekM uni fun s ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><a href="../../../ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#when"><span class="hs-identifier hs-var">when</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Slippage
</span><a href="#local-6989586621681867036"><span class="hs-identifier hs-var">unbudgetedStepsTotal</span></a></span><span> </span><span class="annot"><span class="annottext">Slippage -&gt; Slippage -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><a href="../../../ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3E%3D"><span class="hs-operator hs-var">&gt;=</span></a></span><span> </span><span class="annot"><span class="annottext">?cekSlippage::Slippage
Slippage
</span><a href="#local-6989586621681866794"><span class="hs-var">?cekSlippage</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CekM uni fun s ()
</span><a href="#local-6989586621681866939"><span class="hs-identifier hs-var">spendAccumulatedBudget</span></a></span><span>
</span><span id="line-856"></span><span>    </span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="#local-6989586621681866900"><span class="hs-pragma hs-type">stepAndMaybeSpend</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-857"></span><span>
</span><span id="line-858"></span><span>    </span><span class="hs-comment">-- | Take a possibly partial builtin application and</span><span>
</span><span id="line-859"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-860"></span><span>    </span><span class="hs-comment">-- - either create a 'CekValue' by evaluating the application if it's saturated (emitting logs,</span><span>
</span><span id="line-861"></span><span>    </span><span class="hs-comment">--    if any, along the way), potentially failing evaluation</span><span>
</span><span id="line-862"></span><span>    </span><span class="hs-comment">-- - or create a partial builtin application otherwise</span><span>
</span><span id="line-863"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-864"></span><span>    </span><span class="hs-comment">-- and proceed with the returning phase of the CEK machine.</span><span>
</span><span id="line-865"></span><span>    </span><span class="annot"><a href="#local-6989586621681866995"><span class="hs-identifier hs-type">evalBuiltinApp</span></a></span><span>
</span><span id="line-866"></span><span>        </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#Context"><span class="hs-identifier hs-type">Context</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865721"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865722"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865723"><span class="hs-identifier hs-type">ann</span></a></span><span>
</span><span id="line-867"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621681865722"><span class="hs-identifier hs-type">fun</span></a></span><span>
</span><span id="line-868"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#NTerm"><span class="hs-identifier hs-type">NTerm</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865721"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865722"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-869"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="PlutusCore.Builtin.Runtime.html#BuiltinRuntime"><span class="hs-identifier hs-type">BuiltinRuntime</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#CekValue"><span class="hs-identifier hs-type">CekValue</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865721"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865722"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865723"><span class="hs-identifier hs-type">ann</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-870"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#CekM"><span class="hs-identifier hs-type">CekM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865721"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865722"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865724"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="UntypedPlutusCore.Core.Type.html#Term"><span class="hs-identifier hs-type">Term</span></a></span><span> </span><span class="annot"><a href="PlutusCore.DeBruijn.Internal.html#NamedDeBruijn"><span class="hs-identifier hs-type">NamedDeBruijn</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865721"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865722"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-871"></span><span>    </span><span id="local-6989586621681866995"><span class="annot"><span class="annottext">evalBuiltinApp :: Context uni fun ann
-&gt; fun
-&gt; Term NamedDeBruijn uni fun ()
-&gt; BuiltinRuntime (CekValue uni fun ann)
-&gt; CekM uni fun s (Term NamedDeBruijn uni fun ())
</span><a href="#local-6989586621681866995"><span class="hs-identifier hs-var hs-var">evalBuiltinApp</span></a></span></span><span> </span><span id="local-6989586621681867038"><span class="annot"><span class="annottext">Context uni fun ann
</span><a href="#local-6989586621681867038"><span class="hs-identifier hs-var">ctx</span></a></span></span><span> </span><span id="local-6989586621681867039"><span class="annot"><span class="annottext">fun
</span><a href="#local-6989586621681867039"><span class="hs-identifier hs-var">fun</span></a></span></span><span> </span><span id="local-6989586621681867040"><span class="annot"><span class="annottext">Term NamedDeBruijn uni fun ()
</span><a href="#local-6989586621681867040"><span class="hs-identifier hs-var">term</span></a></span></span><span> </span><span id="local-6989586621681867041"><span class="annot"><span class="annottext">BuiltinRuntime (CekValue uni fun ann)
</span><a href="#local-6989586621681867041"><span class="hs-identifier hs-var">runtime</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">BuiltinRuntime (CekValue uni fun ann)
</span><a href="#local-6989586621681867041"><span class="hs-identifier hs-var">runtime</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-872"></span><span>        </span><span class="annot"><a href="PlutusCore.Builtin.Runtime.html#BuiltinCostedResult"><span class="hs-identifier hs-type">BuiltinCostedResult</span></a></span><span> </span><span id="local-6989586621681867043"><span class="annot"><span class="annottext">ExBudgetStream
</span><a href="#local-6989586621681867043"><span class="hs-identifier hs-var">budgets0</span></a></span></span><span> </span><span id="local-6989586621681867044"><span class="annot"><span class="annottext">BuiltinResult (HeadSpine (CekValue uni fun ann))
</span><a href="#local-6989586621681867044"><span class="hs-identifier hs-var">getFXs</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-873"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681867045"><span class="annot"><span class="annottext">exCat :: ExBudgetCategory fun
</span><a href="#local-6989586621681867045"><span class="hs-identifier hs-var hs-var">exCat</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">fun -&gt; ExBudgetCategory fun
forall fun. fun -&gt; ExBudgetCategory fun
</span><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#BBuiltinApp"><span class="hs-identifier hs-var">BBuiltinApp</span></a></span><span> </span><span class="annot"><span class="annottext">fun
</span><a href="#local-6989586621681867039"><span class="hs-identifier hs-var">fun</span></a></span><span>
</span><span id="line-874"></span><span>                </span><span id="local-6989586621681867046"><span class="annot"><span class="annottext">spendBudgets :: ExBudgetStream -&gt; CekM uni fun s ()
</span><a href="#local-6989586621681867046"><span class="hs-identifier hs-var hs-var">spendBudgets</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PlutusCore.Evaluation.Machine.ExBudgetStream.html#ExBudgetLast"><span class="hs-identifier hs-type">ExBudgetLast</span></a></span><span> </span><span id="local-6989586621681867048"><span class="annot"><span class="annottext">ExBudget
</span><a href="#local-6989586621681867048"><span class="hs-identifier hs-var">budget</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ExBudgetCategory fun -&gt; ExBudget -&gt; CekM uni fun s ()
</span><a href="#local-6989586621681867026"><span class="hs-identifier hs-var">spendBudget</span></a></span><span> </span><span class="annot"><span class="annottext">ExBudgetCategory fun
</span><a href="#local-6989586621681867045"><span class="hs-identifier hs-var">exCat</span></a></span><span> </span><span class="annot"><span class="annottext">ExBudget
</span><a href="#local-6989586621681867048"><span class="hs-identifier hs-var">budget</span></a></span><span>
</span><span id="line-875"></span><span>                </span><span class="annot"><a href="#local-6989586621681867046"><span class="hs-identifier hs-var">spendBudgets</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PlutusCore.Evaluation.Machine.ExBudgetStream.html#ExBudgetCons"><span class="hs-identifier hs-type">ExBudgetCons</span></a></span><span> </span><span id="local-6989586621681867050"><span class="annot"><span class="annottext">ExBudget
</span><a href="#local-6989586621681867050"><span class="hs-identifier hs-var">budget</span></a></span></span><span> </span><span id="local-6989586621681867051"><span class="annot"><span class="annottext">ExBudgetStream
</span><a href="#local-6989586621681867051"><span class="hs-identifier hs-var">budgets</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-876"></span><span>                    </span><span class="annot"><span class="annottext">ExBudgetCategory fun -&gt; ExBudget -&gt; CekM uni fun s ()
</span><a href="#local-6989586621681867026"><span class="hs-identifier hs-var">spendBudget</span></a></span><span> </span><span class="annot"><span class="annottext">ExBudgetCategory fun
</span><a href="#local-6989586621681867045"><span class="hs-identifier hs-var">exCat</span></a></span><span> </span><span class="annot"><span class="annottext">ExBudget
</span><a href="#local-6989586621681867050"><span class="hs-identifier hs-var">budget</span></a></span><span> </span><span class="annot"><span class="annottext">CekM uni fun s () -&gt; CekM uni fun s () -&gt; CekM uni fun s ()
forall a b.
CekM uni fun s a -&gt; CekM uni fun s b -&gt; CekM uni fun s b
forall (f :: * -&gt; *) a b. Applicative f =&gt; f a -&gt; f b -&gt; f b
</span><a href="../../../ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%2A%3E"><span class="hs-operator hs-var">*&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">ExBudgetStream -&gt; CekM uni fun s ()
</span><a href="#local-6989586621681867046"><span class="hs-identifier hs-var">spendBudgets</span></a></span><span> </span><span class="annot"><span class="annottext">ExBudgetStream
</span><a href="#local-6989586621681867051"><span class="hs-identifier hs-var">budgets</span></a></span><span>
</span><span id="line-877"></span><span>            </span><span class="annot"><span class="annottext">ExBudgetStream -&gt; CekM uni fun s ()
</span><a href="#local-6989586621681867046"><span class="hs-identifier hs-var">spendBudgets</span></a></span><span> </span><span class="annot"><span class="annottext">ExBudgetStream
</span><a href="#local-6989586621681867043"><span class="hs-identifier hs-var">budgets0</span></a></span><span>
</span><span id="line-878"></span><span>            </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">BuiltinResult (HeadSpine (CekValue uni fun ann))
</span><a href="#local-6989586621681867044"><span class="hs-identifier hs-var">getFXs</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-879"></span><span>                </span><span class="annot"><a href="PlutusCore.Builtin.Result.html#BuiltinSuccess"><span class="hs-identifier hs-type">BuiltinSuccess</span></a></span><span> </span><span id="local-6989586621681867053"><span class="annot"><span class="annottext">HeadSpine (CekValue uni fun ann)
</span><a href="#local-6989586621681867053"><span class="hs-identifier hs-var">fXs</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-880"></span><span>                    </span><span class="annot"><span class="annottext">Context uni fun ann
-&gt; HeadSpine (CekValue uni fun ann)
-&gt; CekM uni fun s (Term NamedDeBruijn uni fun ())
</span><a href="#local-6989586621681866977"><span class="hs-identifier hs-var">returnCekHeadSpine</span></a></span><span> </span><span class="annot"><span class="annottext">Context uni fun ann
</span><a href="#local-6989586621681867038"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">HeadSpine (CekValue uni fun ann)
</span><a href="#local-6989586621681867053"><span class="hs-identifier hs-var">fXs</span></a></span><span>
</span><span id="line-881"></span><span>                </span><span class="annot"><a href="PlutusCore.Builtin.Result.html#BuiltinSuccessWithLogs"><span class="hs-identifier hs-type">BuiltinSuccessWithLogs</span></a></span><span> </span><span id="local-6989586621681867055"><span class="annot"><span class="annottext">DList Text
</span><a href="#local-6989586621681867055"><span class="hs-identifier hs-var">logs</span></a></span></span><span> </span><span id="local-6989586621681867056"><span class="annot"><span class="annottext">HeadSpine (CekValue uni fun ann)
</span><a href="#local-6989586621681867056"><span class="hs-identifier hs-var">fXs</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-882"></span><span>                    </span><span class="annot"><span class="annottext">?cekEmitter::DList Text -&gt; CekM uni fun s ()
DList Text -&gt; CekM uni fun s ()
</span><a href="#local-6989586621681866811"><span class="hs-var">?cekEmitter</span></a></span><span> </span><span class="annot"><span class="annottext">DList Text
</span><a href="#local-6989586621681867055"><span class="hs-identifier hs-var">logs</span></a></span><span>
</span><span id="line-883"></span><span>                    </span><span class="annot"><span class="annottext">Context uni fun ann
-&gt; HeadSpine (CekValue uni fun ann)
-&gt; CekM uni fun s (Term NamedDeBruijn uni fun ())
</span><a href="#local-6989586621681866977"><span class="hs-identifier hs-var">returnCekHeadSpine</span></a></span><span> </span><span class="annot"><span class="annottext">Context uni fun ann
</span><a href="#local-6989586621681867038"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">HeadSpine (CekValue uni fun ann)
</span><a href="#local-6989586621681867056"><span class="hs-identifier hs-var">fXs</span></a></span><span>
</span><span id="line-884"></span><span>                </span><span class="annot"><a href="PlutusCore.Builtin.Result.html#BuiltinFailure"><span class="hs-identifier hs-type">BuiltinFailure</span></a></span><span> </span><span id="local-6989586621681867058"><span class="annot"><span class="annottext">DList Text
</span><a href="#local-6989586621681867058"><span class="hs-identifier hs-var">logs</span></a></span></span><span> </span><span id="local-6989586621681867059"><span class="annot"><span class="annottext">BuiltinError
</span><a href="#local-6989586621681867059"><span class="hs-identifier hs-var">err</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-885"></span><span>                    </span><span class="annot"><span class="annottext">?cekEmitter::DList Text -&gt; CekM uni fun s ()
DList Text -&gt; CekM uni fun s ()
</span><a href="#local-6989586621681866814"><span class="hs-var">?cekEmitter</span></a></span><span> </span><span class="annot"><span class="annottext">DList Text
</span><a href="#local-6989586621681867058"><span class="hs-identifier hs-var">logs</span></a></span><span>
</span><span id="line-886"></span><span>                    </span><span class="annot"><span class="annottext">Term NamedDeBruijn uni fun ()
-&gt; BuiltinError -&gt; CekM uni fun s (Term NamedDeBruijn uni fun ())
forall err cause (m :: * -&gt; *) void.
(MonadError (ErrorWithCause err cause) m,
 AsUnliftingEvaluationError err, AsEvaluationFailure err) =&gt;
cause -&gt; BuiltinError -&gt; m void
</span><a href="PlutusCore.Evaluation.ErrorWithCause.html#throwBuiltinErrorWithCause"><span class="hs-identifier hs-var">throwBuiltinErrorWithCause</span></a></span><span> </span><span class="annot"><span class="annottext">Term NamedDeBruijn uni fun ()
</span><a href="#local-6989586621681867040"><span class="hs-identifier hs-var">term</span></a></span><span> </span><span class="annot"><span class="annottext">BuiltinError
</span><a href="#local-6989586621681867059"><span class="hs-identifier hs-var">err</span></a></span><span>
</span><span id="line-887"></span><span>        </span><span class="annot"><span class="annottext">BuiltinRuntime (CekValue uni fun ann)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Context uni fun ann
-&gt; CekValue uni fun ann
-&gt; CekM uni fun s (Term NamedDeBruijn uni fun ())
</span><a href="#local-6989586621681866903"><span class="hs-identifier hs-var">returnCek</span></a></span><span> </span><span class="annot"><span class="annottext">Context uni fun ann
</span><a href="#local-6989586621681867038"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">(CekValue uni fun ann
 -&gt; CekM uni fun s (Term NamedDeBruijn uni fun ()))
-&gt; CekValue uni fun ann
-&gt; CekM uni fun s (Term NamedDeBruijn uni fun ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">fun
-&gt; Term NamedDeBruijn uni fun ()
-&gt; BuiltinRuntime (CekValue uni fun ann)
-&gt; CekValue uni fun ann
forall (uni :: * -&gt; *) fun ann.
fun
-&gt; NTerm uni fun ()
-&gt; BuiltinRuntime (CekValue uni fun ann)
-&gt; CekValue uni fun ann
</span><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#VBuiltin"><span class="hs-identifier hs-var">VBuiltin</span></a></span><span> </span><span class="annot"><span class="annottext">fun
</span><a href="#local-6989586621681867039"><span class="hs-identifier hs-var">fun</span></a></span><span> </span><span class="annot"><span class="annottext">Term NamedDeBruijn uni fun ()
</span><a href="#local-6989586621681867040"><span class="hs-identifier hs-var">term</span></a></span><span> </span><span class="annot"><span class="annottext">BuiltinRuntime (CekValue uni fun ann)
</span><a href="#local-6989586621681867041"><span class="hs-identifier hs-var">runtime</span></a></span><span>
</span><span id="line-888"></span><span>    </span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="#local-6989586621681866995"><span class="hs-pragma hs-type">evalBuiltinApp</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-889"></span><span>
</span><span id="line-890"></span><span>    </span><span class="annot"><a href="#local-6989586621681867026"><span class="hs-identifier hs-type">spendBudget</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#ExBudgetCategory"><span class="hs-identifier hs-type">ExBudgetCategory</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865722"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="PlutusCore.Evaluation.Machine.ExBudget.html#ExBudget"><span class="hs-identifier hs-type">ExBudget</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#CekM"><span class="hs-identifier hs-type">CekM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865721"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865722"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865724"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-891"></span><span>    </span><span id="local-6989586621681867026"><span class="annot"><span class="annottext">spendBudget :: ExBudgetCategory fun -&gt; ExBudget -&gt; CekM uni fun s ()
</span><a href="#local-6989586621681867026"><span class="hs-identifier hs-var hs-var">spendBudget</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CekBudgetSpender uni fun s
-&gt; ExBudgetCategory fun -&gt; ExBudget -&gt; CekM uni fun s ()
forall (uni :: * -&gt; *) fun s.
CekBudgetSpender uni fun s
-&gt; ExBudgetCategory fun -&gt; ExBudget -&gt; CekM uni fun s ()
</span><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#unCekBudgetSpender"><span class="hs-identifier hs-var">unCekBudgetSpender</span></a></span><span> </span><span class="annot"><span class="annottext">?cekBudgetSpender::CekBudgetSpender uni fun s
CekBudgetSpender uni fun s
</span><a href="#local-6989586621681866761"><span class="hs-var">?cekBudgetSpender</span></a></span><span>
</span><span id="line-892"></span><span>    </span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="#local-6989586621681867026"><span class="hs-pragma hs-type">spendBudget</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-893"></span><span>
</span><span id="line-894"></span><span>    </span><span class="hs-comment">-- | Look up a variable name in the environment.</span><span>
</span><span id="line-895"></span><span>    </span><span class="annot"><a href="#local-6989586621681866902"><span class="hs-identifier hs-type">lookupVarName</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="PlutusCore.DeBruijn.Internal.html#NamedDeBruijn"><span class="hs-identifier hs-type">NamedDeBruijn</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#CekValEnv"><span class="hs-identifier hs-type">CekValEnv</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865721"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865722"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865723"><span class="hs-identifier hs-type">ann</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#CekM"><span class="hs-identifier hs-type">CekM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865721"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865722"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865724"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#CekValue"><span class="hs-identifier hs-type">CekValue</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865721"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865722"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865723"><span class="hs-identifier hs-type">ann</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-896"></span><span>    </span><span id="local-6989586621681866902"><span class="annot"><span class="annottext">lookupVarName :: NamedDeBruijn
-&gt; CekValEnv uni fun ann -&gt; CekM uni fun s (CekValue uni fun ann)
</span><a href="#local-6989586621681866902"><span class="hs-identifier hs-var hs-var">lookupVarName</span></a></span></span><span> </span><span id="local-6989586621681867061"><span class="annot"><span class="annottext">varName :: NamedDeBruijn
</span><a href="#local-6989586621681867061"><span class="hs-identifier hs-var">varName</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="PlutusCore.DeBruijn.Internal.html#NamedDeBruijn"><span class="hs-identifier hs-type">NamedDeBruijn</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621681867062"><span class="annot"><span class="annottext">Index
</span><a href="#local-6989586621681867062"><span class="hs-identifier hs-var">varIx</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621681867063"><span class="annot"><span class="annottext">CekValEnv uni fun ann
</span><a href="#local-6989586621681867063"><span class="hs-identifier hs-var">varEnv</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-897"></span><span>        </span><span class="annot"><span class="annottext">CekM uni fun s (CekValue uni fun ann)
-&gt; (CekValue uni fun ann -&gt; CekM uni fun s (CekValue uni fun ann))
-&gt; CekValEnv uni fun ann
-&gt; Word64
-&gt; CekM uni fun s (CekValue uni fun ann)
forall a b. b -&gt; (a -&gt; b) -&gt; RAList a -&gt; Word64 -&gt; b
</span><span class="hs-identifier hs-var">Env.contIndexOne</span></span><span>
</span><span id="line-898"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AReview
  (EvaluationError (MachineError fun) CekUserError)
  (MachineError fun)
-&gt; MachineError fun
-&gt; Maybe (Term NamedDeBruijn uni fun ())
-&gt; CekM uni fun s (CekValue uni fun ann)
forall exc e t term (m :: * -&gt; *) x.
(exc ~ ErrorWithCause e term, MonadError exc m) =&gt;
AReview e t -&gt; t -&gt; Maybe term -&gt; m x
</span><a href="PlutusCore.Evaluation.ErrorWithCause.html#throwingWithCause"><span class="hs-identifier hs-var">throwingWithCause</span></a></span><span> </span><span class="annot"><span class="annottext">AReview
  (EvaluationError (MachineError fun) CekUserError)
  (MachineError fun)
forall r fun. AsMachineError r fun =&gt; Prism' r (MachineError fun)
Prism'
  (EvaluationError (MachineError fun) CekUserError)
  (MachineError fun)
</span><a href="PlutusCore.Evaluation.Machine.Exception.html#_MachineError"><span class="hs-identifier hs-var">_MachineError</span></a></span><span> </span><span class="annot"><span class="annottext">MachineError fun
forall fun. MachineError fun
</span><a href="PlutusCore.Evaluation.Machine.Exception.html#OpenTermEvaluatedMachineError"><span class="hs-identifier hs-var">OpenTermEvaluatedMachineError</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe (Term NamedDeBruijn uni fun ())
 -&gt; CekM uni fun s (CekValue uni fun ann))
-&gt; (Term NamedDeBruijn uni fun ()
    -&gt; Maybe (Term NamedDeBruijn uni fun ()))
-&gt; Term NamedDeBruijn uni fun ()
-&gt; CekM uni fun s (CekValue uni fun ann)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">Term NamedDeBruijn uni fun ()
-&gt; Maybe (Term NamedDeBruijn uni fun ())
forall a. a -&gt; Maybe a
</span><a href="../../../ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">(Term NamedDeBruijn uni fun ()
 -&gt; CekM uni fun s (CekValue uni fun ann))
-&gt; Term NamedDeBruijn uni fun ()
-&gt; CekM uni fun s (CekValue uni fun ann)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">() -&gt; NamedDeBruijn -&gt; Term NamedDeBruijn uni fun ()
forall name (uni :: * -&gt; *) fun ann.
ann -&gt; name -&gt; Term name uni fun ann
</span><a href="UntypedPlutusCore.Core.Type.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">NamedDeBruijn
</span><a href="#local-6989586621681867061"><span class="hs-identifier hs-var">varName</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-899"></span><span>            </span><span class="annot"><span class="annottext">CekValue uni fun ann -&gt; CekM uni fun s (CekValue uni fun ann)
forall a. a -&gt; CekM uni fun s a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#pure"><span class="hs-identifier hs-var">pure</span></a></span><span>
</span><span id="line-900"></span><span>            </span><span class="annot"><span class="annottext">CekValEnv uni fun ann
</span><a href="#local-6989586621681867063"><span class="hs-identifier hs-var">varEnv</span></a></span><span>
</span><span id="line-901"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Index -&gt; Word64
forall a b. Coercible a b =&gt; a -&gt; b
</span><a href="../../../ghc-9.6.6/html/libraries/ghc-prim-0.10.0/src/GHC.Prim.html#coerce"><span class="hs-identifier hs-var">coerce</span></a></span><span> </span><span class="annot"><span class="annottext">Index
</span><a href="#local-6989586621681867062"><span class="hs-identifier hs-var">varIx</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-902"></span><span>    </span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="#local-6989586621681866902"><span class="hs-pragma hs-type">lookupVarName</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-903"></span><span>
</span><span id="line-904"></span><span class="hs-comment">-- See Note [Compilation peculiarities].</span><span>
</span><span id="line-905"></span><span class="annot"><span class="hs-comment">-- | Evaluate a term using the CEK machine and keep track of costing, logging is optional.</span></span><span>
</span><span id="line-906"></span><span id="local-6989586621681865787"><span id="local-6989586621681865788"><span id="local-6989586621681865789"><span id="local-6989586621681865790"><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#runCekDeBruijn"><span class="hs-identifier hs-type">runCekDeBruijn</span></a></span><span>
</span><span id="line-907"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="PlutusCore.Pretty.PrettyConst.html#ThrowableBuiltins"><span class="hs-identifier hs-type">ThrowableBuiltins</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865787"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865788"><span class="hs-identifier hs-type">fun</span></a></span><span>
</span><span id="line-908"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="PlutusCore.Evaluation.Machine.MachineParameters.html#MachineParameters"><span class="hs-identifier hs-type">MachineParameters</span></a></span><span> </span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.CekMachineCosts.html#CekMachineCosts"><span class="hs-identifier hs-type">CekMachineCosts</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865788"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#CekValue"><span class="hs-identifier hs-type">CekValue</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865787"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865788"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865789"><span class="hs-identifier hs-type">ann</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-909"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#ExBudgetMode"><span class="hs-identifier hs-type">ExBudgetMode</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865790"><span class="hs-identifier hs-type">cost</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865787"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865788"><span class="hs-identifier hs-type">fun</span></a></span><span>
</span><span id="line-910"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#EmitterMode"><span class="hs-identifier hs-type">EmitterMode</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865787"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865788"><span class="hs-identifier hs-type">fun</span></a></span><span>
</span><span id="line-911"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#NTerm"><span class="hs-identifier hs-type">NTerm</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865787"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865788"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865789"><span class="hs-identifier hs-type">ann</span></a></span><span>
</span><span id="line-912"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.Either.html#Either"><span class="hs-identifier hs-type">Either</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#CekEvaluationException"><span class="hs-identifier hs-type">CekEvaluationException</span></a></span><span> </span><span class="annot"><a href="PlutusCore.DeBruijn.Internal.html#NamedDeBruijn"><span class="hs-identifier hs-type">NamedDeBruijn</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865787"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865788"><span class="hs-identifier hs-type">fun</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#NTerm"><span class="hs-identifier hs-type">NTerm</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865787"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681865788"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621681865790"><span class="hs-identifier hs-type">cost</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="../../../ghc-9.6.6/html/libraries/text-2.0.2/src/Data.Text.Internal.html#Text"><span class="hs-identifier hs-type">Text</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span></span></span></span></span><span>
</span><span id="line-913"></span><span id="runCekDeBruijn"><span class="annot"><span class="annottext">runCekDeBruijn :: forall (uni :: * -&gt; *) fun ann cost.
ThrowableBuiltins uni fun =&gt;
MachineParameters CekMachineCosts fun (CekValue uni fun ann)
-&gt; ExBudgetMode cost uni fun
-&gt; EmitterMode uni fun
-&gt; NTerm uni fun ann
-&gt; (Either
      (CekEvaluationException NamedDeBruijn uni fun) (NTerm uni fun ()),
    cost, [Text])
</span><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#runCekDeBruijn"><span class="hs-identifier hs-var hs-var">runCekDeBruijn</span></a></span></span><span> </span><span id="local-6989586621681867068"><span class="annot"><span class="annottext">MachineParameters CekMachineCosts fun (CekValue uni fun ann)
</span><a href="#local-6989586621681867068"><span class="hs-identifier hs-var">params</span></a></span></span><span> </span><span id="local-6989586621681867069"><span class="annot"><span class="annottext">ExBudgetMode cost uni fun
</span><a href="#local-6989586621681867069"><span class="hs-identifier hs-var">mode</span></a></span></span><span> </span><span id="local-6989586621681867070"><span class="annot"><span class="annottext">EmitterMode uni fun
</span><a href="#local-6989586621681867070"><span class="hs-identifier hs-var">emitMode</span></a></span></span><span> </span><span id="local-6989586621681867071"><span class="annot"><span class="annottext">NTerm uni fun ann
</span><a href="#local-6989586621681867071"><span class="hs-identifier hs-var">term</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-914"></span><span>    </span><span class="annot"><span class="annottext">MachineParameters CekMachineCosts fun (CekValue uni fun ann)
-&gt; ExBudgetMode cost uni fun
-&gt; EmitterMode uni fun
-&gt; (forall {s}.
    GivenCekReqs uni fun ann s =&gt;
    CekM uni fun s (NTerm uni fun ()))
-&gt; (Either
      (ErrorWithCause
         (EvaluationError (MachineError fun) CekUserError)
         (NTerm uni fun ()))
      (NTerm uni fun ()),
    cost, [Text])
forall a cost (uni :: * -&gt; *) fun ann.
ThrowableBuiltins uni fun =&gt;
MachineParameters CekMachineCosts fun (CekValue uni fun ann)
-&gt; ExBudgetMode cost uni fun
-&gt; EmitterMode uni fun
-&gt; (forall s. GivenCekReqs uni fun ann s =&gt; CekM uni fun s a)
-&gt; (Either (CekEvaluationException NamedDeBruijn uni fun) a, cost,
    [Text])
</span><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#runCekM"><span class="hs-identifier hs-var">runCekM</span></a></span><span> </span><span class="annot"><span class="annottext">MachineParameters CekMachineCosts fun (CekValue uni fun ann)
</span><a href="#local-6989586621681867068"><span class="hs-identifier hs-var">params</span></a></span><span> </span><span class="annot"><span class="annottext">ExBudgetMode cost uni fun
</span><a href="#local-6989586621681867069"><span class="hs-identifier hs-var">mode</span></a></span><span> </span><span class="annot"><span class="annottext">EmitterMode uni fun
</span><a href="#local-6989586621681867070"><span class="hs-identifier hs-var">emitMode</span></a></span><span> </span><span class="annot"><span class="annottext">((forall {s}.
  GivenCekReqs uni fun ann s =&gt;
  CekM uni fun s (NTerm uni fun ()))
 -&gt; (Either
       (ErrorWithCause
          (EvaluationError (MachineError fun) CekUserError)
          (NTerm uni fun ()))
       (NTerm uni fun ()),
     cost, [Text]))
-&gt; (forall {s}.
    GivenCekReqs uni fun ann s =&gt;
    CekM uni fun s (NTerm uni fun ()))
-&gt; (Either
      (ErrorWithCause
         (EvaluationError (MachineError fun) CekUserError)
         (NTerm uni fun ()))
      (NTerm uni fun ()),
    cost, [Text])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-915"></span><span>        </span><span class="annot"><span class="annottext">CekBudgetSpender uni fun s
-&gt; ExBudgetCategory fun -&gt; ExBudget -&gt; CekM uni fun s ()
forall (uni :: * -&gt; *) fun s.
CekBudgetSpender uni fun s
-&gt; ExBudgetCategory fun -&gt; ExBudget -&gt; CekM uni fun s ()
</span><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#unCekBudgetSpender"><span class="hs-identifier hs-var">unCekBudgetSpender</span></a></span><span> </span><span class="annot"><span class="annottext">?cekBudgetSpender::CekBudgetSpender uni fun s
CekBudgetSpender uni fun s
</span><a href="#local-6989586621681867074"><span class="hs-var">?cekBudgetSpender</span></a></span><span> </span><span class="annot"><span class="annottext">ExBudgetCategory fun
forall fun. ExBudgetCategory fun
</span><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#BStartup"><span class="hs-identifier hs-var">BStartup</span></a></span><span> </span><span class="annot"><span class="annottext">(ExBudget -&gt; CekM uni fun s ()) -&gt; ExBudget -&gt; CekM uni fun s ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Identity ExBudget -&gt; ExBudget
forall a. Identity a -&gt; a
</span><a href="../../../ghc-9.6.6/html/libraries/base-4.18.2.1/src/Data.Functor.Identity.html#runIdentity"><span class="hs-identifier hs-var">runIdentity</span></a></span><span> </span><span class="annot"><span class="annottext">(Identity ExBudget -&gt; ExBudget) -&gt; Identity ExBudget -&gt; ExBudget
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../ghc-9.6.6/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">CekMachineCosts -&gt; Identity ExBudget
forall (f :: * -&gt; *). CekMachineCostsBase f -&gt; f ExBudget
</span><a href="UntypedPlutusCore.Evaluation.Machine.Cek.CekMachineCosts.html#cekStartupCost"><span class="hs-identifier hs-var">cekStartupCost</span></a></span><span> </span><span class="annot"><span class="annottext">?cekCosts::CekMachineCosts
CekMachineCosts
</span><a href="#local-6989586621681867076"><span class="hs-var">?cekCosts</span></a></span><span>
</span><span id="line-916"></span><span>        </span><span class="annot"><span class="annottext">Context uni fun ann
-&gt; CekValEnv uni fun ann
-&gt; NTerm uni fun ann
-&gt; CekM uni fun s (NTerm uni fun ())
forall (uni :: * -&gt; *) fun ann s.
(ThrowableBuiltins uni fun, GivenCekReqs uni fun ann s) =&gt;
Context uni fun ann
-&gt; CekValEnv uni fun ann
-&gt; NTerm uni fun ann
-&gt; CekM uni fun s (NTerm uni fun ())
</span><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#enterComputeCek"><span class="hs-identifier hs-var">enterComputeCek</span></a></span><span> </span><span class="annot"><span class="annottext">Context uni fun ann
forall (uni :: * -&gt; *) fun ann. Context uni fun ann
</span><a href="UntypedPlutusCore.Evaluation.Machine.Cek.Internal.html#NoFrame"><span class="hs-identifier hs-var">NoFrame</span></a></span><span> </span><span class="annot"><span class="annottext">CekValEnv uni fun ann
forall e. RandomAccessList e =&gt; e
</span><span class="hs-identifier hs-var">Env.empty</span></span><span> </span><span class="annot"><span class="annottext">NTerm uni fun ann
</span><a href="#local-6989586621681867071"><span class="hs-identifier hs-var">term</span></a></span><span>
</span><span id="line-917"></span><span>
</span><span id="line-918"></span><span class="hs-comment">{- Note [Accumulators for terms]
At a couple of points in the CEK machine (notably building the arguments to a constructor value)
we need to compute a list of terms into values.

Our usual strategy is to make a frame which has an (implicit) &quot;hole&quot; for the value we are computing,
and which stores the other sub-parts of the term as terms or values depending on whether we've computed
them yet or not (see e.g. how applications work).

We want to do the same sort of strategy here, but it's a bit more complicated. We need a hole
&quot;in the middle&quot; of the list, with computed values on one side and yet-to-be-computed terms on the other.
We also very much want to avoid allocating as much as possible.

The basic structure that we end up with has three parts:
1. Use the list of sub-terms from the original term as our &quot;todo&quot; queue, a list is a good structure for this.
2. Use an accumulator type with fast snoc to accumulate the values as we compute them.
3. Convert the accumulator quickly into a final type that is fast to process/lookup in later.

(this process was at one point made explicit with an interface, but in the end we just inlined it all away)

We tried at least three variants of this:
1. List/MutableVector/Vector
2. List/Seq/Seq
3. List/DList/List

Suprisingly, option 3 was just as performant as the others, so we opted to go with it for simplicity.
But there may well be a faster version.
-}</span><span>
</span><span id="line-945"></span></pre></body></html>